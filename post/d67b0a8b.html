<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>核心功能开发：业务流程实现 | 蜡笔梦工厂</title><meta name="author" content="Lorinda"><meta name="copyright" content="Lorinda"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="聚焦苍穹外卖核心业务功能开发，详解用户管理、菜品管理、订单全流程及购物车交互逻辑，结合数据统计功能实现业务闭环，覆盖项目核心场景。">
<meta property="og:type" content="article">
<meta property="og:title" content="核心功能开发：业务流程实现">
<meta property="og:url" content="http://labi.com/post/d67b0a8b.html">
<meta property="og:site_name" content="蜡笔梦工厂">
<meta property="og:description" content="聚焦苍穹外卖核心业务功能开发，详解用户管理、菜品管理、订单全流程及购物车交互逻辑，结合数据统计功能实现业务闭环，覆盖项目核心场景。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112813.png">
<meta property="article:published_time" content="2025-08-30T03:02:00.000Z">
<meta property="article:modified_time" content="2025-09-02T12:16:04.998Z">
<meta property="article:author" content="Lorinda">
<meta property="article:tag" content="Spring Boot">
<meta property="article:tag" content="Vue">
<meta property="article:tag" content="MySQL">
<meta property="article:tag" content="业务逻辑">
<meta property="article:tag" content="三层架构">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112813.png"><link rel="shortcut icon" href="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2024_1123_155552.png"><link rel="canonical" href="http://labi.com/post/d67b0a8b.html"><link rel="preconnect" href="//cdnjs.cloudflare.com"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/node-snackbar/0.1.16/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.36/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!true && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?bf06f078fafddfd82b474ce179303666";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
btf.addGlobalFn('pjaxComplete', () => {
  _hmt.push(['_trackPageview',window.location.pathname])
}, 'baidu_analytics')
</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":{"enable":true},"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdnjs.cloudflare.com/ajax/libs/egjs-infinitegrid/4.12.0/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '核心功能开发：业务流程实现',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  isShuoshuo: false
}</script><link rel="stylesheet" href="/css/wave.css"><link rel="stylesheet" href="/css/readPercent.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_2264842_b004iy0kk2b.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="/css/loading.css"><link rel="stylesheet" href="/css/about.css"><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/l-lin/font-awesome-animation/dist/font-awesome-animation.min.css"  media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/ethan4116-blog/lib/css/plane_v2.css"><link rel="stylesheet" href="/css/universe.css"><link rel="stylesheet" href="/css/progress_bar.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/element-ui@2.15.6/packages/theme-chalk/lib/index.css"><span id="fps"></span><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css"/>
<style>#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags:before {content:"\A";
  white-space: pre;}#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags > .article-meta__separator{display:none}</style>
<link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-categories-card@1.0.0/lib/categorybar.css"><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.css" /><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><link rel="stylesheet" href="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2024_1123_160015.png"/><script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js"></script><div id="web_bg" style="background-image: url(https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/af380cb8a5ed3f047e66dbfe731f488.jpg);"></div><div id="an_music_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2024_1123_155535.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">29</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">112</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><i class="fa-fw icon-hexoa-homezhuyefangzijia"></i><svg class="icon fas fa-home" aria-hidden="true"><use xlink:href="#icon-hexoa-homezhuyefangzijia"></use></svg><span> 首页</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/comments/"><i class="fa-fw icon-hexoshouhuiban"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-hexoshouhuiban"></use></svg><span> 留言板</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover" href="javascript:void(0);"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-hexohuanjiaowenzhang"></use></svg><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-hexofenlei"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-hexobiaoqian"></use></svg><span> 标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-hexoguidang"></use></svg><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover" href="javascript:void(0);"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-hexoicon_liebiao"></use></svg><span> 娱乐</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-hexoyinle"></use></svg><span> 音乐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/gallery/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-hexotubiaozhizuomoban"></use></svg><span> 相册</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/link/"><i class="fa-fw icon-hexopengyou"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-hexopengyou"></use></svg><span> 友链</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/about/"><i class="fa-fw icon-hexowode"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-hexowode"></use></svg><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112813.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2024_1123_155552.png" alt="Logo"><span class="site-name">蜡笔梦工厂</span></a><a class="nav-page-title" href="/"><span class="site-name">核心功能开发：业务流程实现</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i></span></div><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><i class="fa-fw icon-hexoa-homezhuyefangzijia"></i><svg class="icon fas fa-home" aria-hidden="true"><use xlink:href="#icon-hexoa-homezhuyefangzijia"></use></svg><span> 首页</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/comments/"><i class="fa-fw icon-hexoshouhuiban"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-hexoshouhuiban"></use></svg><span> 留言板</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover" href="javascript:void(0);"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-hexohuanjiaowenzhang"></use></svg><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-hexofenlei"></use></svg><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-hexobiaoqian"></use></svg><span> 标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-hexoguidang"></use></svg><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover" href="javascript:void(0);"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-hexoicon_liebiao"></use></svg><span> 娱乐</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-hexoyinle"></use></svg><span> 音乐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/gallery/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-hexotubiaozhizuomoban"></use></svg><span> 相册</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/link/"><i class="fa-fw icon-hexopengyou"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-hexopengyou"></use></svg><span> 友链</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/about/"><i class="fa-fw icon-hexowode"></i><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-hexowode"></use></svg><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div><div id="randomPost"><a class="site-page social-icon search" href="javascript:;" onclick="randomPost()" title="随机访问一篇文章"><i class="fas fa-circle-notch fa-fw"></i></a></div></nav><div id="post-info"><h1 class="post-title">核心功能开发：业务流程实现</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-08-30T03:02:00.000Z" title="发表于 2025-08-30 11:02:00">2025-08-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-09-02T12:16:04.998Z" title="更新于 2025-09-02 20:16:04">2025-09-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96%E9%A1%B9%E7%9B%AE/">苍穹外卖项目</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">27.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>112分钟</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="twikoo_visitors"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div class="series-navigation"><h4 class="series-title">苍穹外卖项目开发指南</h4><ol class="series-list"><li class="series-item series-current"><a class="series-link" href="/post/25e0fe54.html"><span class="series-icon">•</span><span class="series-text">📋 项目概述：架构与需求分析</span></a><span class="series-current-tag">← 当前位置 🛸</span></li><li class="series-item"><a class="series-link" href="/post/b85186f.html"><span class="series-icon">•</span><span class="series-text">🛠️ 基础开发：环境搭建与核心配置</span></a></li><li class="series-item"><a class="series-link" href="/post/d67b0a8b.html"><span class="series-icon">•</span><span class="series-text">📊 核心功能开发：业务流程实现</span></a></li><li class="series-item"><a class="series-link" href="/post/ce4585c2.html"><span class="series-icon">•</span><span class="series-text">🖥️ 前端实现：界面与交互逻辑</span></a></li></ol></div><h1>十、购物车</h1>
<h2 id="10-1-添加购物车">10.1 添加购物车</h2>
<ul>
<li>菜品：
<ul>
<li>情况1：菜品没有设置口味数据，直接点击<code>+</code>将菜品添加到购物车当中。</li>
<li>情况2：菜品设置了口味数据，需要先点击<code>选择规格</code>来选择对应的口味，之后在点击<code>加入购物车</code>按钮，这样就可以把菜品数据添加到购物车当中。</li>
<li>如果这个商品已经被加入到了购物车，你还想添加相同的商品的时候，可以在购物车当中点击<code>+</code>，这样就可以快速的来添加一个相同的商品到购物车当中。</li>
</ul>
</li>
<li>套餐：直接点击<code>+</code>就可以把套餐添加到购物车当中。</li>
</ul>
<p>![[7d764d4ead847b325bffce6bf8c8361d.png]]</p>
<p>![[0a6c71bc8d48675c20e694d9dc668e8b.png]]</p>
<ul>
<li>添加购物车时，有可能添加菜品，也有可能添加套餐。故传入参数要么是菜品id，要么是套餐id。</li>
<li>菜品可能还有口味数据，所以还需要包含口味数据的参数。</li>
<li>对于某一次添加购物车来说，要么添加的就是菜品要么添加的就是套餐，<code>不可能你同时添加的又是菜品又是套餐</code>，这样的话是不合理的，所以这3个参数是非必须的。</li>
<li>但是对于某一次添加购物车这个业务来说，菜品id或者套餐id必须提交过来一个。</li>
</ul>
<p>![[0784f6008901dbfad5ac4e59f4fab87b.png]]</p>
<p>shopping_cart表作用：暂时存放所选商品的地方</p>
<p>选的什么商品</p>
<p>每个商品都买了几个</p>
<p>不同用户的购物车需要区分开</p>
<p>![[e9f30d4374a2e1d98058db256626a140.png]]</p>
<p>3个特殊的字段name、image、amount</p>
<p>特殊在这3个字段不是必须的，因为通过dish_id或者setmeal_id就可以查询出来相应的这个商品名称、图片路径、商品单价，这个时候这3个字段称作冗余字段。</p>
<p>冗余字段：反复出现的重复字段，eg：菜品表当中已经有了菜品的名称、图片路径、价格字段了，在当前表shopping_cart又出现了一遍，这就是冗余字段。</p>
<p>为什么要这样设计</p>
<p>因为通过设计这些冗余字段就可以提高我们的查询速度，eg：在展示购物车数据的时候需要展示商品的名称、 价格 、图片，如果没有这些冗余字段在查询数据的时候除了要查询我们这个购物车表，还需要联合去查询菜品表或者套餐表，相当于是2张表的连接查询，现在有了冗余字段就变成了单表查询，我们直接查询这个购物车表就可以了，所以查询速度就会快很多。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.user;</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user/shoppingCart&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;C端购物车相关接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShoppingCartController</span> &#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> ShoppingCartService shoppingCartService;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 添加购物车</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> shoppingCartDTO</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@PostMapping(&quot;/add&quot;)</span></span><br><span class="line">	<span class="meta">@ApiOperation(&quot;添加购物车&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> Result <span class="title function_">add</span><span class="params">(<span class="meta">@RequestBody</span> ShoppingCartDTO shoppingCartDTO)</span> &#123;</span><br><span class="line">		log.info(<span class="string">&quot;添加购物车，商品信息为：&#123;&#125;&quot;</span>, shoppingCartDTO);</span><br><span class="line">		shoppingCartService.addShoppingCart(shoppingCartDTO);</span><br><span class="line">		<span class="keyword">return</span> Result.success();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.sky.service.impl;</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShoppingCartServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">ShoppingCartService</span> &#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> ShoppingCartMapper shoppingCartMapper;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> DishMapper dishMapper;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> SetmealMapper setmealMapper;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 添加购物车</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> shoppingCartDTO</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addShoppingCart</span><span class="params">(ShoppingCartDTO shoppingCartDTO)</span> &#123;</span><br><span class="line">		<span class="comment">// 判断当前加入到购物车中的商品是否已经存在了</span></span><br><span class="line">		<span class="type">ShoppingCart</span> <span class="variable">shoppingCart</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShoppingCart</span>();</span><br><span class="line">		BeanUtils.copyProperties(shoppingCartDTO, shoppingCart);</span><br><span class="line">		<span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> BaseContext.getCurrentId();</span><br><span class="line">		shoppingCart.setUserId(userId);</span><br><span class="line"></span><br><span class="line">		List&lt;ShoppingCart&gt; list = shoppingCartMapper.list(shoppingCart);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 如果已经存在了，只需要将数量加一</span></span><br><span class="line">		<span class="keyword">if</span> (list != <span class="literal">null</span> &amp;&amp; !list.isEmpty()) &#123;</span><br><span class="line">			<span class="type">ShoppingCart</span> <span class="variable">cart</span> <span class="operator">=</span> list.get(<span class="number">0</span>); <span class="comment">// list中国只会有一条数据</span></span><br><span class="line">			cart.setNumber(cart.getNumber() + <span class="number">1</span>);</span><br><span class="line">			shoppingCartMapper.updateNumberById(cart);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 如果不存在，需要插入一条购物车数据</span></span><br><span class="line">		<span class="comment">// 判断本次添加到购物车的是菜品还是套餐</span></span><br><span class="line">		<span class="type">Long</span> <span class="variable">dishId</span> <span class="operator">=</span> shoppingCartDTO.getDishId();</span><br><span class="line">		<span class="keyword">if</span> (dishId != <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="comment">// 本次添加到购物车的是菜品</span></span><br><span class="line">			<span class="type">Dish</span> <span class="variable">dish</span> <span class="operator">=</span> dishMapper.getById(dishId);</span><br><span class="line">			shoppingCart.setName(dish.getName());</span><br><span class="line">			shoppingCart.setImage(dish.getImage());</span><br><span class="line">			shoppingCart.setAmount(dish.getPrice());</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// 本次添加到购物车的是套餐</span></span><br><span class="line">			<span class="type">Long</span> <span class="variable">setmealId</span> <span class="operator">=</span> shoppingCartDTO.getSetmealId();</span><br><span class="line">			<span class="type">Setmeal</span> <span class="variable">setmeal</span> <span class="operator">=</span> setmealMapper.getById(setmealId);</span><br><span class="line">			shoppingCart.setName(setmeal.getName());</span><br><span class="line">			shoppingCart.setImage(setmeal.getImage());</span><br><span class="line">			shoppingCart.setAmount(setmeal.getPrice());</span><br><span class="line">		&#125;</span><br><span class="line">		shoppingCart.setNumber(<span class="number">1</span>); <span class="comment">// 初始数量</span></span><br><span class="line">		shoppingCart.setCreateTime(LocalDateTime.now());</span><br><span class="line">		shoppingCartMapper.insert(shoppingCart);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.sky.mapper;</span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ShoppingCartMapper</span> &#123;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 动态条件查询</span></span><br><span class="line"><span class="comment">	 * 传入套餐id：select * from shopping_cart where user_id = ? and setmeal_id = ?</span></span><br><span class="line"><span class="comment">	 * 传入菜品id：select * from shopping_cart where user_id = ? and dish_id = ? and dish_flavor</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> shoppingCart</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	List&lt;ShoppingCart&gt; <span class="title function_">list</span><span class="params">(ShoppingCart shoppingCart)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 根据id修改商品数量</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> cart</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Update(&quot;update shopping_cart set number = #&#123;number&#125; where id = #&#123;id&#125;&quot;)</span></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">updateNumberById</span><span class="params">(ShoppingCart cart)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 插入购物车数据</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> shoppingCart</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Insert(&quot;insert into shopping_cart (name, user_id, dish_id, setmeal_id, dish_flavor, number, amount, image, create_time) &quot; +</span></span><br><span class="line"><span class="meta">			&quot; values (#&#123;name&#125;,#&#123;userId&#125;,#&#123;dishId&#125;,#&#123;setmealId&#125;,#&#123;dishFlavor&#125;,#&#123;number&#125;,#&#123;amount&#125;,#&#123;image&#125;,#&#123;createTime&#125;)&quot;)</span></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(ShoppingCart shoppingCart)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper PUBLIC <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="line">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span><br><span class="line">&lt;mapper namespace=<span class="string">&quot;com.sky.mapper.ShoppingCartMapper&quot;</span>&gt;</span><br><span class="line">    &lt;!--注意：动态sql里面，上面这个判断条件写的是实体类中的属性名，</span><br><span class="line">                下面的sql写的是表中的字段名。--&gt;</span><br><span class="line">    &lt;select id=<span class="string">&quot;list&quot;</span> resultType=<span class="string">&quot;com.sky.entity.ShoppingCart&quot;</span>&gt;</span><br><span class="line">        select * from shopping_cart</span><br><span class="line">        &lt;where&gt;</span><br><span class="line">            &lt;<span class="keyword">if</span> test=<span class="string">&quot;userId != null&quot;</span>&gt;</span><br><span class="line">                <span class="type">and</span> <span class="variable">user_id</span> <span class="operator">=</span> #&#123;userId&#125;</span><br><span class="line">            &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">            &lt;<span class="keyword">if</span> test=<span class="string">&quot;dishId != null&quot;</span>&gt;</span><br><span class="line">                <span class="type">and</span> <span class="variable">dish_id</span> <span class="operator">=</span> #&#123;dishId&#125;</span><br><span class="line">            &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">            &lt;<span class="keyword">if</span> test=<span class="string">&quot;setmealId != null&quot;</span>&gt;</span><br><span class="line">                <span class="type">and</span> <span class="variable">setmeal_id</span> <span class="operator">=</span> #&#123;setmealId&#125;</span><br><span class="line">            &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">            &lt;<span class="keyword">if</span> test=<span class="string">&quot;dishFlavor != null&quot;</span>&gt;</span><br><span class="line">                <span class="type">and</span> <span class="variable">dish_flavor</span> <span class="operator">=</span> #&#123;dishFlavor&#125;</span><br><span class="line">            &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">        &lt;/where&gt;</span><br><span class="line">        order by create_time desc</span><br><span class="line">    &lt;/select&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure>
<h2 id="10-2-查看购物车">10.2 <strong>查看购物车</strong></h2>
<p>这个地方不需要提交任何参数过去，因为我们当前查询的是用户的所有购物车数据。</p>
<p>问题：既然你要查询当前这个微信用户的购物车数据，那要不要把微信用户的id给传过去呢？<br>
答：不需要，因为我们每一次业务操作的时候呢，都会在请求头里面携带一个token过去，后端通过解析这个token就可以拿到这个用户id，所以这个user_id不传过去也是没有问题的。</p>
<blockquote>
<p>用户id通过ThreadLocal获得</p>
</blockquote>
<p>![[e7b93df2d4b6ad62c494520727d27d1c.png]]</p>
<p>![[a6568c351c828ac280be992d76351065.png]]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/list&quot;)</span></span><br><span class="line">	<span class="meta">@ApiOperation(&quot;查看购物车&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> Result&lt;List&lt;ShoppingCart&gt;&gt; <span class="title function_">list</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> Result.success(shoppingCartService.showShoppingCart());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> List&lt;ShoppingCart&gt; <span class="title function_">showShoppingCart</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="comment">// 查询某个用户的购物车数据，所以需要传递一个user_id</span></span><br><span class="line">		<span class="comment">// 获取当前这个微信用户的id</span></span><br><span class="line">		<span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> BaseContext.getCurrentId();</span><br><span class="line">		<span class="type">ShoppingCart</span> <span class="variable">shoppingCart</span> <span class="operator">=</span> ShoppingCart.builder()</span><br><span class="line">				.userId(userId)</span><br><span class="line">				.build();</span><br><span class="line">		List&lt;ShoppingCart&gt; list = shoppingCartMapper.list(shoppingCart);</span><br><span class="line">		<span class="keyword">return</span> list;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h2 id="10-3-清空购物车"><strong>10.3 清空购物车</strong></h2>
<p>![[0853782642cbaa34976a9527a2a7e818.png]]</p>
<p>和查看购物车类似，同样不需要提交参数，因为在后端实际上能够知道当前用户的id。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DeleteMapping(&quot;/clean&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;清空购物车商品&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;String&gt; <span class="title function_">clean</span><span class="params">()</span> &#123;</span><br><span class="line">	shoppingCartService.cleanShoppingCart();</span><br><span class="line">	<span class="keyword">return</span> Result.success();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cleanShoppingCart</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="comment">// 不能删除别人的数据只能删除自己的购物车数据，所以需要有user_id作为删除条件。</span></span><br><span class="line">	<span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> BaseContext.getCurrentId();</span><br><span class="line">	shoppingCartMapper.deleteByUserId(userId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Delete(&quot;delete from shopping_cart where user_id = #&#123;userId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">deleteByUserId</span><span class="params">(Long userId)</span>;</span><br></pre></td></tr></table></figure>
<h2 id="10-4-删除购物车中一个商品"><strong>10.4 删除购物车中一个商品</strong></h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/sub&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;删除购物车中的一个商品&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sub</span><span class="params">(<span class="meta">@RequestBody</span> ShoppingCartDTO shoppingCartDTO)</span> &#123;</span><br><span class="line">	shoppingCartService.subShoppingCart(shoppingCartDTO);</span><br><span class="line">	<span class="keyword">return</span> Result.success();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">subShoppingCart</span><span class="params">(ShoppingCartDTO shoppingCartDTO)</span> &#123;</span><br><span class="line">	<span class="type">ShoppingCart</span> <span class="variable">shoppingCart</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShoppingCart</span>();</span><br><span class="line">	BeanUtils.copyProperties(shoppingCartDTO, shoppingCart);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 查询当前用户的购物车数据</span></span><br><span class="line">	shoppingCart.setUserId(BaseContext.getCurrentId());</span><br><span class="line"></span><br><span class="line">	List&lt;ShoppingCart&gt; list = shoppingCartMapper.list(shoppingCart);</span><br><span class="line">	<span class="keyword">if</span> (list != <span class="literal">null</span> &amp;&amp; !list.isEmpty()) &#123;</span><br><span class="line">		<span class="comment">// 不为空说明有数据，list只有一条数据</span></span><br><span class="line">		shoppingCart = list.get(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">		<span class="type">Integer</span> <span class="variable">number</span> <span class="operator">=</span> shoppingCart.getNumber();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (number == <span class="number">1</span>) &#123;</span><br><span class="line">			<span class="comment">// 直接删除当前记录</span></span><br><span class="line">			shoppingCartMapper.deleteById(shoppingCart.getId());</span><br><span class="line">		&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// 份数-1</span></span><br><span class="line">			shoppingCart.setNumber(shoppingCart.getNumber() - <span class="number">1</span>);</span><br><span class="line">			shoppingCartMapper.updateNumberById(shoppingCart);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Delete(&quot;delete from shopping_cart where id = #&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">deleteById</span><span class="params">(Long id)</span>;</span><br></pre></td></tr></table></figure>
<h1>十一、用户下单</h1>
<h2 id="11-1-地址薄功能"><strong>11.1 地址薄功能</strong></h2>
<p>列表查询地址功能设为默认地址功能新增地址功能删除地址功能修改地址功能查询默认地址</p>
<p>都是单表操作</p>
<p>实现功能：</p>
<ul>
<li>查询地址列表</li>
<li>新增地址</li>
<li>修改地址</li>
<li>删除地址</li>
<li>设置默认地址</li>
<li>查询默认地址
<ul>
<li>通过当前这个产品原型是看不出来这个功能的，实际上在用户下单的时候在下单页面，会把当前这个用户的默认地址给他查出来，查出来之后显示在我们提交订单那个页面上。</li>
</ul>
</li>
</ul>
<p>接口：</p>
<ul>
<li>
<p>新增地址</p>
<p>![[4e6d8bf2f355229fb4269389d1fe598c.png]]</p>
</li>
<li>
<p>查询登录用户所有地址</p>
<p>![[4083563db9e0d1c3d7a65faa9375f224.png]]</p>
<p>前端不需要传递参数，因为这个用户的id每次发送请求都会携带token，之后在拦截器中解析token在绑定给ThreadLocal获得。</p>
</li>
<li>
<p>查询默认地址</p>
<p>同样不需要传递参数，因为我们是能够知道当前登录用户是谁的。</p>
<p>用户下单时，下单页面会查询默认地址</p>
<p>![[b5ac159e2a6d10fd9ac2ce1092831fbc.png]]</p>
</li>
<li>
<p>根据id修改地址</p>
<p>![[3833713a3c081ace6fe056d050d34423.png]]</p>
</li>
<li>
<p>根据id删除地址</p>
<p>![[9936bee56f8bf9e3abc5e7b3112f1a95.png]]</p>
</li>
<li>
<p>根据id查询地址</p>
<p>![[70550782181f1dcb4d7bba4832fcae8f.png]]</p>
</li>
<li>
<p>设置默认地址</p>
<p>本质是一个修改操作。</p>
<p><a target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/3d8dcf3d7a25c0f5044d46ebf2d8bafa.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/3d8dcf3d7a25c0f5044d46ebf2d8bafa.png" alt=""></a></p>
</li>
</ul>
<p>![[/image 103.png|image 103.png]]</p>
<p>注：是用户端</p>
<h2 id="11-2-用户下单功能"><strong>11.2 用户下单功能</strong></h2>
<p>![[2e1ebd4c8a637e6447909ce98275633b.png]]</p>
<ul>
<li>用户买的那些商品？每个商品数量是多少？
<ul>
<li>这些数据来源于用户的购物车，因为点餐的时候用户是先将商品加入到购物车当中然后才能提交订单，所以用户买的哪些商品以及商品的数量是由购物车中的数据决定的，当前用户的购物车数据可以查出来，因为前面已经实现了购物车的相关功能了。</li>
</ul>
</li>
<li>订单总金额是通过程序计算得出来的，总金额由2部分组成，一个是菜品的费用一个是其它的费用。
<ul>
<li>菜品费用很明显，我们点的有哪些菜品包括数量单价都有，直接乘以累加就可以计算出来。</li>
<li>其它费用：餐盒费和配送费，具体如何计算在当前这个系统当中就简单的处理了，餐盒费呢咱们就根据商品的数量来算，一个商品对应一个餐盒，每个餐盒一元。配送费固定按照6元去算。</li>
</ul>
</li>
<li>用户的名字，收货地址，手机号：通过之前导入的地址簿功能代码，用户的地址簿中就包括用户的名字 手机号 收货地址这些数据，用户在下单的时候就需要选择一个地址簿，这样就可以获取到这些数据了。</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/aad68f6039c7dc8eec085836a7a58394.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/aad68f6039c7dc8eec085836a7a58394.png" alt=""></a></p>
<p><a target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/f74eddbad296242041b1811e010801a6.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/f74eddbad296242041b1811e010801a6.png" alt=""></a></p>
<ul>
<li>POST请求：用户下单本质上是新增操作，也就是需要将下单后产生的订单数据把它插入到数据库当中。</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/c716c7c5d44f0543b24b083ac932c846.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/c716c7c5d44f0543b24b083ac932c846.png" alt=""></a></p>
<p>支付剩余时间倒计时，是由前端小程序按照秒递减，我们只需要给它返回一个下单的时间就可以了，小程序会根据这个下单时间去计算还剩多少时间并且进行倒计时的展示。</p>
<p>![[d001babb0a4ed52afef2e5353472ceb8.png]]</p>
<p>![[41739ca18629eb20dbe600754cf75bb5.png]]</p>
<p>![[41739ca18629eb20dbe600754cf75bb5 1.png]]</p>
<ul>
<li>
<p>用户下单的时候一般都会有一个订单表，把当前用户下单的数据存入到订单这张表里面去，但是只有一种订单表还不足以存储所有的数据，因为用户下单的时候可能点了很多商品，每个商品可能还有很多份，这个时候在我们这个订单表里面并不是很好存，具体我这个订单下面挂了几个商品呢？？？具体点了几份？？？<br>
对于这样的数据我们一般都会存储在另一张表里面，叫做订单明细表。</p>
</li>
<li>
<p>一对多关系，一个订单关联多个订单明细。</p>
</li>
<li>
<p>用户提交订单时，需要往订单表orders中插入一条记录，并且需要往order_detail中插入一条或多条记录</p>
</li>
</ul>
<p>![[e4acf2e91cb09e0022834690953fefa7.png]]</p>
<p>![[1fbde21f47a491168f9e39e1dbe8263c.png]]</p>
<p><code>shape = JsonFormat.Shape.STRING</code> 是 Jackson 框架中用于指定序列化和反序列化时数据类型的配置项。当你将 <code>shape</code> 设置为 <code>JsonFormat.Shape.STRING</code> 时，意味着你希望将对象转换为 JSON 字符串表示，而不是使用它的默认数据格式。</p>
<p>![[a03dcd898dd3c748270114cc62980318.png]]</p>
<p>接收前端信息使用OrderSubmintDTO,返回给前端数据使用OrderSubmitVO</p>
<ol>
<li>
<p>用户端创建Controller</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.user;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 订单</span></span><br><span class="line"><span class="comment"> * 管理端也需要创建OrderController对订单进行操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController(&quot;userOrderController&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user/order&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;C端-订单接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 用户下单</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> ordersSubmitDTO</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@PostMapping(&quot;/submit&quot;)</span></span><br><span class="line">	<span class="meta">@ApiOperation(&quot;用户下单&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> Result&lt;OrderSubmitVO&gt; <span class="title function_">submit</span><span class="params">(<span class="meta">@RequestBody</span> OrdersSubmitDTO ordersSubmitDTO)</span> &#123;</span><br><span class="line">		log.info(<span class="string">&quot;用户下单：&#123;&#125;&quot;</span>, ordersSubmitDTO);</span><br><span class="line">		<span class="type">OrderSubmitVO</span> <span class="variable">orderSubmitVO</span> <span class="operator">=</span> orderService.submitOrder(ordersSubmitDTO);</span><br><span class="line">		<span class="keyword">return</span> Result.success(orderSubmitVO);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>ServiceImpl</p>
<ol>
<li>
<p>处理各种原因的异常【地址薄为空、购物车商品为空】</p>
<p>绝大部分情况下不做这个判断处理问题也不大，因为如果是小程序提交过来的请求其实在小程序那端也做了判断（收货地址为空、购物车为空也是不能提交数据的），但是为了代码的健壮性建议在后端还是多次判断一下，因为用户如果并不是通过小程序提交的而是通过其它的一些方式 比如postman来提交这些请求，这个时候是没有任何校验的，此时后端在不校验那再处理的时候可能就会出现各种问题。</p>
</li>
<li>
<p>向订单表插入1条数据</p>
</li>
<li>
<p>根据返回的id，向订单明细表插入N条数据</p>
</li>
<li>
<p>然后清空购物车</p>
</li>
<li>
<p>然后清空当前用户的购物车数据</p>
</li>
</ol>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service.impl</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> OrderMapper orderMapper;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> OrderDetailMapper orderDetailMapper;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> ShoppingCartMapper shoppingCartMapper;<span class="comment">// 操作地址簿</span></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> AddressBookMapper addressBookMapper;<span class="comment">// 操作购物车</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 用户下单</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> ordersSubmitDTO</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> OrderSubmitVO <span class="title function_">submitOrder</span><span class="params">(OrdersSubmitDTO ordersSubmitDTO)</span> &#123;</span><br><span class="line">		<span class="comment">// 1. 异常情况的处理（收货地址为空、购物车为空）</span></span><br><span class="line">		<span class="comment">// 1.1 通过前端传递过来的地址簿id查询数据库是否有收货地址，如果查不到则抛出异常</span></span><br><span class="line">		<span class="type">AddressBook</span> <span class="variable">addressBook</span> <span class="operator">=</span> addressBookMapper.getById(ordersSubmitDTO.getAddressBookId());</span><br><span class="line">		<span class="keyword">if</span> (addressBook == <span class="literal">null</span>)</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AddressBookBusinessException</span>(MessageConstant.ADDRESS_BOOK_IS_NULL);</span><br><span class="line">		<span class="comment">// 1.2 查询当前用户的购物车数据（购物车为空也不能正常下单）</span></span><br><span class="line">		<span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> BaseContext.getCurrentId();</span><br><span class="line">		<span class="type">ShoppingCart</span> <span class="variable">shoppingCart</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShoppingCart</span>();</span><br><span class="line">		shoppingCart.setUserId(userId);</span><br><span class="line">		List&lt;ShoppingCart&gt; shoppingCartList = shoppingCartMapper.list(shoppingCart);</span><br><span class="line">		<span class="keyword">if</span> (shoppingCartList == <span class="literal">null</span> || shoppingCartList.isEmpty())</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ShoppingCartBusinessException</span>(MessageConstant.SHOPPING_CART_IS_NULL);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 2.向订单表插入1条数据（用户不管买多少个商品，只要它提交就是一个订单，对应一条订单数据）</span></span><br><span class="line">		<span class="comment">// 构造订单数据</span></span><br><span class="line">		<span class="type">Orders</span> <span class="variable">order</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Orders</span>();</span><br><span class="line">		BeanUtils.copyProperties(ordersSubmitDTO, order);</span><br><span class="line">		<span class="comment">// 通过地址簿设置收货人名字，收货地址，手机号</span></span><br><span class="line">		order.setConsignee(addressBook.getConsignee()); <span class="comment">// 收货人</span></span><br><span class="line">		order.setAddress(addressBook.getDetail());</span><br><span class="line">		order.setPhone(addressBook.getPhone());</span><br><span class="line">		<span class="comment">// 要求是字符串类型，需要转化</span></span><br><span class="line">		order.setNumber(String.valueOf(System.currentTimeMillis())); <span class="comment">// 订单号，使用当前系统时间的时间戳生成</span></span><br><span class="line">		order.setUserId(userId); <span class="comment">// 当前订单属于的用户</span></span><br><span class="line">		order.setStatus(Orders.PENDING_PAYMENT); <span class="comment">// 订单状态：此时是待付款</span></span><br><span class="line">		order.setPayStatus(Orders.UN_PAID);<span class="comment">// 支付状态，用户刚完成下单所以是未支付状态</span></span><br><span class="line">		order.setOrderTime(LocalDateTime.now());<span class="comment">// 下单时间</span></span><br><span class="line"></span><br><span class="line">		orderMapper.insert(order);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 3.向订单明细表插入n条数据（可能是一条也可能是多条）</span></span><br><span class="line">		ArrayList&lt;OrderDetail&gt; orderDetailList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">		<span class="keyword">for</span> (ShoppingCart cart : shoppingCartList) &#123;</span><br><span class="line">			<span class="comment">// 一条购物车数据对应封装一个订单明细对象</span></span><br><span class="line">			<span class="type">OrderDetail</span> <span class="variable">orderDetail</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderDetail</span>();</span><br><span class="line">			BeanUtils.copyProperties(cart, orderDetail);</span><br><span class="line">			<span class="comment">// 通过动态sql设置当前订单明细表的订单id</span></span><br><span class="line">			orderDetail.setOrderId(order.getId());</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 方式一：单条数据插入，遍历一次插入一次</span></span><br><span class="line">			<span class="comment">// 方式二：批量插入，效率更高，所以这里把获得的订单明细数据给它放在list集合里面，然后一次性的批量插入。</span></span><br><span class="line">			orderDetailList.add(orderDetail);</span><br><span class="line">		&#125;</span><br><span class="line">		orderDetailMapper.insertBatch(orderDetailList); <span class="comment">// 方式二</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// 4.清理当前用户的购物车中的数据（用户下单成功后，用户的这些购物车中的数据就不需要了）</span></span><br><span class="line">		shoppingCartMapper.deleteByUserId(userId);<span class="comment">// 前面购物车模块已实现</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// 5.封装VO返回结果</span></span><br><span class="line">		<span class="type">OrderSubmitVO</span> <span class="variable">orderSubmitVO</span> <span class="operator">=</span> OrderSubmitVO.builder()</span><br><span class="line">				.id(order.getId())</span><br><span class="line">				.orderAmount(order.getAmount())</span><br><span class="line">				.orderNumber(order.getNumber())</span><br><span class="line">				.orderTime(order.getOrderTime())</span><br><span class="line">				.build();</span><br><span class="line">		<span class="keyword">return</span> orderSubmitVO;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>创建Mapper以及映射文件</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper PUBLIC <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="line">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span><br><span class="line">&lt;mapper namespace=<span class="string">&quot;com.sky.mapper.OrderMapper&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;insert id=<span class="string">&quot;insert&quot;</span> parameterType=<span class="string">&quot;orders&quot;</span> useGeneratedKeys=<span class="string">&quot;true&quot;</span> keyProperty=<span class="string">&quot;id&quot;</span>&gt;</span><br><span class="line">        insert into <span class="title function_">orders</span></span><br><span class="line">        <span class="params">(number, status, user_id, address_book_id, order_time, checkout_time, pay_method, pay_status, amount, remark,</span></span><br><span class="line"><span class="params">         phone, address, consignee, estimated_delivery_time, delivery_status, pack_amount, tableware_number,</span></span><br><span class="line"><span class="params">         tableware_status)</span></span><br><span class="line">        values (#&#123;number&#125;, #&#123;status&#125;, #&#123;userId&#125;, #&#123;addressBookId&#125;, #&#123;orderTime&#125;, #&#123;checkoutTime&#125;, #&#123;payMethod&#125;,</span><br><span class="line">                #&#123;payStatus&#125;, #&#123;amount&#125;, #&#123;remark&#125;, #&#123;phone&#125;, #&#123;address&#125;, #&#123;consignee&#125;,</span><br><span class="line">                #&#123;estimatedDeliveryTime&#125;, #&#123;deliveryStatus&#125;, #&#123;packAmount&#125;, #&#123;tablewareNumber&#125;, #&#123;tablewareStatus&#125;)</span><br><span class="line">    &lt;/insert&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br><span class="line"></span><br><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper PUBLIC <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span><br><span class="line">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span><br><span class="line">&lt;mapper namespace=<span class="string">&quot;com.sky.mapper.OrderDetailMapper&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;insert id=<span class="string">&quot;insertBatch&quot;</span> parameterType=<span class="string">&quot;list&quot;</span>&gt;</span><br><span class="line">        insert into <span class="title function_">order_detail</span></span><br><span class="line">        <span class="params">(name, order_id, dish_id, setmeal_id, dish_flavor, number, amount, image)</span></span><br><span class="line">        values</span><br><span class="line">            &lt;foreach collection=<span class="string">&quot;orderDetailList&quot;</span> item=<span class="string">&quot;od&quot;</span> separator=<span class="string">&quot;,&quot;</span>&gt;</span><br><span class="line">                (#&#123;od.name&#125;,#&#123;od.orderId&#125;,#&#123;od.dishId&#125;,#&#123;od.setmealId&#125;,#&#123;od.dishFlavor&#125;,</span><br><span class="line">                #&#123;od.number&#125;,#&#123;od.amount&#125;,#&#123;od.image&#125;)</span><br><span class="line">            &lt;/foreach&gt;</span><br><span class="line">    &lt;/insert&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1>十二、订单支付</h1>
<p>要实现微信支付就需要注册微信支付的一个<strong>商户号</strong>，这个商户号是<strong>必须要有一家企业并且有正规的营业执照</strong>。只有具备了这些资质之后，才可以去注册商户号，才能开通支付权限。</p>
<p>这里使用传智注册的商户号来完成微信支付，以后进入到企业开发如果需要实现微信支付功能，只需要替换一下商户号就可以了。</p>
<p>由于这部分代码是固定的，而且个人账号无法使用微信支付，所以这部分直接导入就好</p>
<h2 id="12-1-微信支付介绍">12.1 微信支付介绍</h2>
<p><strong>微信支付产品：多种支付的形式</strong></p>
<ul>
<li>
<p>JSAPI支付：在h5应用中比如h5页面要进行微信支付，这样的话就可以调起微信支付。</p>
</li>
<li>
<p>Native支付：二维码支付，微信扫一扫商家提供的二维码进行支付。</p>
<p><a target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/6ac6080fb12f58f6e333cf6eceb2e009.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/6ac6080fb12f58f6e333cf6eceb2e009.png" alt=""></a></p>
<p>本项目选择<strong>小程序支付</strong></p>
<p>参考：<code>https://pay.weixin.qq.com/static/product/product_index.shtml</code></p>
<p>此网站是微信官方给我们提供的叫作<code>微信支付商户平台</code>，要实现微信支付功能就需要到这个平台上面来阅读，它给我们提供的一些文档。</p>
</li>
</ul>
<p><strong>微信支付流程</strong></p>
<p>![[96054101c4bc339c68fd391a6f37e067.png]]</p>
<p><strong>微信支付时序图</strong></p>
<p>![[62ce4ed1ba9b4b27ba54b8038b808997.png]]</p>
<p>具体支付流程：</p>
<ol>
<li><strong>微信用户下单</strong>：1、2
<ul>
<li>用户在微信小程序中选中商品并下单。</li>
<li>小程序向商户系统发送请求，调用后端服务的下单接口。</li>
</ul>
</li>
<li><strong>商户系统生成订单</strong>：3
<ul>
<li>商户系统处理用户下单请求，生成订单数据（包括订单 ID、金额、时间等），并返回给小程序。</li>
</ul>
</li>
<li><strong>微信小程序请求支付</strong>：4
<ul>
<li>小程序根据返回的订单数据，发起支付请求，向商户系统发送支付请求。</li>
</ul>
</li>
<li><strong>商户系统调用微信支付接口</strong>：5
<ul>
<li>商户系统接收到小程序发起的支付请求，调用微信后台提供的“下单接口”，提交必要的参数，如：
<ul>
<li><strong>mchid</strong>：商户号</li>
<li><strong>out_trade_no</strong>：订单号（当前项目系统中使用的是时间戳作为订单号）</li>
<li><strong>appid</strong>：小程序应用ID</li>
<li><strong>description</strong>：商品描述</li>
<li><strong>notify_url</strong>：回调地址。当用户通过微信支付付款成功之后，这个微信后台就会调用这个地址来通知我们的程序，所以这个地址一般是商户系统的访问地址。</li>
<li><strong>amount</strong>：支付金额。total（具体金额数字），currency（币种：人民币，美元等等）</li>
<li><strong>payer</strong>：付款用户的 <code>openid</code> （在微信登录的时候就获取到了微信用户的openid）</li>
</ul>
</li>
</ul>
</li>
<li><strong>微信后台生成预支付交易单</strong>：6
<ul>
<li>一旦调用完这个接口并没有完成付款，调用这个接口其实是微信后台根据商户系统提交的参数，生成一个<strong>预支付交易单</strong>，<strong>并没有真的完成支付</strong>而是提前通知微信希望有那么一份交易，你先记录一下，一会微信用户会通过小程序来完成这份交易，所以叫做预支付交易单。调用完此接口后会返回一个<strong>预支付交易标识</strong>（prepay_id）给商户系统。</li>
</ul>
</li>
<li><strong>商户系统处理并签名</strong>：7
<ul>
<li>商户系统对返回的预支付标识进行<strong>数据处理和签名</strong>，签名的目的就是为了安全，因为数据在网络上传输有可能会被别人截获，所以会对数据进行签名保证我们这个数据的安全。</li>
</ul>
</li>
<li><strong>商户系统响应小程序</strong>：8
<ul>
<li>商户系统将处理后的支付数据（包括签名后的数据）返回给小程序。</li>
</ul>
</li>
<li><strong>微信小程序调起支付</strong>：9、10
<ul>
<li>这些经过处理后的参数返回给前端小程序之后，用户就需要来确认支付，前端程序会调用<code>wx.requestPayment</code>方法（这是小程序端的一个方法），执行这个方法的时候需要很多参数，这些参数来自于<strong>调用预支付交易单接口</strong>时返回给前端小程序封装后的参数（第7步），，然后这些小程序直接使用这些参数。一旦调用这个方法手机上就可以显示以下页面效果：其实就是调起了微信支付。</li>
<li>用户点击页面上的确认支付显示输入密码，密码输入完成点击确定之后就会发送一个请求，请求这个微信后台， 微信后台就会进行<strong>真正的付款操作</strong>，付款成功之后就会给这个小程序返回支付结果，在小程序这端就会显示支付结果，到这里小程序实际上就完成了付款，把钱打到商户这个银行卡里面去了。</li>
</ul>
</li>
<li><strong>支付成功，微信回调通知商户系统</strong>：11、12
<ul>
<li>到这个地方实际上还没有完，因为刚才是通过微信小程序支付， 直接给我们这个微信后台来进行交互完成付款，<strong>但是这个过程后台商户系统并不知道</strong>，刚才你这个微信用户有没有付款，是付款成功了还是失败了这个后台系统根本就不知道。</li>
<li>用户支付成功后，微信后台会调用商户系统的 <code>notify_url</code> 回调接口，通知支付结果。</li>
</ul>
</li>
<li><strong>商户系统确认支付</strong>：13、14
<ul>
<li>商户系统接收支付成功通知，更新订单状态，完成整个支付流程。</li>
</ul>
</li>
</ol>
<p>总体流程：</p>
<ol>
<li>用户下单：对应1、2、3步</li>
<li>调用预支付接口生成预支付交易单：对应4、5、6、7、8</li>
<li>小程序端和后台服务进行交互，调起微信支付真正完成了付款：对应9、10、11、12</li>
<li>支付结果的推送：微信后台会调用商户系统的某一个地址，从而把结果通知给商户系统，然后商户系统去更新这个订单的支付状态。对应13、14。</li>
</ol>
<p><strong>微信支付相关接口：</strong></p>
<ul>
<li>
<p><strong><a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/docs/merchant/apis/jsapi-payment/direct-jsons/jsapi-prepay.html">JSAPI下单</a></strong>：商户系统调用该接口在微信支付服务后台生成<code>预支付交易单</code>(对应时序图的<code>第5步</code>)</p>
<p><a target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/805b2c49a2b69f4fbf59dbbaa46ae6a8.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/805b2c49a2b69f4fbf59dbbaa46ae6a8.png" alt=""></a></p>
<ul>
<li>url是微信官方给我们提供的一个接口地址。</li>
<li>mchid：商户号</li>
<li>返回结果为预支付交易标识prepay_id：实际上就是一个字符串</li>
</ul>
<p>注意：调用完这个接口并没有完成真正了付款，只是生成一个预支付交易单并没有真的完成支付，相当于提前通知微信希望有这份交易，你先记录一下，之后微信用户会通过小程序来完成这份交易，所以叫做预支付交易单，相当于先在微信这边先进行一个备案。</p>
</li>
<li>
<p><strong><a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/docs/merchant/apis/mini-program-payment/mini-transfer-payment.html">微信小程序调起支付（页面中的js方法）</a></strong>：通过JSAPI下单接口获取到发起支付的必要参数prepay_id，然后使用微信支付提供的小程序方法调起小程序支付(对应时序图的<code>第10步</code>)</p>
<p><a target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/51500f792adfa5b548600d3c9ef4295e.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/51500f792adfa5b548600d3c9ef4295e.png" alt=""></a></p>
<ul>
<li>真正完成了付款。</li>
<li>这些参数都是后端计算好返回给我们小程序，小程序直接使用这些参数即可。</li>
</ul>
</li>
</ul>
<h2 id="12-2-微信支付准备功能">12.2 微信支付准备功能</h2>
<h3 id="12-2-1-获得微信给的两个文件">12.2.1 获得微信给的两个文件</h3>
<h3 id="如何保证数据安全？"><strong>如何保证数据安全？</strong></h3>
<p>完成微信支付有两个关键的步骤：</p>
<p><strong>第一个</strong>就是需要在商户系统当中调用微信后台的一个下单接口，就是<strong>生成预支付交易单</strong>。5</p>
<p><strong>第二个</strong>就是支付成功之后微信后台会给<strong>推送消息</strong>。13</p>
<p>这两个接口数据的安全性，要求其实是非常高的。</p>
<p><strong>解决</strong>：微信提供的方式就是对数据进行加密、解密、签名多种方式。要完成数据加密解密，需要提前准备相应的一些文件，其实就是一些证书。</p>
<p><strong>获取微信支付平台证书、商户私钥文件：</strong></p>
<p><a target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/de39ff98204adc310fb898487be30a7c.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/de39ff98204adc310fb898487be30a7c.png" alt=""></a></p>
<p>注意：</p>
<ul>
<li>这2个文件是从微信的商户平台下载下来的，在后续程序开发过程中，就会使用到这两个文件，具体如何用 代码怎么写 后面在说，现在提前把这两个文件准备好。</li>
<li>前提：必须要有一家企业并且有正规的营业执照</li>
</ul>
<h3 id="12-2-2-内网穿透">12.2.2 内网穿透</h3>
<p>如何调用到商户系统（cpolar）</p>
<p>微信后台会调用到商户系统给推送支付的结果，在这里我们就会遇到一个问题，就是微信后台怎么就能调用到我们这个商户系统呢？因为这个调用过程，其实本质上也是一个HTTP请求。</p>
<p>目前，商户系统它的ip地址就是当前自己电脑的ip地址，只是一个局域网内的ip地址，微信后台无法调用到。</p>
<p>解决：内网穿透。通过cpolar软件可以获得一个临时域名，而这个临时域名是一个公网ip，这样，微信后台就可以请求到商户系统了。</p>
<p>注意：当前开发阶段电脑大部分都在局域网之内并没有公网ip，所以需要这种方式获得一个临时域名，但是最终项目上线之后一般都会有公网ip，我们直接使用公网ip即可。</p>
<p>解决个人测试的时候，微信无法访问我们本机IP的问题</p>
<p>1). 安装cpolar：<a target="_blank" rel="noopener" href="https://www.cpolar.com/">cpolar - 安全的内网穿透工具</a></p>
<p><strong>2). cpolar指定authtoken</strong></p>
<p>复制authtoken：</p>
<p>OGQ4ZmNmNDUtOTg1NC00MTEyLTk5YzMtNmM2NTg3ODI0OGM3</p>
<p>执行命令：注意<code>./cpolar authtoken ...</code>是linux下的命令。</p>
<p>![[bbb0dd47edafc3e70c6829a497f1d4e9.png]]</p>
<ul>
<li>回车后会在c盘生成一个文件，即内网穿透工具的一个配置文件。（只整一次就行）</li>
</ul>
<p>![[/image 1 44.png|image 1 44.png]]</p>
<p><strong>3). 获取临时域名</strong></p>
<p>在你安装的cpolar目录下执行</p>
<p>为什么设置8080：因为后端服务的端口号就是8080</p>
<p>执行命令：<code>cpolar.exe http 8080</code></p>
<p><a target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/cc93e283cd82ea08bfe578656d38050a.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/cc93e283cd82ea08bfe578656d38050a.png" alt=""></a></p>
<p>获取域名：</p>
<p><a target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/53fa92b4807f93b2d1b677be7798ccad.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/53fa92b4807f93b2d1b677be7798ccad.png" alt=""></a></p>
<p><strong>4). 验证临时域名有效性</strong></p>
<p><strong>之前访问接口文档</strong><a target="_blank" rel="noopener" href="http://localhost:8080/doc.html">http://localhost:8080/doc.html</a></p>
<p>现在可以使用临时域名访问：<code>域名/doc.html</code> <a target="_blank" rel="noopener" href="http://48ce14a4.r25.cpolar.top/doc.html">http://48ce14a4.r25.cpolar.top/doc.html</a></p>
<p>![[b7075f5c656fc0d4c974f2d610b4beaf.png]]</p>
<p>证明临时域名生效。</p>
<h2 id="12-3-导入微信支付代码"><strong>12.3 导入微信支付代码</strong></h2>
<p><strong>配置文件中添加微信支付配置</strong></p>
<blockquote>
<p>说明：yaml中能有这些属性，是因为定义了配置类 【里面的都是别人的数据，需要改成自己的】</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">sky:</span><br><span class="line">    wechat:</span><br><span class="line">    appid: wxb2fc7d534365dfc5</span><br><span class="line">    secret: d117b81fc08e17a0fcee03cb407d70c6</span><br><span class="line">    mchid: <span class="number">1561414331</span> \#传智播客申请的商户号</span><br><span class="line">    mchSerialNo: OGQ4ZmNmNDUtOTg1NC00MTEyLTk5YzMtNmM2NTg3ODI0OGM3 \#证书的序列号</span><br><span class="line">    privateKeyFilePath: D:\apiclient_key.pem \#私钥文件（不是企业 没有）</span><br><span class="line">    apiV3Key: CZBK51236435wxpay435434323FFDuv3 \#解密的秘钥（商户平台设置 一般公司提供好不用自己手动配置）</span><br><span class="line">    weChatPayCertFilePath: D:\wechatpay_166D96F876F45C7D07CE98952A96EC980368ACFC.pem \#平台证书文件</span><br><span class="line">    notifyUrl: https:<span class="comment">//www.weixin.qq.com/wxpay/pay.php \#支付成功的回调（域名地址+controller的访问路径）</span></span><br><span class="line">    refundNotifyUrl: https:<span class="comment">//www.weixin.qq.com/wxpay/pay.php \#退款成功的回调</span></span><br><span class="line"></span><br><span class="line">    sky:</span><br><span class="line">  wechat:</span><br><span class="line">    appid: $&#123;sky.wechat.appid&#125;</span><br><span class="line">    secret: $&#123;sky.wechat.secret&#125;</span><br><span class="line">    mchid : $&#123;sky.wechat.mchid&#125;</span><br><span class="line">    mchSerialNo: $&#123;sky.wechat.mchSerialNo&#125;</span><br><span class="line">    privateKeyFilePath: $&#123;sky.wechat.privateKeyFilePath&#125;</span><br><span class="line">    apiV3Key: $&#123;sky.wechat.apiV3Key&#125;</span><br><span class="line">    weChatPayCertFilePath: $&#123;sky.wechat.weChatPayCertFilePath&#125;</span><br><span class="line">    notifyUrl: $&#123;sky.wechat.notifyUrl&#125;</span><br><span class="line">    refundNotifyUrl: $&#123;sky.wechat.refundNotifyUrl&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>代码</p>
<p>WeChatProperties.java：读取配置(已定义)</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;sky.wechat&quot;)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WeChatProperties</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String appid; <span class="comment">//小程序的appid</span></span><br><span class="line">    <span class="keyword">private</span> String secret; <span class="comment">//小程序的秘钥</span></span><br><span class="line">    <span class="keyword">private</span> String mchid; <span class="comment">//商户号</span></span><br><span class="line">    <span class="keyword">private</span> String mchSerialNo; <span class="comment">//商户API证书的证书序列号</span></span><br><span class="line">    <span class="keyword">private</span> String privateKeyFilePath; <span class="comment">//商户私钥文件</span></span><br><span class="line">    <span class="keyword">private</span> String apiV3Key; <span class="comment">//证书解密的密钥</span></span><br><span class="line">    <span class="keyword">private</span> String weChatPayCertFilePath; <span class="comment">//平台证书</span></span><br><span class="line">    <span class="keyword">private</span> String notifyUrl; <span class="comment">//支付成功的回调地址</span></span><br><span class="line">    <span class="keyword">private</span> String refundNotifyUrl; <span class="comment">//退款成功的回调地址</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrdersPaymentDTO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="comment">//订单号</span></span><br><span class="line">    <span class="keyword">private</span> String orderNumber;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//付款方式</span></span><br><span class="line">    <span class="keyword">private</span> Integer payMethod;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>PayNotifyController.java：支付成功后微信后台会回调这个controller</strong></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.notify;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.druid.support.json.JSONUtils;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.sky.annotation.IgnoreToken;</span><br><span class="line"><span class="keyword">import</span> com.sky.properties.WeChatProperties;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.OrderService;</span><br><span class="line"><span class="keyword">import</span> com.wechat.pay.contrib.apache.httpclient.util.AesUtil;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.entity.ContentType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 支付回调相关接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/notify&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayNotifyController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WeChatProperties weChatProperties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 支付成功回调</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/paySuccess&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">paySuccessNotify</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//读取数据</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> readData(request);</span><br><span class="line">        log.info(<span class="string">&quot;支付成功回调：&#123;&#125;&quot;</span>, body);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//数据解密</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">plainText</span> <span class="operator">=</span> decryptData(body);</span><br><span class="line">        log.info(<span class="string">&quot;解密后的文本：&#123;&#125;&quot;</span>, plainText);</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSON.parseObject(plainText);</span><br><span class="line">        <span class="type">String</span> <span class="variable">outTradeNo</span> <span class="operator">=</span> jsonObject.getString(<span class="string">&quot;out_trade_no&quot;</span>);<span class="comment">//商户平台订单号</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">transactionId</span> <span class="operator">=</span> jsonObject.getString(<span class="string">&quot;transaction_id&quot;</span>);<span class="comment">//微信支付交易号</span></span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;商户平台订单号：&#123;&#125;&quot;</span>, outTradeNo);</span><br><span class="line">        log.info(<span class="string">&quot;微信支付交易号：&#123;&#125;&quot;</span>, transactionId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//业务处理，修改订单状态、来单提醒</span></span><br><span class="line">        orderService.paySuccess(outTradeNo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//给微信响应</span></span><br><span class="line">        responseToWeixin(response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 读取数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">readData</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> request.getReader();</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">line</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (result.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                result.append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            result.append(line);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据解密</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> body</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">decryptData</span><span class="params">(String body)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">resultObject</span> <span class="operator">=</span> JSON.parseObject(body);</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">resource</span> <span class="operator">=</span> resultObject.getJSONObject(<span class="string">&quot;resource&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">ciphertext</span> <span class="operator">=</span> resource.getString(<span class="string">&quot;ciphertext&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">nonce</span> <span class="operator">=</span> resource.getString(<span class="string">&quot;nonce&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">associatedData</span> <span class="operator">=</span> resource.getString(<span class="string">&quot;associated_data&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">AesUtil</span> <span class="variable">aesUtil</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AesUtil</span>(weChatProperties.getApiV3Key().getBytes(StandardCharsets.UTF_8));</span><br><span class="line">        <span class="comment">//密文解密</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">plainText</span> <span class="operator">=</span> aesUtil.decryptToString(associatedData.getBytes(StandardCharsets.UTF_8),</span><br><span class="line">                nonce.getBytes(StandardCharsets.UTF_8),</span><br><span class="line">                ciphertext);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> plainText;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 给微信响应</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">responseToWeixin</span><span class="params">(HttpServletResponse response)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        response.setStatus(<span class="number">200</span>);</span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;code&quot;</span>, <span class="string">&quot;SUCCESS&quot;</span>);</span><br><span class="line">        map.put(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;SUCCESS&quot;</span>);</span><br><span class="line">        response.setHeader(<span class="string">&quot;Content-type&quot;</span>, ContentType.APPLICATION_JSON.toString());</span><br><span class="line">        response.getOutputStream().write(JSONUtils.toJSONString(map).getBytes(StandardCharsets.UTF_8));</span><br><span class="line">        response.flushBuffer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>在OrderController.java中添加payment方法</strong></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 订单支付（生成预支付交易单）</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ordersPaymentDTO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PutMapping(&quot;/payment&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;订单支付&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderPaymentVO&gt; <span class="title function_">payment</span><span class="params">(<span class="meta">@RequestBody</span> OrdersPaymentDTO ordersPaymentDTO)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    log.info(<span class="string">&quot;订单支付：&#123;&#125;&quot;</span>, ordersPaymentDTO);</span><br><span class="line">    <span class="comment">//对应第4步</span></span><br><span class="line">    <span class="type">OrderPaymentVO</span> <span class="variable">orderPaymentVO</span> <span class="operator">=</span> orderService.payment(ordersPaymentDTO);</span><br><span class="line">    log.info(<span class="string">&quot;生成预支付交易单：&#123;&#125;&quot;</span>, orderPaymentVO);</span><br><span class="line">    <span class="comment">//对应第8步</span></span><br><span class="line">    <span class="keyword">return</span> Result.success(orderPaymentVO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>使用到的微信支付工具类</strong></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.sky.properties.WeChatProperties;</span><br><span class="line"><span class="keyword">import</span> com.wechat.pay.contrib.apache.httpclient.WechatPayHttpClientBuilder;</span><br><span class="line"><span class="keyword">import</span> com.wechat.pay.contrib.apache.httpclient.util.PemUtil;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.RandomStringUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpHeaders;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.methods.CloseableHttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.methods.HttpGet;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.methods.HttpPost;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.entity.ContentType;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.entity.StringEntity;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.client.CloseableHttpClient;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.util.EntityUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="keyword">import</span> java.security.PrivateKey;</span><br><span class="line"><span class="keyword">import</span> java.security.Signature;</span><br><span class="line"><span class="keyword">import</span> java.security.cert.X509Certificate;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 微信支付工具类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WeChatPayUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//微信支付下单接口地址（生成预支付交易单）</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">JSAPI</span> <span class="operator">=</span> <span class="string">&quot;https://api.mch.weixin.qq.com/v3/pay/transactions/jsapi&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//申请退款接口地址</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REFUNDS</span> <span class="operator">=</span> <span class="string">&quot;https://api.mch.weixin.qq.com/v3/refund/domestic/refunds&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WeChatProperties weChatProperties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取调用微信接口的客户端工具对象</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> CloseableHttpClient <span class="title function_">getClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">PrivateKey</span> <span class="variable">merchantPrivateKey</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//merchantPrivateKey商户API私钥，如何加载商户API私钥请看常见问题</span></span><br><span class="line">            merchantPrivateKey = PemUtil.loadPrivateKey(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(weChatProperties.getPrivateKeyFilePath())));</span><br><span class="line">            <span class="comment">//加载平台证书文件</span></span><br><span class="line">            <span class="type">X509Certificate</span> <span class="variable">x509Certificate</span> <span class="operator">=</span> PemUtil.loadCertificate(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(weChatProperties.getWeChatPayCertFilePath())));</span><br><span class="line">            <span class="comment">//wechatPayCertificates微信支付平台证书列表。你也可以使用后面章节提到的“定时更新平台证书功能”，而不需要关心平台证书的来龙去脉</span></span><br><span class="line">            List&lt;X509Certificate&gt; wechatPayCertificates = Arrays.asList(x509Certificate);</span><br><span class="line"></span><br><span class="line">            <span class="type">WechatPayHttpClientBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> WechatPayHttpClientBuilder.create()</span><br><span class="line">                    .withMerchant(weChatProperties.getMchid(), weChatProperties.getMchSerialNo(), merchantPrivateKey)</span><br><span class="line">                    .withWechatPay(wechatPayCertificates);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 通过WechatPayHttpClientBuilder构造的HttpClient，会自动的处理签名和验签</span></span><br><span class="line">            <span class="type">CloseableHttpClient</span> <span class="variable">httpClient</span> <span class="operator">=</span> builder.build();</span><br><span class="line">            <span class="keyword">return</span> httpClient;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送post方式请求：底层使用的还是httpClient发起的请求</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> body</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">post</span><span class="params">(String url, String body)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//构造httpClient对象：调用上面的方法生成的对象</span></span><br><span class="line">        <span class="type">CloseableHttpClient</span> <span class="variable">httpClient</span> <span class="operator">=</span> getClient();</span><br><span class="line"></span><br><span class="line">        <span class="type">HttpPost</span> <span class="variable">httpPost</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpPost</span>(url);</span><br><span class="line">        <span class="comment">//设置的请求头</span></span><br><span class="line">        httpPost.addHeader(HttpHeaders.ACCEPT, ContentType.APPLICATION_JSON.toString());</span><br><span class="line">        httpPost.addHeader(HttpHeaders.CONTENT_TYPE, ContentType.APPLICATION_JSON.toString());</span><br><span class="line">        httpPost.addHeader(<span class="string">&quot;Wechatpay-Serial&quot;</span>, weChatProperties.getMchSerialNo());</span><br><span class="line">        httpPost.setEntity(<span class="keyword">new</span> <span class="title class_">StringEntity</span>(body, <span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//发起请求</span></span><br><span class="line">        <span class="type">CloseableHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> httpClient.execute(httpPost);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">bodyAsString</span> <span class="operator">=</span> EntityUtils.toString(response.getEntity());</span><br><span class="line">            <span class="keyword">return</span> bodyAsString;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            httpClient.close();</span><br><span class="line">            response.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送get方式请求</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">get</span><span class="params">(String url)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">CloseableHttpClient</span> <span class="variable">httpClient</span> <span class="operator">=</span> getClient();</span><br><span class="line"></span><br><span class="line">        <span class="type">HttpGet</span> <span class="variable">httpGet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpGet</span>(url);</span><br><span class="line">        httpGet.addHeader(HttpHeaders.ACCEPT, ContentType.APPLICATION_JSON.toString());</span><br><span class="line">        httpGet.addHeader(HttpHeaders.CONTENT_TYPE, ContentType.APPLICATION_JSON.toString());</span><br><span class="line">        httpGet.addHeader(<span class="string">&quot;Wechatpay-Serial&quot;</span>, weChatProperties.getMchSerialNo());</span><br><span class="line"></span><br><span class="line">        <span class="type">CloseableHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> httpClient.execute(httpGet);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">bodyAsString</span> <span class="operator">=</span> EntityUtils.toString(response.getEntity());</span><br><span class="line">            <span class="keyword">return</span> bodyAsString;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            httpClient.close();</span><br><span class="line">            response.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * jsapi下单</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderNum    商户订单号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> total       总金额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> description 商品描述</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> openid      微信用户的openid</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">jsapi</span><span class="params">(String orderNum, BigDecimal total, String description, String openid)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        jsonObject.put(<span class="string">&quot;appid&quot;</span>, weChatProperties.getAppid());<span class="comment">//读取的配置文件  Appid</span></span><br><span class="line">        jsonObject.put(<span class="string">&quot;mchid&quot;</span>, weChatProperties.getMchid());<span class="comment">//读取的配置文件  商户号</span></span><br><span class="line">        jsonObject.put(<span class="string">&quot;description&quot;</span>, description); <span class="comment">//参数传递过来的  描述信息</span></span><br><span class="line">        jsonObject.put(<span class="string">&quot;out_trade_no&quot;</span>, orderNum); <span class="comment">//参数传递过来的  订单号</span></span><br><span class="line">        jsonObject.put(<span class="string">&quot;notify_url&quot;</span>, weChatProperties.getNotifyUrl());<span class="comment">//读取的配置文件  退款成功的回调</span></span><br><span class="line"></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">amount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        amount.put(<span class="string">&quot;total&quot;</span>, total.multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">100</span>)).setScale(<span class="number">2</span>, BigDecimal.ROUND_HALF_UP).intValue());</span><br><span class="line">        amount.put(<span class="string">&quot;currency&quot;</span>, <span class="string">&quot;CNY&quot;</span>);</span><br><span class="line"></span><br><span class="line">        jsonObject.put(<span class="string">&quot;amount&quot;</span>, amount); <span class="comment">//订单金额</span></span><br><span class="line"></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">payer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        payer.put(<span class="string">&quot;openid&quot;</span>, openid);</span><br><span class="line"></span><br><span class="line">        jsonObject.put(<span class="string">&quot;payer&quot;</span>, payer); <span class="comment">//参数传递过来的   支付者</span></span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> jsonObject.toJSONString();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//调用上面这个post方法，参数：生成预支付交易单的接口地址（本类中定义的常量）、封装的请求参数</span></span><br><span class="line">        <span class="comment">//    post方法作用：底层使用的还是httpClient发起的请求</span></span><br><span class="line">        <span class="keyword">return</span> post(JSAPI, body);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 小程序支付：加密相关的代码都是固定的，以后想要使用的话直接复制即可。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderNum    商户订单号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> total       金额，单位 元</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> description 商品描述</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> openid      微信用户的openid</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> JSONObject <span class="title function_">pay</span><span class="params">(String orderNum, BigDecimal total, String description, String openid)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//统一下单，生成预支付交易单</span></span><br><span class="line">        <span class="comment">//jsapi方法（上面这个方法就是）：封装的是调用微信下单接口，生成预支付交易单接口时所需要的参数</span></span><br><span class="line">        <span class="comment">//bodyAsString：返回的是预支付标识，是个字符串</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">bodyAsString</span> <span class="operator">=</span> jsapi(orderNum, total, description, openid);</span><br><span class="line">        <span class="comment">//解析返回结果：需要把这个预支付标识转化为json</span></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSON.parseObject(bodyAsString);</span><br><span class="line">        System.out.println(jsonObject);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取prepayId预支付标识的值</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">prepayId</span> <span class="operator">=</span> jsonObject.getString(<span class="string">&quot;prepay_id&quot;</span>);</span><br><span class="line">        <span class="comment">//封装一系列的数据，对数据进行加密并且签名</span></span><br><span class="line">        <span class="keyword">if</span> (prepayId != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">timeStamp</span> <span class="operator">=</span> String.valueOf(System.currentTimeMillis() / <span class="number">1000</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">nonceStr</span> <span class="operator">=</span> RandomStringUtils.randomNumeric(<span class="number">32</span>);</span><br><span class="line">            ArrayList&lt;Object&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            list.add(weChatProperties.getAppid());</span><br><span class="line">            list.add(timeStamp);</span><br><span class="line">            list.add(nonceStr);</span><br><span class="line">            list.add(<span class="string">&quot;prepay_id=&quot;</span> + prepayId);</span><br><span class="line">            <span class="comment">//二次签名，调起支付需要重新签名</span></span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">stringBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            <span class="keyword">for</span> (Object o : list) &#123;</span><br><span class="line">                stringBuilder.append(o).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">String</span> <span class="variable">signMessage</span> <span class="operator">=</span> stringBuilder.toString();</span><br><span class="line">            <span class="type">byte</span>[] message = signMessage.getBytes();</span><br><span class="line"></span><br><span class="line">            <span class="type">Signature</span> <span class="variable">signature</span> <span class="operator">=</span> Signature.getInstance(<span class="string">&quot;SHA256withRSA&quot;</span>);</span><br><span class="line">            signature.initSign(PemUtil.loadPrivateKey(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(weChatProperties.getPrivateKeyFilePath()))));</span><br><span class="line">            signature.update(message);</span><br><span class="line">            <span class="type">String</span> <span class="variable">packageSign</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(signature.sign());</span><br><span class="line"></span><br><span class="line">            <span class="comment">//构造数据给微信小程序，用于调起微信支付</span></span><br><span class="line">            <span class="comment">// 前端微信小程序调用wx.requestPayment方法需要传递的参数，封装好之后传递给前端小程序</span></span><br><span class="line">            <span class="type">JSONObject</span> <span class="variable">jo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">            jo.put(<span class="string">&quot;timeStamp&quot;</span>, timeStamp);</span><br><span class="line">            jo.put(<span class="string">&quot;nonceStr&quot;</span>, nonceStr);</span><br><span class="line">            jo.put(<span class="string">&quot;package&quot;</span>, <span class="string">&quot;prepay_id=&quot;</span> + prepayId);</span><br><span class="line">            jo.put(<span class="string">&quot;signType&quot;</span>, <span class="string">&quot;RSA&quot;</span>);</span><br><span class="line">            jo.put(<span class="string">&quot;paySign&quot;</span>, packageSign);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> jo;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> jsonObject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 申请退款</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> outTradeNo    商户订单号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> outRefundNo   商户退款单号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> refund        退款金额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> total         原订单金额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">refund</span><span class="params">(String outTradeNo, String outRefundNo, BigDecimal refund, BigDecimal total)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        jsonObject.put(<span class="string">&quot;out_trade_no&quot;</span>, outTradeNo);</span><br><span class="line">        jsonObject.put(<span class="string">&quot;out_refund_no&quot;</span>, outRefundNo);</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">amount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        amount.put(<span class="string">&quot;refund&quot;</span>, refund.multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">100</span>)).setScale(<span class="number">2</span>, BigDecimal.ROUND_HALF_UP).intValue());</span><br><span class="line">        amount.put(<span class="string">&quot;total&quot;</span>, total.multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">100</span>)).setScale(<span class="number">2</span>, BigDecimal.ROUND_HALF_UP).intValue());</span><br><span class="line">        amount.put(<span class="string">&quot;currency&quot;</span>, <span class="string">&quot;CNY&quot;</span>);</span><br><span class="line"></span><br><span class="line">        jsonObject.put(<span class="string">&quot;amount&quot;</span>, amount);</span><br><span class="line">        jsonObject.put(<span class="string">&quot;notify_url&quot;</span>, weChatProperties.getRefundNotifyUrl());</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> jsonObject.toJSONString();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//调用申请退款接口</span></span><br><span class="line">        <span class="keyword">return</span> post(REFUNDS, body);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>在OrderServiceImpl.java中实现payment和paySuccess两个方法</strong></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> WeChatPayUtil weChatPayUtil;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 订单支付</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> ordersPaymentDTO</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> OrderPaymentVO <span class="title function_">payment</span><span class="params">(OrdersPaymentDTO ordersPaymentDTO)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">       <span class="comment">//1.获取当前登录用户id，之后根据id查询数据库把用户数据查询出来</span></span><br><span class="line">       <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> BaseContext.getCurrentId();</span><br><span class="line">       <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.getById(userId);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//2.调用微信支付接口工具类，生成预支付交易单（对应第5步）</span></span><br><span class="line">       <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> weChatPayUtil.pay(</span><br><span class="line">               ordersPaymentDTO.getOrderNumber(), <span class="comment">//商户订单号</span></span><br><span class="line">               <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">0.01</span>), <span class="comment">//支付金额，单位 元</span></span><br><span class="line">               <span class="string">&quot;苍穹外卖订单&quot;</span>, <span class="comment">//商品描述</span></span><br><span class="line">               user.getOpenid() <span class="comment">//微信用户的openid</span></span><br><span class="line">       );</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (jsonObject.getString(<span class="string">&quot;code&quot;</span>) != <span class="literal">null</span> &amp;&amp; jsonObject.getString(<span class="string">&quot;code&quot;</span>).equals(<span class="string">&quot;ORDERPAID&quot;</span>)) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OrderBusinessException</span>(<span class="string">&quot;该订单已支付&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//3.转化为vo对象在返回给controller</span></span><br><span class="line">       <span class="type">OrderPaymentVO</span> <span class="variable">vo</span> <span class="operator">=</span> jsonObject.toJavaObject(OrderPaymentVO.class);</span><br><span class="line">       vo.setPackageStr(jsonObject.getString(<span class="string">&quot;package&quot;</span>));</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> vo;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 支付成功，修改订单状态</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> outTradeNo</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">paySuccess</span><span class="params">(String outTradeNo)</span> &#123;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 根据订单号查询订单</span></span><br><span class="line">       <span class="type">Orders</span> <span class="variable">ordersDB</span> <span class="operator">=</span> orderMapper.getByNumber(outTradeNo);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 根据订单id更新订单的状态、支付方式、支付状态、结账时间</span></span><br><span class="line">       <span class="type">Orders</span> <span class="variable">orders</span> <span class="operator">=</span> Orders.builder()</span><br><span class="line">               .id(ordersDB.getId())</span><br><span class="line">               .status(Orders.TO_BE_CONFIRMED)</span><br><span class="line">               .payStatus(Orders.PAID)</span><br><span class="line">               .checkoutTime(LocalDateTime.now())</span><br><span class="line">               .build();</span><br><span class="line"></span><br><span class="line">       orderMapper.update(orders);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p><strong>在OrderMapper.xml中添加</strong></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;update id=<span class="string">&quot;update&quot;</span> parameterType=<span class="string">&quot;com.sky.entity.Orders&quot;</span>&gt;</span><br><span class="line">     update orders</span><br><span class="line">     &lt;set&gt;</span><br><span class="line">         &lt;<span class="keyword">if</span> test=<span class="string">&quot;cancelReason != null and cancelReason!=&#x27;&#x27; &quot;</span>&gt;</span><br><span class="line">             cancel_reason=#&#123;cancelReason&#125;,</span><br><span class="line">         &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">         &lt;<span class="keyword">if</span> test=<span class="string">&quot;rejectionReason != null and rejectionReason!=&#x27;&#x27; &quot;</span>&gt;</span><br><span class="line">             rejection_reason=#&#123;rejectionReason&#125;,</span><br><span class="line">         &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">         &lt;<span class="keyword">if</span> test=<span class="string">&quot;cancelTime != null&quot;</span>&gt;</span><br><span class="line">             cancel_time=#&#123;cancelTime&#125;,</span><br><span class="line">         &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">         &lt;<span class="keyword">if</span> test=<span class="string">&quot;payStatus != null&quot;</span>&gt;</span><br><span class="line">             pay_status=#&#123;payStatus&#125;,</span><br><span class="line">         &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">         &lt;<span class="keyword">if</span> test=<span class="string">&quot;payMethod != null&quot;</span>&gt;</span><br><span class="line">             pay_method=#&#123;payMethod&#125;,</span><br><span class="line">         &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">         &lt;<span class="keyword">if</span> test=<span class="string">&quot;checkoutTime != null&quot;</span>&gt;</span><br><span class="line">             checkout_time=#&#123;checkoutTime&#125;,</span><br><span class="line">         &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">         &lt;<span class="keyword">if</span> test=<span class="string">&quot;status != null&quot;</span>&gt;</span><br><span class="line">             status = #&#123;status&#125;,</span><br><span class="line">         &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">         &lt;<span class="keyword">if</span> test=<span class="string">&quot;deliveryTime != null&quot;</span>&gt;</span><br><span class="line">             delivery_time = #&#123;deliveryTime&#125;</span><br><span class="line">         &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">     &lt;/set&gt;</span><br><span class="line">     <span class="type">where</span> <span class="variable">id</span> <span class="operator">=</span> #&#123;id&#125;</span><br><span class="line"> &lt;/update&gt;</span><br></pre></td></tr></table></figure>
<p><strong>在OrderMapper.java中添加getByNumberAndUserId和update两个方法</strong></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 根据订单号查询订单</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> orderNumber</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="meta">@Select(&quot;select * from orders where number = #&#123;orderNumber&#125;&quot;)</span></span><br><span class="line"> Orders <span class="title function_">getByNumber</span><span class="params">(String orderNumber)</span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 修改订单状态信息</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> orders</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Orders orders)</span>;</span><br></pre></td></tr></table></figure>
<p><strong>在UserMapper中添加getById方法</strong></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据主键查用户</span></span><br><span class="line"><span class="meta">@Select(&quot;select * from user where id = #&#123;id&#125;&quot;)</span></span><br><span class="line">User <span class="title function_">getById</span><span class="params">(Long userId)</span>;</span><br></pre></td></tr></table></figure>
<p>步骤说明：</p>
<ul>
<li>调用预支付接口生成预支付交易单：对应4、5、6、7、8
<ul>
<li>
<p>控制层方法：</p>
<p><a target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/71035b7739b50cb8f6a14f0d82d1b92f.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/71035b7739b50cb8f6a14f0d82d1b92f.png" alt=""></a></p>
</li>
<li>
<p>用到的DTO：订单号、付款方式（因为当前只提供了一种支付方式，微信小程序支付，所以这个参数没有用到）</p>
<p><a target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/ebaf3f77a4c8bd45da06aed732c337da.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/ebaf3f77a4c8bd45da06aed732c337da.png" alt=""></a></p>
</li>
<li>
<p>业务层方法：获取用户数据，生成预支付交易单，转化为vo对象在返回给controller</p>
<p><a target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/2e030a808635867a1bf9478c181cc43a.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/2e030a808635867a1bf9478c181cc43a.png" alt=""></a></p>
</li>
<li>
<p>用到的工具类：层层调用，pay—》jsapi—》post----》getClient</p>
<p>![[9f6bd6e787150084cbae818d1a31ed6e.png]]</p>
</li>
</ul>
</li>
</ul>
<p>支付成功回调：修改后台订单状态</p>
<ul>
<li>
<p>控制层：</p>
<p><a target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/ad4eb0b5b3ba606cd663d81b41c0551e.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/ad4eb0b5b3ba606cd663d81b41c0551e.png" alt=""></a></p>
</li>
<li>
<p>业务层：</p>
<p><a target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/22ed21cd6584ae9d62c4e99afc902cf6.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/22ed21cd6584ae9d62c4e99afc902cf6.png" alt=""></a></p>
</li>
</ul>
</li>
</ul>
<h3 id="解决没有商户号问题"><strong>解决没有商户号问题</strong></h3>
<p>说明：</p>
<ul>
<li>要实现微信支付就需要注册微信支付的一个商户号，这个商户号是必须要有一家企业并且有正规的营业执照。</li>
<li>个人没办法获得商户号，所以这里直接修改前后端代码跳过微信支付接口，点击微信支付直接现显示支付成功，之后修改订单的状态。</li>
</ul>
<h3 id="前端小程序修改"><strong>前端小程序修改</strong></h3>
<p>修改为：点击支付按钮后直接跳转支付成功</p>
<ul>
<li>
<p>首先在微信小程序里的pay包下的index.js中将如下的代码注释掉：</p>
<p><a target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/382c3ef4a8577e25297420a0914854f5.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/382c3ef4a8577e25297420a0914854f5.png" alt=""></a></p>
</li>
<li>
<p>然后把原先注释掉的重定向解除：</p>
<p><a target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/1c70bde4afd8bd31e217d4c96077154c.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/1c70bde4afd8bd31e217d4c96077154c.png" alt=""></a></p>
</li>
</ul>
<h3 id="后端修改"><strong>后端修改</strong></h3>
<p>修改为：要求在收到前端支付操作后，不进行任何判断，直接给数据库设置已支付状态。</p>
<ul>
<li>
<p>把service/impl下的OrderServiceImpl中的如下代码注释掉：</p>
<p><a target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/926a0507e403d0466b963fa22aa51648.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/926a0507e403d0466b963fa22aa51648.png" alt=""></a></p>
</li>
<li>
<p>同样在OrderServiceImpl中，写入如下代码，用于设置参数：</p>
<p><a target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/74345ecb1425f5c8afc4749f9410445e.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/74345ecb1425f5c8afc4749f9410445e.png" alt=""></a></p>
</li>
</ul>
<p>完整的订单支付代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单支付</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ordersPaymentDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> OrderPaymentVO <span class="title function_">payment</span><span class="params">(OrdersPaymentDTO ordersPaymentDTO)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//1.获取当前登录用户id，之后根据id查询数据库把用户数据查询出来</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> BaseContext.getCurrentId();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.getById(userId);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*        //2.调用微信支付接口工具类，生成预支付交易单（对应第5步）</span></span><br><span class="line"><span class="comment">        JSONObject jsonObject = weChatPayUtil.pay(</span></span><br><span class="line"><span class="comment">                ordersPaymentDTO.getOrderNumber(), //商户订单号</span></span><br><span class="line"><span class="comment">                new BigDecimal(0.01), //支付金额，单位 元</span></span><br><span class="line"><span class="comment">                &quot;苍穹外卖订单&quot;, //商品描述</span></span><br><span class="line"><span class="comment">                user.getOpenid() //微信用户的openid</span></span><br><span class="line"><span class="comment">        );</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        if (jsonObject.getString(&quot;code&quot;) != null &amp;&amp; jsonObject.getString(&quot;code&quot;).equals(&quot;ORDERPAID&quot;)) &#123;</span></span><br><span class="line"><span class="comment">            throw new OrderBusinessException(&quot;该订单已支付&quot;);</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        //3.转化为vo对象在返回给controller</span></span><br><span class="line"><span class="comment">        OrderPaymentVO vo = jsonObject.toJavaObject(OrderPaymentVO.class);</span></span><br><span class="line"><span class="comment">        vo.setPackageStr(jsonObject.getString(&quot;package&quot;));*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        jsonObject.put(<span class="string">&quot;code&quot;</span>,<span class="string">&quot;ORDERPAID&quot;</span>);</span><br><span class="line">        <span class="type">OrderPaymentVO</span> <span class="variable">vo</span> <span class="operator">=</span> jsonObject.toJavaObject(OrderPaymentVO.class);</span><br><span class="line">        vo.setPackageStr(jsonObject.getString(<span class="string">&quot;package&quot;</span>));</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">OrderPaidStatus</span> <span class="operator">=</span> Orders.PAID;<span class="comment">//支付状态，已支付</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">OrderStatus</span> <span class="operator">=</span> Orders.TO_BE_CONFIRMED;  <span class="comment">//订单状态，待接单</span></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">check_out_time</span> <span class="operator">=</span> LocalDateTime.now();<span class="comment">//更新支付时间</span></span><br><span class="line">        <span class="comment">//获得的是String类型，需要的是Long类型，所以需要进行转化</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">orderidS</span> <span class="operator">=</span> ordersPaymentDTO.getOrderNumber();</span><br><span class="line">        <span class="type">Long</span> <span class="variable">orderidL</span> <span class="operator">=</span>Long.parseLong(orderidS);<span class="comment">//获取订单号</span></span><br><span class="line">        orderMapper.updateStatus(OrderStatus, OrderPaidStatus, check_out_time,orderidL );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> vo;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在OrderMapper中写入如下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//手动修改订单状态：解决个人没有商户号不能测试订单支付问题</span></span><br><span class="line"><span class="meta">@Update(&quot;update orders set status = #&#123;orderStatus&#125;,pay_status = #&#123;orderPaidStatus&#125; ,checkout_time = #&#123;check_out_time&#125; &quot; +</span></span><br><span class="line"><span class="meta">        &quot;where number = #&#123;orderidL&#125;&quot;)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">updateStatus</span><span class="params">(Integer orderStatus, Integer orderPaidStatus, LocalDateTime check_out_time, Long orderidL)</span>;</span><br></pre></td></tr></table></figure>
<p>![[/image 2 37.png|image 2 37.png]]</p>
<h1>十三、<strong>用户端历史订单模块&amp;商家端订单管理模块&amp;地址是否超出配送范围</strong></h1>
<h2 id="13-1-用户端历史订单模块">13.1 <strong>用户端历史订单模块</strong></h2>
<p>![[50ac82770dbf8bb975032a97d0641e57.png]]</p>
<h3 id="13-1-1-分页查询历史订单">13.1.1 分页查询历史订单</h3>
<p>![[/image 3 33.png|image 3 33.png]]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/historyOrders&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;历史订单分页查询&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;PageResult&gt; <span class="title function_">page</span><span class="params">(OrdersPageQueryDTO ordersPageQueryDTO)</span> &#123;</span><br><span class="line">	<span class="type">PageResult</span> <span class="variable">pageResult</span> <span class="operator">=</span> orderService.pageOuery4User(ordersPageQueryDTO);</span><br><span class="line">	<span class="keyword">return</span> Result.success(pageResult);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageResult <span class="title function_">pageOuery4User</span><span class="params">(OrdersPageQueryDTO ordersPageQueryDTO)</span> &#123;</span><br><span class="line">	<span class="type">int</span> <span class="variable">pageNum</span> <span class="operator">=</span> ordersPageQueryDTO.getPage();</span><br><span class="line">	<span class="type">int</span> <span class="variable">pageSize</span> <span class="operator">=</span> ordersPageQueryDTO.getPageSize();</span><br><span class="line">	PageHelper.startPage(pageNum, pageSize);</span><br><span class="line"></span><br><span class="line">	<span class="type">OrdersPageQueryDTO</span> <span class="variable">ordersPageQueryDTO1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrdersPageQueryDTO</span>();</span><br><span class="line">	ordersPageQueryDTO1.setUserId(BaseContext.getCurrentId());</span><br><span class="line">	ordersPageQueryDTO1.setStatus(ordersPageQueryDTO.getStatus());</span><br><span class="line"></span><br><span class="line">	Page&lt;Orders&gt; page = orderMapper.pageQuery(ordersPageQueryDTO1);</span><br><span class="line"></span><br><span class="line">	ArrayList&lt;OrderVO&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 查询出订单明细，并封装入OrderVO进行响应</span></span><br><span class="line">	<span class="keyword">if</span> (page != <span class="literal">null</span> &amp;&amp; page.getTotal() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">for</span> (Orders order : page) &#123;</span><br><span class="line">			<span class="type">Long</span> <span class="variable">orderId</span> <span class="operator">=</span> order.getId();</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 查询订单明细</span></span><br><span class="line">			List&lt;OrderDetail&gt; orderDetails = orderDetailMapper.getByOrderId(orderId);</span><br><span class="line"></span><br><span class="line">			<span class="type">OrderVO</span> <span class="variable">orderVO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderVO</span>();</span><br><span class="line">			BeanUtils.copyProperties(order, orderVO);</span><br><span class="line">			orderVO.setOrderDetailList(orderDetails);</span><br><span class="line"></span><br><span class="line">			list.add(orderVO);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageResult</span>(page.getTotal(), list);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageResult <span class="title function_">pageOuery4User</span><span class="params">(OrdersPageQueryDTO ordersPageQueryDTO)</span> &#123;</span><br><span class="line">	<span class="type">int</span> <span class="variable">pageNum</span> <span class="operator">=</span> ordersPageQueryDTO.getPage();</span><br><span class="line">	<span class="type">int</span> <span class="variable">pageSize</span> <span class="operator">=</span> ordersPageQueryDTO.getPageSize();</span><br><span class="line">	PageHelper.startPage(pageNum, pageSize);</span><br><span class="line"></span><br><span class="line">	<span class="type">OrdersPageQueryDTO</span> <span class="variable">ordersPageQueryDTO1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrdersPageQueryDTO</span>();</span><br><span class="line">	ordersPageQueryDTO1.setUserId(BaseContext.getCurrentId());</span><br><span class="line">	ordersPageQueryDTO1.setStatus(ordersPageQueryDTO.getStatus());</span><br><span class="line"></span><br><span class="line">	Page&lt;Orders&gt; page = orderMapper.pageQuery(ordersPageQueryDTO1);</span><br><span class="line"></span><br><span class="line">	ArrayList&lt;OrderVO&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 查询出订单明细，并封装入OrderVO进行响应</span></span><br><span class="line">	<span class="keyword">if</span> (page != <span class="literal">null</span> &amp;&amp; page.getTotal() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">for</span> (Orders order : page) &#123;</span><br><span class="line">			<span class="type">Long</span> <span class="variable">orderId</span> <span class="operator">=</span> order.getId();</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 查询订单明细</span></span><br><span class="line">			List&lt;OrderDetail&gt; orderDetails = orderDetailMapper.getByOrderId(orderId);</span><br><span class="line"></span><br><span class="line">			<span class="type">OrderVO</span> <span class="variable">orderVO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderVO</span>();</span><br><span class="line">			BeanUtils.copyProperties(order, orderVO);</span><br><span class="line">			orderVO.setOrderDetailList(orderDetails);</span><br><span class="line"></span><br><span class="line">			list.add(orderVO);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageResult</span>(page.getTotal(), list);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;select id=<span class="string">&quot;pageQuery&quot;</span> resultType=<span class="string">&quot;Orders&quot;</span>&gt;</span><br><span class="line">      select * from orders</span><br><span class="line">      &lt;where&gt;</span><br><span class="line">          &lt;<span class="keyword">if</span> test=<span class="string">&quot;number != null and number!=&#x27;&#x27;&quot;</span>&gt;</span><br><span class="line">              and number like <span class="title function_">concat</span><span class="params">(<span class="string">&#x27;%&#x27;</span>,#&#123;number&#125;,<span class="string">&#x27;%&#x27;</span>)</span></span><br><span class="line">          &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">          &lt;<span class="keyword">if</span> test=<span class="string">&quot;phone != null and phone!=&#x27;&#x27;&quot;</span>&gt;</span><br><span class="line">              and phone like <span class="title function_">concat</span><span class="params">(<span class="string">&#x27;%&#x27;</span>,#&#123;phone&#125;,<span class="string">&#x27;%&#x27;</span>)</span></span><br><span class="line">          &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">          &lt;<span class="keyword">if</span> test=<span class="string">&quot;userId != null&quot;</span>&gt;</span><br><span class="line">              <span class="type">and</span> <span class="variable">user_id</span> <span class="operator">=</span> #&#123;userId&#125;</span><br><span class="line">          &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">          &lt;<span class="keyword">if</span> test=<span class="string">&quot;status != null&quot;</span>&gt;</span><br><span class="line">              <span class="type">and</span> <span class="variable">status</span> <span class="operator">=</span> #&#123;status&#125;</span><br><span class="line">          &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">          &lt;<span class="keyword">if</span> test=<span class="string">&quot;beginTime != null&quot;</span>&gt;</span><br><span class="line">              and order_time &amp;gt;= #&#123;beginTime&#125;</span><br><span class="line">          &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">          &lt;<span class="keyword">if</span> test=<span class="string">&quot;endTime != null&quot;</span>&gt;</span><br><span class="line">              and order_time &amp;lt;= #&#123;endTime&#125;</span><br><span class="line">          &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">      &lt;/where&gt;</span><br><span class="line">      order by order_time desc</span><br><span class="line">  &lt;/select&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Select(&quot;select * from order_detail where order_id = #&#123;orderId&#125;&quot;)</span></span><br><span class="line">List&lt;OrderDetail&gt; <span class="title function_">getByOrderId</span><span class="params">(Long orderId)</span>;</span><br></pre></td></tr></table></figure>
<h3 id="13-1-2-查询订单详情">13.1.2 查询订单详情</h3>
<p>GET/user/order/orderDetail/{id}</p>
<p>![[3fa52e4bbf000548ecea7a39c428a50e.png]]</p>
<p>![[/image 4 32.png|image 4 32.png]]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/orderDetail/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;查询订单详情&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderVO&gt; <span class="title function_">details</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">	<span class="type">OrderVO</span> <span class="variable">orderVO</span> <span class="operator">=</span> orderService.details(id);</span><br><span class="line">	<span class="keyword">return</span> Result.success(orderVO);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> OrderVO <span class="title function_">details</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">	<span class="type">Orders</span> <span class="variable">orders</span> <span class="operator">=</span> orderMapper.getById(id);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 查询该订单对应的菜品/套餐明细</span></span><br><span class="line">	List&lt;OrderDetail&gt; orderDetailList = orderDetailMapper.getByOrderId(orders.getId());</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 将该订单及其详情封装到OrderVO并返回</span></span><br><span class="line">	<span class="type">OrderVO</span> <span class="variable">orderVO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderVO</span>();</span><br><span class="line">	BeanUtils.copyProperties(orders, orderVO);</span><br><span class="line">	orderVO.setOrderDetailList(orderDetailList);</span><br><span class="line">	<span class="keyword">return</span> orderVO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="13-1-3-取消订单">13.1.3 取消订单</h3>
<p>PUT/user/order/cancel/{id}</p>
<p>![[/image 5 29.png|image 5 29.png]]</p>
<ul>
<li>待支付和待接单状态下，用户可直接取消订单</li>
<li>商家已接单状态下，用户取消订单需电话沟通商家</li>
<li>派送中状态下，用户取消订单需电话沟通商家</li>
<li>如果在待接单状态下取消订单，需要给用户退款</li>
<li>取消订单后需要将订单状态修改为“已取消”</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PutMapping(&quot;/cancal/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;取消订单&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">cacel</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	orderService.userCancelById(id);</span><br><span class="line">	<span class="keyword">return</span> Result.success();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">userCancelById</span><span class="params">(Long id)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	<span class="type">Orders</span> <span class="variable">ordersDB</span> <span class="operator">=</span> orderMapper.getById(id);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 检验订单是否存在</span></span><br><span class="line">	<span class="keyword">if</span> (ordersDB == <span class="literal">null</span>)</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OrderBusinessException</span>(MessageConstant.ORDER_NOT_FOUND);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 订单状态 1待付款 2待接单 3已接单 4派送中 5已完成 6已取消</span></span><br><span class="line">	<span class="keyword">if</span> (ordersDB.getStatus() &gt; <span class="number">2</span>) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OrderBusinessException</span>(MessageConstant.ORDER_STATUS_ERROR);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 以上验证都通过后，此时订单处于待支付和待接单状态下</span></span><br><span class="line">	<span class="type">Orders</span> <span class="variable">orders</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Orders</span>();</span><br><span class="line">	orders.setId(ordersDB.getId());</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 订单处于待接单状态下取消，需要进行退款</span></span><br><span class="line">	<span class="keyword">if</span> (ordersDB.getStatus().equals(Orders.TO_BE_CONFIRMED)) &#123;</span><br><span class="line">		<span class="comment">// 调用微信支付退款接口</span></span><br><span class="line">		weChatPayUtil.refund( <span class="comment">// 需要添加异常</span></span><br><span class="line">				ordersDB.getNumber(), <span class="comment">// 商户订单号</span></span><br><span class="line">				ordersDB.getNumber(), <span class="comment">// 商户退款单号</span></span><br><span class="line">				<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">0.01</span>),<span class="comment">// 退款金额，单位 元</span></span><br><span class="line">				<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">0.01</span>));<span class="comment">// 原订单金额</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// 支付状态修改为 退款</span></span><br><span class="line">		orders.setPayStatus(Orders.REFUND);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 更新订单状态、取消原因、取消时间</span></span><br><span class="line">	orders.setStatus(Orders.CANCELLED);</span><br><span class="line">	orders.setCancelReason(<span class="string">&quot;用户取消&quot;</span>);</span><br><span class="line">	orders.setCancelTime(LocalDateTime.now());</span><br><span class="line">	orderMapper.update(orders);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>没办法测试，需要调用调用<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98&amp;spm=1001.2101.3001.7020">微信支付</a>退款接口，我们并没有实现支付功能，因为个人没有资质申请商户号。</p>
<h3 id="13-1-4-再来一单">13.1.4 再来一单</h3>
<p>就是将原订单中的商品重新加入到购物车中</p>
<p>也是id</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/repetition/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;再来一单&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">repetition</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">	orderService.repetition(id);</span><br><span class="line">	<span class="keyword">return</span> Result.success();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">repetition</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">	<span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> BaseContext.getCurrentId();</span><br><span class="line"></span><br><span class="line">	List&lt;OrderDetail&gt; orderDetailList = orderDetailMapper.getByOrderId(id);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 将订单对象转换为购物车对象</span></span><br><span class="line">	List&lt;ShoppingCart&gt; shoppingCartList = orderDetailList.stream().map(x -&gt; &#123;</span><br><span class="line">		<span class="type">ShoppingCart</span> <span class="variable">shoppingCart</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShoppingCart</span>();</span><br><span class="line"></span><br><span class="line">		BeanUtils.copyProperties(x, shoppingCart, <span class="string">&quot;id&quot;</span>); <span class="comment">// id 属性将不会被复制</span></span><br><span class="line">		shoppingCart.setUserId(userId);</span><br><span class="line">		shoppingCart.setCreateTime(LocalDateTime.now());</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> shoppingCart;</span><br><span class="line">	&#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 将购物车对象批量添加到数据库</span></span><br><span class="line">	shoppingCartMapper.insertBatch(shoppingCartList);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">   &lt;insert id=<span class="string">&quot;insertBatch&quot;</span> parameterType=<span class="string">&quot;list&quot;</span>&gt;</span><br><span class="line">       insert into <span class="title function_">shopping_cart</span></span><br><span class="line">       <span class="params">(name, image, user_id, dish_id, setmeal_id, dish_flavor, number, amount, create_time)</span></span><br><span class="line">       values</span><br><span class="line">       &lt;foreach collection=<span class="string">&quot;shoppingCartList&quot;</span> item=<span class="string">&quot;sc&quot;</span> separator=<span class="string">&quot;,&quot;</span>&gt;</span><br><span class="line">           (#&#123;sc.name&#125;,#&#123;sc.image&#125;,#&#123;sc.userId&#125;,#&#123;sc.dishId&#125;,#&#123;sc.setmealId&#125;,#&#123;sc.dishFlavor&#125;,#&#123;sc.number&#125;,#&#123;sc.amount&#125;,#&#123;sc.createTime&#125;)</span><br><span class="line">       &lt;/foreach&gt;</span><br><span class="line">   &lt;/insert&gt;</span><br></pre></td></tr></table></figure>
<h2 id="13-2-商家订单管理模块">13.2 商家订单管理模块</h2>
<h3 id="13-2-1-订单搜索">13.2.1 订单搜索</h3>
<ul>
<li>输入订单号/手机号进行搜索，支持模糊搜索</li>
<li>根据订单状态进行筛选</li>
<li>下单时间进行时间筛选</li>
<li>搜索内容为空，提示未找到相关订单</li>
<li>搜索结果页，展示包含搜索关键词的内容</li>
<li>分页展示搜索到的订单数据</li>
</ul>
<p>![[/image 6 26.png|image 6 26.png]]</p>
<p>admin下创建</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/conditionSearch&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;订单搜索&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;PageResult&gt; <span class="title function_">conditionSearch</span><span class="params">(OrdersPageQueryDTO ordersPageQueryDTO)</span> &#123;</span><br><span class="line">	<span class="type">PageResult</span> <span class="variable">pageResult</span> <span class="operator">=</span> orderService.conditionSearch(ordersPageQueryDTO);</span><br><span class="line">	<span class="keyword">return</span> Result.success(pageResult);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageResult <span class="title function_">conditionSearch</span><span class="params">(OrdersPageQueryDTO ordersPageQueryDTO)</span> &#123;</span><br><span class="line">	PageHelper.startPage(ordersPageQueryDTO.getPage(), ordersPageQueryDTO.getPageSize());</span><br><span class="line"></span><br><span class="line">	Page&lt;Orders&gt; page = orderMapper.pageQuery(ordersPageQueryDTO);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 部分订单状态，需要额外返回订单菜品信息，将Orders转化为OrderVO</span></span><br><span class="line">	List&lt;OrderVO&gt; orderVOList = getOrderVOList(page);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageResult</span>(page.getTotal(), orderVOList);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> List&lt;OrderVO&gt; <span class="title function_">getOrderVOList</span><span class="params">(Page&lt;Orders&gt; page)</span> &#123;</span><br><span class="line">	<span class="comment">// 需要返回订单菜品信息，自定义OrderVO响应结果</span></span><br><span class="line">	ArrayList&lt;OrderVO&gt; orderVOList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">	List&lt;Orders&gt; ordersList = page.getResult();</span><br><span class="line">	<span class="comment">// if (ordersList != null) &#123; // 仅判断是否为空</span></span><br><span class="line">	<span class="keyword">if</span> (!CollectionUtils.isEmpty(ordersList)) &#123; <span class="comment">// ordersList 不是 null，并且至少包含一个元素</span></span><br><span class="line">		<span class="keyword">for</span> (Orders orders : ordersList) &#123;</span><br><span class="line">			<span class="type">OrderVO</span> <span class="variable">orderVO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderVO</span>();</span><br><span class="line">			BeanUtils.copyProperties(orders, orderVO);</span><br><span class="line">			<span class="type">String</span> <span class="variable">orderDishes</span> <span class="operator">=</span> getOrderDishStr(orders);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 将订单菜品信息封装到orderVO中，并添加到orderVOList</span></span><br><span class="line">			orderVO.setOrderDishes(orderDishes);</span><br><span class="line">			orderVOList.add(orderVO);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> orderVOList;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据订单id获取菜品信息字符串</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orders</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">getOrderDishStr</span><span class="params">(Orders orders)</span> &#123;</span><br><span class="line">	<span class="comment">// 查询订单菜品详情信息（订单中的菜品和数量）</span></span><br><span class="line">	List&lt;OrderDetail&gt; orderDetailList = orderDetailMapper.getByOrderId(orders.getId());</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 将每一条订单菜品信息拼接为字符串（格式：宫保鸡丁*3；）</span></span><br><span class="line">	List&lt;String&gt; orderDishList = orderDetailList.stream().map(x -&gt; &#123;</span><br><span class="line">		<span class="type">String</span> <span class="variable">orderDish</span> <span class="operator">=</span> x.getName() + <span class="string">&quot;*&quot;</span> + x.getNumber() + <span class="string">&quot;;&quot;</span>;</span><br><span class="line">		<span class="keyword">return</span> orderDish;</span><br><span class="line">	&#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 将该订单对应的所有菜品信息拼接</span></span><br><span class="line">	<span class="keyword">return</span> String.join(<span class="string">&quot;&quot;</span>, orderDishList); <span class="comment">// &quot;Pizza2;Burger1;Salad*3;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="13-2-2-各个状态的订单数量统计">13.2.2 各个状态的订单数量统计</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderStatisticsVO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="comment">//待接单数量</span></span><br><span class="line">    <span class="keyword">private</span> Integer toBeConfirmed;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//待派送数量</span></span><br><span class="line">    <span class="keyword">private</span> Integer confirmed;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//派送中数量</span></span><br><span class="line">    <span class="keyword">private</span> Integer deliveryInProgress;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 各个状态的订单数量统计</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/statistics&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;各个状态的订单数量统计&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderStatisticsVO&gt; <span class="title function_">statistics</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">OrderStatisticsVO</span> <span class="variable">orderStatisticsVO</span> <span class="operator">=</span> orderService.statistics();</span><br><span class="line">    <span class="keyword">return</span> Result.success(orderStatisticsVO);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 各个状态的订单数量统计</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> OrderStatisticsVO <span class="title function_">statistics</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 根据状态，分别查询出待接单、待派送、派送中的订单数量</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">toBeConfirmed</span> <span class="operator">=</span> orderMapper.countStatus(Orders.TO_BE_CONFIRMED);</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">confirmed</span> <span class="operator">=</span> orderMapper.countStatus(Orders.CONFIRMED);</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">deliveryInProgress</span> <span class="operator">=</span> orderMapper.countStatus(Orders.DELIVERY_IN_PROGRESS);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将查询出的数据封装到orderStatisticsVO中响应</span></span><br><span class="line">    <span class="type">OrderStatisticsVO</span> <span class="variable">orderStatisticsVO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderStatisticsVO</span>();</span><br><span class="line">    orderStatisticsVO.setToBeConfirmed(toBeConfirmed);</span><br><span class="line">    orderStatisticsVO.setConfirmed(confirmed);</span><br><span class="line">    orderStatisticsVO.setDeliveryInProgress(deliveryInProgress);</span><br><span class="line">    <span class="keyword">return</span> orderStatisticsVO;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据状态统计订单数量</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> status</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Select(&quot;select count(id) from orders where status = #&#123;status&#125;&quot;)</span></span><br><span class="line">Integer <span class="title function_">countStatus</span><span class="params">(Integer status)</span>;</span><br></pre></td></tr></table></figure>
<p>![[39b9834684e3cac4f28d1383f0f87a55.png]]</p>
<h3 id="13-2-3-查询订单详情">13.2.3 查询订单详情</h3>
<ul>
<li>订单详情页面需要展示订单基本信息（状态、订单号、下单时间、收货人、电话、收货地址、金额等）</li>
<li>订单详情页面需要展示订单明细数据（商品名称、数量、单价）</li>
</ul>
<p>![[9cef7af02e814d98d38759ec7c4c8d77.png]]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 订单详情</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/details/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;查询订单详情&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderVO&gt; <span class="title function_">details</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">    <span class="type">OrderVO</span> <span class="variable">orderVO</span> <span class="operator">=</span> orderService.details(id);<span class="comment">//已实现</span></span><br><span class="line">    <span class="keyword">return</span> Result.success(orderVO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="13-2-4-接单">13.2.4 接单</h3>
<p>更新状态字段</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrdersConfirmDTO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="comment">//订单状态 1待付款 2待接单 3 已接单 4 派送中 5 已完成 6 已取消 7 退款</span></span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 接单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PutMapping(&quot;/confirm&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;接单&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">confirm</span><span class="params">(<span class="meta">@RequestBody</span> OrdersConfirmDTO ordersConfirmDTO)</span> &#123;</span><br><span class="line">    orderService.confirm(ordersConfirmDTO);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 接单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ordersConfirmDTO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(OrdersConfirmDTO ordersConfirmDTO)</span> &#123;</span><br><span class="line">    <span class="type">Orders</span> <span class="variable">orders</span> <span class="operator">=</span> Orders.builder()</span><br><span class="line">            .id(ordersConfirmDTO.getId())</span><br><span class="line">            .status(Orders.CONFIRMED)</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">    orderMapper.update(orders);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="13-2-5-拒单">13.2.5 拒单</h3>
<ul>
<li>商家拒单其实就是将订单状态修改为“已取消”</li>
<li>只有订单处于“待接单”状态时可以执行拒单操作</li>
<li>商家拒单时需要指定拒单原因</li>
<li>商家拒单时，如果用户已经完成了支付，需要为用户退款</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrdersRejectionDTO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"><span class="keyword">private</span> Long id;</span><br><span class="line"><span class="comment">//订单拒绝原因</span></span><br><span class="line"><span class="keyword">private</span> String rejectionReason;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 拒单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PutMapping(&quot;/rejection&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;拒单&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">rejection</span><span class="params">(<span class="meta">@RequestBody</span> OrdersRejectionDTO ordersRejectionDTO)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    orderService.rejection(ordersRejectionDTO);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 拒单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ordersRejectionDTO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">rejection</span><span class="params">(OrdersRejectionDTO ordersRejectionDTO)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 根据id查询订单</span></span><br><span class="line">    <span class="type">Orders</span> <span class="variable">ordersDB</span> <span class="operator">=</span> orderMapper.getById(ordersRejectionDTO.getId());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 订单只有存在且状态为2（待接单）才可以拒单</span></span><br><span class="line">    <span class="keyword">if</span> (ordersDB == <span class="literal">null</span> || !ordersDB.getStatus().equals(Orders.TO_BE_CONFIRMED)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OrderBusinessException</span>(MessageConstant.ORDER_STATUS_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//支付状态</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">payStatus</span> <span class="operator">=</span> ordersDB.getPayStatus();</span><br><span class="line">    <span class="keyword">if</span> (payStatus == Orders.PAID) &#123;</span><br><span class="line">        <span class="comment">//用户已支付，需要退款</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">refund</span> <span class="operator">=</span> weChatPayUtil.refund(</span><br><span class="line">                ordersDB.getNumber(),</span><br><span class="line">                ordersDB.getNumber(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">0.01</span>),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">0.01</span>));</span><br><span class="line">        log.info(<span class="string">&quot;申请退款：&#123;&#125;&quot;</span>, refund);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拒单需要退款，根据订单id更新订单状态、拒单原因、取消时间</span></span><br><span class="line">    <span class="type">Orders</span> <span class="variable">orders</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Orders</span>();</span><br><span class="line">    orders.setId(ordersDB.getId());</span><br><span class="line">    orders.setStatus(Orders.CANCELLED);</span><br><span class="line">    orders.setRejectionReason(ordersRejectionDTO.getRejectionReason());</span><br><span class="line">    orders.setCancelTime(LocalDateTime.now());</span><br><span class="line"></span><br><span class="line">    orderMapper.update(orders);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为调用了微信支付工具类中的申请退款接口，我们是个人没有商户号无法实现真正的支付功能，所以无法测试。</p>
<h3 id="13-2-6-取消订单">13.2.6 取消订单</h3>
<p>接单后的叫取消</p>
<p>接单前的叫拒单</p>
<ul>
<li>取消订单其实就是将订单状态修改为“已取消”</li>
<li>商家取消订单时需要指定取消原因</li>
<li>商家取消订单时，如果用户已经完成了支付，需要为用户退款</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 取消订单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PutMapping(&quot;/cancel&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;取消订单&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">cancel</span><span class="params">(<span class="meta">@RequestBody</span> OrdersCancelDTO ordersCancelDTO)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    orderService.cancel(ordersCancelDTO);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 取消订单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ordersCancelDTO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cancel</span><span class="params">(OrdersCancelDTO ordersCancelDTO)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 根据id查询订单</span></span><br><span class="line">    <span class="type">Orders</span> <span class="variable">ordersDB</span> <span class="operator">=</span> orderMapper.getById(ordersCancelDTO.getId());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//支付状态</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">payStatus</span> <span class="operator">=</span> ordersDB.getPayStatus();</span><br><span class="line">    <span class="keyword">if</span> (payStatus == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">//用户已支付，需要退款</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">refund</span> <span class="operator">=</span> weChatPayUtil.refund(</span><br><span class="line">                ordersDB.getNumber(),</span><br><span class="line">                ordersDB.getNumber(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">0.01</span>),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">0.01</span>));</span><br><span class="line">        log.info(<span class="string">&quot;申请退款：&#123;&#125;&quot;</span>, refund);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 管理端取消订单需要退款，根据订单id更新订单状态、取消原因、取消时间</span></span><br><span class="line">    <span class="type">Orders</span> <span class="variable">orders</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Orders</span>();</span><br><span class="line">    orders.setId(ordersCancelDTO.getId());</span><br><span class="line">    orders.setStatus(Orders.CANCELLED);</span><br><span class="line">    orders.setCancelReason(ordersCancelDTO.getCancelReason());</span><br><span class="line">    orders.setCancelTime(LocalDateTime.now());</span><br><span class="line">    orderMapper.update(orders);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>无法测试</p>
<h3 id="13-2-7-派送订单">13.2.7 派送订单</h3>
<ul>
<li>派送订单其实就是将订单状态修改为“派送中”</li>
<li>只有状态为“待派送3”的订单可以执行派送订单操作</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 派送订单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PutMapping(&quot;/delivery/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;派送订单&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">delivery</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">    orderService.delivery(id);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 派送订单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delivery</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">// 根据id查询订单</span></span><br><span class="line">    <span class="type">Orders</span> <span class="variable">ordersDB</span> <span class="operator">=</span> orderMapper.getById(id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 校验订单是否存在，并且状态为3</span></span><br><span class="line">    <span class="keyword">if</span> (ordersDB == <span class="literal">null</span> || !ordersDB.getStatus().equals(Orders.CONFIRMED)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OrderBusinessException</span>(MessageConstant.ORDER_STATUS_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Orders</span> <span class="variable">orders</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Orders</span>();</span><br><span class="line">    orders.setId(ordersDB.getId());</span><br><span class="line">    <span class="comment">// 更新订单状态,状态转为派送中</span></span><br><span class="line">    orders.setStatus(Orders.DELIVERY_IN_PROGRESS);</span><br><span class="line"></span><br><span class="line">    orderMapper.update(orders);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="13-2-8-完成订单">13.2.8 完成订单</h3>
<ul>
<li>完成订单其实就是将订单状态修改为“已完成”</li>
<li>只有状态为“派送中4”的订单可以执行订单完成操作</li>
</ul>
<h2 id="13-3-检验收货地址是否超出配送范围">13.3 检验收货地址是否超出配送范围</h2>
<p><strong>不写，不影响后续代码</strong></p>
<p>说明：注册账号需要填写身份证、地址等个人信息比较麻烦，只要会使用相关的API接口即可，所以这里不在实现代码。</p>
<ol>
<li>环境准备<br>
注册账号：<br>
<a target="_blank" rel="noopener" href="https://passport.baidu.com/v2/?reg&amp;tt=1671699340600&amp;overseas=&amp;gid=CF954C2-A3D2-417F-9FE6B0F249ED7E33&amp;tpl=pp&amp;u=https%3A%2F%2Flbsyun.baidu.com%2Findex.php%3Ftitle%3D%E9%A6%96%E9%A1%B5">https://passport.baidu.com/v2/?reg&amp;tt=1671699340600&amp;overseas=&amp;gid=CF954C2-A3D2-417F-9FE6B0F249ED7E33&amp;tpl=pp&amp;u=https%3A%2F%2Flbsyun.baidu.com%2Findex.php%3Ftitle%3D首页</a></li>
</ol>
<p>登录百度地图开放平台：<a target="_blank" rel="noopener" href="https://lbsyun.baidu.com/">https://lbsyun.baidu.com/</a></p>
<p>进入控制台，创建应用，获取AK：</p>
<p>![[a6e312726ba79b4f3f79c6656032a5a3.png]]</p>
<p>![[9d2beeabfb069dc4d16bfa42f66a1753.png]]</p>
<p>相关接口:</p>
<p><a target="_blank" rel="noopener" href="https://lbsyun.baidu.com/index.php?title=webapi/guide/webservice-geocoding">https://lbsyun.baidu.com/index.php?title=webapi/guide/webservice-geocoding</a></p>
<p><a target="_blank" rel="noopener" href="https://lbsyun.baidu.com/index.php?title=webapi/directionlite-v1">https://lbsyun.baidu.com/index.php?title=webapi/directionlite-v1</a></p>
<p>代码开发：</p>
<ol>
<li>
<p>application.yml<br>
配置外卖商家店铺地址和百度地图的AK：</p>
<p>![[3d3ca450b7572a1b642a00f27b2f6479.png]]</p>
</li>
<li>
<p>OrderServiceImpl</p>
<p>改造OrderServiceImpl，注入上面的配置项：</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Value(&quot;$&#123;sky.shop.address&#125;&quot;)</span><br><span class="line">private String shopAddress;</span><br><span class="line"></span><br><span class="line">@Value(&quot;$&#123;sky.baidu.ak&#125;&quot;)</span><br><span class="line">private String ak;</span><br></pre></td></tr></table></figure>
<p>在OrderServiceImpl中提供校验方法：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 检查客户的收货地址是否超出配送范围</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> address</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkOutOfRange</span><span class="params">(String address)</span> &#123;</span><br><span class="line">    <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    map.put(<span class="string">&quot;address&quot;</span>,shopAddress);</span><br><span class="line">    map.put(<span class="string">&quot;output&quot;</span>,<span class="string">&quot;json&quot;</span>);</span><br><span class="line">    map.put(<span class="string">&quot;ak&quot;</span>,ak);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取店铺的经纬度坐标</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">shopCoordinate</span> <span class="operator">=</span> HttpClientUtil.doGet(<span class="string">&quot;https://api.map.baidu.com/geocoding/v3&quot;</span>, map);</span><br><span class="line"></span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSON.parseObject(shopCoordinate);</span><br><span class="line">    <span class="keyword">if</span>(!jsonObject.getString(<span class="string">&quot;status&quot;</span>).equals(<span class="string">&quot;0&quot;</span>))&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OrderBusinessException</span>(<span class="string">&quot;店铺地址解析失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据解析</span></span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">location</span> <span class="operator">=</span> jsonObject.getJSONObject(<span class="string">&quot;result&quot;</span>).getJSONObject(<span class="string">&quot;location&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">lat</span> <span class="operator">=</span> location.getString(<span class="string">&quot;lat&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">lng</span> <span class="operator">=</span> location.getString(<span class="string">&quot;lng&quot;</span>);</span><br><span class="line">    <span class="comment">//店铺经纬度坐标</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">shopLngLat</span> <span class="operator">=</span> lat + <span class="string">&quot;,&quot;</span> + lng;</span><br><span class="line"></span><br><span class="line">    map.put(<span class="string">&quot;address&quot;</span>,address);</span><br><span class="line">    <span class="comment">//获取用户收货地址的经纬度坐标</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">userCoordinate</span> <span class="operator">=</span> HttpClientUtil.doGet(<span class="string">&quot;https://api.map.baidu.com/geocoding/v3&quot;</span>, map);</span><br><span class="line"></span><br><span class="line">    jsonObject = JSON.parseObject(userCoordinate);</span><br><span class="line">    <span class="keyword">if</span>(!jsonObject.getString(<span class="string">&quot;status&quot;</span>).equals(<span class="string">&quot;0&quot;</span>))&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OrderBusinessException</span>(<span class="string">&quot;收货地址解析失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据解析</span></span><br><span class="line">    location = jsonObject.getJSONObject(<span class="string">&quot;result&quot;</span>).getJSONObject(<span class="string">&quot;location&quot;</span>);</span><br><span class="line">    lat = location.getString(<span class="string">&quot;lat&quot;</span>);</span><br><span class="line">    lng = location.getString(<span class="string">&quot;lng&quot;</span>);</span><br><span class="line">    <span class="comment">//用户收货地址经纬度坐标</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">userLngLat</span> <span class="operator">=</span> lat + <span class="string">&quot;,&quot;</span> + lng;</span><br><span class="line"></span><br><span class="line">    map.put(<span class="string">&quot;origin&quot;</span>,shopLngLat);</span><br><span class="line">    map.put(<span class="string">&quot;destination&quot;</span>,userLngLat);</span><br><span class="line">    map.put(<span class="string">&quot;steps_info&quot;</span>,<span class="string">&quot;0&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//路线规划</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> HttpClientUtil.doGet(<span class="string">&quot;https://api.map.baidu.com/directionlite/v1/driving&quot;</span>, map);</span><br><span class="line"></span><br><span class="line">    jsonObject = JSON.parseObject(json);</span><br><span class="line">    <span class="keyword">if</span>(!jsonObject.getString(<span class="string">&quot;status&quot;</span>).equals(<span class="string">&quot;0&quot;</span>))&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OrderBusinessException</span>(<span class="string">&quot;配送路线规划失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据解析</span></span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">result</span> <span class="operator">=</span> jsonObject.getJSONObject(<span class="string">&quot;result&quot;</span>);</span><br><span class="line">    <span class="type">JSONArray</span> <span class="variable">jsonArray</span> <span class="operator">=</span> (JSONArray) result.get(<span class="string">&quot;routes&quot;</span>);</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">distance</span> <span class="operator">=</span> (Integer) ((JSONObject) jsonArray.get(<span class="number">0</span>)).get(<span class="string">&quot;distance&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(distance &gt; <span class="number">5000</span>)&#123;</span><br><span class="line">        <span class="comment">//配送距离超过5000米</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OrderBusinessException</span>(<span class="string">&quot;超出配送范围&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>在OrderServiceImpl的submitOrder方法中调用上面的校验方法：</p>
<p><a target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/ca667114bd0732661080ae355029ccb7.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/ca667114bd0732661080ae355029ccb7.png" alt=""></a></p>
<h1>十四、<strong>Spring Task、订单状态定时处理、来单提醒（WebSocket的应用）、客户催单（WebSocket的应用）</strong></h1>
<p>功能实现：<strong>订单状态定时处理</strong>、<strong>来单提醒</strong>和<strong>客户催单</strong></p>
<p><strong>订单状态定时处理：</strong></p>
<p>![[4a9473a478fcdae4bdf7109279f20ecf.png]]</p>
<p><strong>来单提醒：</strong></p>
<p><a target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/ce204aebd4d8c069c887ca438b42301f.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/ce204aebd4d8c069c887ca438b42301f.png" alt=""></a></p>
<p><strong>客户催单：</strong></p>
<p>![[d3fc90950008fd3c8505b69c739e669b.png]]</p>
<h2 id="14-1-Spring-Task">14.1 Spring Task</h2>
<p><strong>Spring Task</strong> 是Spring框架提供的任务调度工具，可以按照约定的时间_<strong>自动执行</strong>_某个代码逻辑。</p>
<p><strong>定位</strong>：定时任务框架</p>
<p><strong>作用</strong>：定时自动执行某段Java代码</p>
<p>为什么要在Java程序中使用Spring Task？</p>
<p><strong>应用场景：</strong></p>
<p>适合所有需要定期处理的任务，例如：</p>
<ul>
<li>信用卡和银行贷款的还款提醒。</li>
<li>处理未支付的订单。</li>
<li>发送入职纪念日通知。</li>
</ul>
<h3 id="14-1-1-cron表达式">14.1.1 cron表达式</h3>
<p>cron表达式其实就是一 个字符串，通过cron表达式可以<strong>定义任务触发的时间</strong></p>
<p>构成规则：分为6或7个域，由空格分隔开，每个域代表一个含义</p>
<p>每个域的含义分别为：秒、分钟、小时、日、月、周、年(可选)</p>
<p>举例：</p>
<p>2022年10月12日上午9点整 对应的cron表达式为：0 0 9 12 10 ? 2022</p>
<p>![[83446c1915bf7adf9dec2d36b94b5a36.png]]</p>
<p>说明：一般_日和周的值不同时设置_，其中一个设置，另一个用？表示</p>
<p>比如：描述2月份的最后一天，最后一天具体是几号呢？可能是28号，也有可能是29号，所以就不能写具体数字。</p>
<p>为了描述这些信息，提供一些特殊的字符。这些具体的细节，我们就不用自己去手写，因为这个cron表达式，它其实有在线生成器。</p>
<p>cron表达式在线生成器：<a target="_blank" rel="noopener" href="https://cron.qqe2.com/">https://cron.qqe2.com/</a></p>
<p>通配符：</p>
<ul>
<li><code>*</code>：表示所有值。</li>
<li><code>?</code>：表示未说明的值，，即不关心它为何值</li>
<li><code>-</code>：表示一个范围。</li>
<li><code>,</code>：表示附加值。</li>
<li><code>/</code>：符号前表示开始时间，符号后表示每次递增的值</li>
</ul>
<p>![[22a1b4c3f42e7a395da36319647de9cb.png]]</p>
<ul>
<li>
<p>特殊1：每月几号最近的那个工作日</p>
<p>![[cba7a814848a3add0acc7d7db28b6659.png]]</p>
<p>比如每月10号最近的那个工作日，周一到周五称为工作日<br>
如果10号正好是周一到周五，那么它匹配的正好是10号。<br>
如果10号正好是周六，那么离周六最近的一个工作日是周五，9号这一天。<br>
如果10号正好是周日，那么离周日最近的一个工作日是周一，11号这一天。</p>
</li>
<li>
<p>特殊2：本月最后一天</p>
<p>![[01b67aa6b14f9f3d01f6b45a7cbeb1d6.png]]</p>
<p>需要看具体月份是如何设置的<br>
如果匹配到的是10月份，那么最后一天就是31号。<br>
如果匹配到的是9月份，那么最后一天就是30号。<br>
可以直接在这个网站上面，只要根据自己的要求去生成corn表达式即可。所以一般就不用自己去编写这个表达式。</p>
</li>
</ul>
<p>cron 表达式案例：</p>
<ol>
<li><code>**/5 * * * * ?**</code>：每隔5秒执行一次。</li>
<li><code>**0 */1 * * * ?**</code>：每分钟的第0秒执行一次，即每隔1分钟执行一次。</li>
<li><code>**0 0 5-15 * * ?**</code>：每天的5点到15点整点（即5:00、6:00……15:00）触发。</li>
<li><code>**0 0/3 * * * ?**</code>：每3分钟触发一次，具体是在每个小时的第0、3、6、9、12、15、18、21、24、27、30、33、36、39、42、45、48、51、54、57分钟执行。</li>
<li><code>**0 0-5 14 * * ?**</code>：在每天下午2点到2:05期间的每1分钟触发，即2:00、2:01、2:02、2:03、2:04、2:05执行。</li>
<li><code>**0 0/5 14 * * ?**</code>：在每天下午2点到2:55期间的每5分钟触发，即2:00、2:05、2:10、2:15、2:20、2:25、2:30、2:35、2:40、2:45、2:50、2:55执行。</li>
<li><code>**0 0/5 14,18 * * ?**</code>：在每天下午2点到2:55期间和下午6点到6:55期间的每5分钟触发。</li>
<li><code>**0 0/30 9-17 * * ?**</code>：在工作时间内（9点到17点）每半小时触发，即9:00、9:30、10:00……17:00、17:30执行。</li>
<li><code>**0 0 10,14,16 * * ?**</code>：每天上午10点、下午2点和4点触发。</li>
</ol>
<h3 id="14-1-2-入门案例">14.1.2 <strong>入门案例</strong></h3>
<ol>
<li>
<p>导入maven坐标 spring-context</p>
<p>![[12a5b0384677ae08b7d963cae79dbcc2.png]]</p>
</li>
<li>
<p>启动类添加注解 @EnableScheduling 开启任务调度</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky;</span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span> <span class="comment">//开启注解方式的事务管理</span></span><br><span class="line"><span class="meta">@EnableCaching</span> <span class="comment">//开启缓存注解功能</span></span><br><span class="line"><span class="meta">@EnableScheduling</span> <span class="comment">//开启任务调度</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SkyApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(SkyApplication.class, args);</span><br><span class="line">        log.info(<span class="string">&quot;server started&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>自定义定时任务类 sek-server下创建task包</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.task;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义定时任务类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span> <span class="comment">//需要交给Spring容器去管理</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTask</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定时任务 每隔5秒触发一次</span></span><br><span class="line"><span class="comment">     * 定时任务具体处理的业务逻辑需要写在这个方法里面  。</span></span><br><span class="line"><span class="comment">     * 方法返回值类型是void，方法名任意。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0/5 * * * * ?&quot;)</span> <span class="comment">// 从第0秒开始每隔5秒开始触发</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">executeTask</span><span class="params">()</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;定时任务开始执行：&#123;&#125;&quot;</span>,<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/3607326d637b9d64ab04f7b9ff69e464.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/3607326d637b9d64ab04f7b9ff69e464.png" alt=""></a></p>
<p>每隔5秒执行一次。</p>
<h2 id="14-2-订单状态定时处理">14.2 <strong>订单状态定时处理</strong></h2>
<p>用户下单后可能存在的情况：</p>
<ul>
<li>
<p>下单后未支付，订单一直处于<strong>待支付</strong>状态</p>
</li>
<li>
<p>用户收货后管理端未点击完成按钮，订单一直处于<strong>派送中</strong>状态</p>
<p>![[1079118d30caa38045bd2e8b7080bbd5.png]]</p>
</li>
</ul>
<p>对于上面两种情况需要通过<strong>定时任务</strong>来修改订单状态，具体逻辑为：</p>
<ul>
<li>通过定时任务<strong>每分钟检查一次</strong>是否存在支付超时订单（下单后超过15分钟仍未支付则判定为支付超时订单），如果存在则修改订单状态为“已取消”</li>
<li>通过定时任务<strong>每天凌晨1点检查一次</strong>是否存在“派送中”的订单，如果存在则修改订单状态为“已完成”</li>
</ul>
<p>注意：这个地方就不需要做接口设计了，这里是通过定时任务自动执行的，并不需要前端发送http请求来触发，所以这个地方就没有接口这个概念了。</p>
<p>问题：对于这两类订单（支付超时订单、派送中的订单）的处理是不是要编写2个定时任务类呢？？</p>
<p>答：写一个定时任务类 类里面写2个方法 或者 写2个定时任务类 每个类里面写一个方法都可以。</p>
<ol>
<li>
<p><strong>自定义定时任务类OrderTask</strong></p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.task;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义定时任务，实现订单状态定时处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderTask</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderMapper orderMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理支付超时订单</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0 * * * * ?&quot;)</span> <span class="comment">// 每分钟触发一次</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processTimeoutOrder</span><span class="params">()</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;处理支付超时订单：&#123;&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理“派送中”状态的订单</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0 0 1 * * ?&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processDeliveryOrder</span><span class="params">()</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;处理派送中订单：&#123;&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>完善定时任务类的processTimeoutOrder方法</strong></p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理支付超时订单的方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Scheduled(cron = &quot;0 * * * * ?&quot;)</span><span class="comment">//每分钟触发一次</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processTimeoutOrder</span><span class="params">()</span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;处理支付超时订单：&#123;&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询订单表中的那些订单是超时了，查询需要那些条件呢？？？</span></span><br><span class="line"><span class="comment">     *     1.首先订单状态需要处于“待付款”状态。</span></span><br><span class="line"><span class="comment">     *     2.下单的时间超过了15分钟：下单时间 &lt; 当前时间-15分钟</span></span><br><span class="line"><span class="comment">     *  select * from orders where status = 1 and order_time &lt; 当前时间-15分钟</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *  LocalDateTime.now():当前时间 ，新的时间日期API</span></span><br><span class="line"><span class="comment">     *  plusMinutes(xx)：加xxx分钟</span></span><br><span class="line"><span class="comment">     *  plusMinutes(-15)：加上一个负的就是减15分钟</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">time</span> <span class="operator">=</span> LocalDateTime.now().plusMinutes(-<span class="number">15</span>);<span class="comment">//计算出下单时间</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询到的超时订单集合</span></span><br><span class="line">    List&lt;Orders&gt; ordersList  = orderMapper.getByStatusAndOrdertimeLT(Orders.PENDING_PAYMENT, time);</span><br><span class="line">    <span class="comment">//判断是否或取到超时订单集合</span></span><br><span class="line">    <span class="keyword">if</span>(ordersList != <span class="literal">null</span> &amp;&amp; ordersList.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//遍历订单集合，之后修改每个订单的状态</span></span><br><span class="line">        <span class="keyword">for</span> (Orders orders : ordersList) &#123;  <span class="comment">//快捷键：ordersList.for</span></span><br><span class="line">            orders.setStatus(Orders.CANCELLED); <span class="comment">//订单状态：6已取消</span></span><br><span class="line">            orders.setCancelReason(<span class="string">&quot;支付超时，自动取消&quot;</span>);<span class="comment">//取消原因</span></span><br><span class="line">            orders.setCancelTime(LocalDateTime.now());<span class="comment">//订单取消时间</span></span><br><span class="line">            orderMapper.update(orders); <span class="comment">//之前实现过了</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>完善定时任务类的processDeliveryOrder方法</strong></p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理一直处于“派送中”状态的订单</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Scheduled(cron = &quot;0 0 1 * * ?&quot;)</span><span class="comment">//每天凌晨1点触发一次</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processDeliveryOrder</span><span class="params">()</span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;处理派送中订单：&#123;&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * select * from orders where status = 4 and order_time &lt; 当前时间-1小时</span></span><br><span class="line"><span class="comment">     * 和上面那个方法的业务逻辑相同，只不过是查询的条件不同：</span></span><br><span class="line"><span class="comment">     *    1.首先订单状态需要处于“派送中”状态。</span></span><br><span class="line"><span class="comment">     *    2.查询的时间是上一个工作日的：下单时间 &lt; 当前时间（每天凌晨1点）-1小时</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">time</span> <span class="operator">=</span> LocalDateTime.now().plusMinutes(-<span class="number">60</span>);<span class="comment">//计算出下单时间</span></span><br><span class="line">    <span class="comment">//查询到的超时订单集合</span></span><br><span class="line">    List&lt;Orders&gt; ordersList = orderMapper.getByStatusAndOrdertimeLT(Orders.DELIVERY_IN_PROGRESS, time);</span><br><span class="line">    <span class="comment">//判断是否或取到超时订单集合</span></span><br><span class="line">    <span class="keyword">if</span>(ordersList != <span class="literal">null</span> &amp;&amp; ordersList.size() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">//遍历订单集合，之后修改每个订单的状态</span></span><br><span class="line">        <span class="keyword">for</span> (Orders orders : ordersList) &#123;</span><br><span class="line">            orders.setStatus(Orders.CANCELLED); <span class="comment">//订单状态：5已完成</span></span><br><span class="line">            orderMapper.update(orders); <span class="comment">//之前实现过了</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>在OrderMapper接口中扩展方法</strong></p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据状态和下单时间查询订单</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> status</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderTime</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Select(&quot;select * from orders where status = #&#123;status&#125; and order_time &lt; #&#123;orderTime&#125;&quot;)</span></span><br><span class="line">List&lt;Orders&gt; <span class="title function_">getByStatusAndOrdertimeLT</span><span class="params">(Integer status, LocalDateTime orderTime)</span>;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="14-3-WebSocket">14.3 <strong>WebSocket</strong></h2>
<p>WebSocket 是基于 TCP 的一种新的<strong>网络协议</strong>。它实现了浏览器与服务器全双工通信——浏览器和服务器只需要完成一次握手，两者之间就可以创建<strong>持久性</strong>的连接， 并进行<strong>双向</strong>数据传输。</p>
<p>与传统的 HTTP 请求-响应模型相比，WebSocket 允许在一个单独的连接上进行持续的数据交换，使得实时数据传输变得更加高效。</p>
<p><strong>HTTP协议和WebSocket协议对比：</strong></p>
<ul>
<li>
<p>HTTP是<strong>短连接</strong></p>
</li>
<li>
<p>WebSocket是<strong>长连接</strong></p>
</li>
<li>
<p>HTTP通信是<strong>单向</strong>的，基于请求响应模式（浏览器发送请求给服务器）</p>
</li>
<li>
<p>WebSocket支持<strong>双向</strong>通信</p>
</li>
<li>
<p>HTTP和WebSocket底层都是TCP连接</p>
<p>![[ca3811e78f55f472519c7802e03d9545.png]]</p>
</li>
</ul>
<p><strong>思考</strong>：既然WebSocket支持双向通信，功能看似比HTTP强大，那么我们是不是可以基于WebSocket开发所有的业务功能？</p>
<p><strong>WebSocket缺点：</strong></p>
<p>服务器长期维护长连接需要一定的成本</p>
<p>各个浏览器支持程度不一</p>
<p>WebSocket 是长连接，受网络限制比较大，需要处理好重连</p>
<p><strong>结论</strong>：WebSocket并不能完全取代HTTP，它只适合在特定的场景下使用</p>
<p>使用场景：</p>
<ul>
<li>
<p><strong>实时应用</strong>：如在线聊天应用、股票交易平台、游戏等。</p>
<p>![[ef1bd6907725193964242a99077c9e5f.png]]</p>
<p>![[6f5bc17ec2c0c545d1321ea8ab33ec98.png]]</p>
</li>
<li>
<p><strong>实时数据更新</strong>：如天气预报、体育比赛实时比分等。</p>
<p>![[c688e195249cffbd78d18dcdf99b1663.png]]</p>
</li>
</ul>
<h3 id="14-3-1-入门案例"><strong>14.3.1 入门案例</strong></h3>
<p><strong>需求</strong>：实现浏览器与服务器全双工通信。浏览器既可以向服务器发送消息，服务器也可主动向浏览器推送消息</p>
<p>![[fa5e27c004de7040a4b8b15e67f0c385.png]]</p>
<p><strong>实现步骤：</strong></p>
<ol>
<li>
<p>直接使用websocket.html页面作为WebSocket客户端</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE HTML&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;WebSocket Demo&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;input id=<span class="string">&quot;text&quot;</span> type=<span class="string">&quot;text&quot;</span> /&gt;</span><br><span class="line">    &lt;button onclick=<span class="string">&quot;send()&quot;</span>&gt;发送消息&lt;/button&gt;</span><br><span class="line">    &lt;button onclick=<span class="string">&quot;closeWebSocket()&quot;</span>&gt;关闭连接&lt;/button&gt;</span><br><span class="line">    &lt;div id=<span class="string">&quot;message&quot;</span>&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;script type=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line">    <span class="type">var</span> <span class="variable">websocket</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">var</span> <span class="variable">clientId</span> <span class="operator">=</span> Math.random().toString(<span class="number">36</span>).substr(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断当前浏览器是否支持WebSocket</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&#x27;WebSocket&#x27;</span> in window)&#123;</span><br><span class="line">        <span class="comment">//连接WebSocket节点   注意现在是ws协议</span></span><br><span class="line">        <span class="comment">//这其实就是一个握手的请求，如果请求成功了客户端和服务端就建立了一个长连接</span></span><br><span class="line">        <span class="comment">//   之后就可以双向通信了。</span></span><br><span class="line">        websocket = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">&quot;ws://localhost:8080/ws/&quot;</span>+clientId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        alert(<span class="string">&#x27;Not support websocket&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//连接发生错误的回调方法</span></span><br><span class="line">    websocket.onerror = function()&#123;</span><br><span class="line">        setMessageInnerHTML(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//连接成功建立的回调方法</span></span><br><span class="line">    websocket.onopen = function()&#123;</span><br><span class="line">        setMessageInnerHTML(<span class="string">&quot;连接成功&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//接收到消息的回调方法</span></span><br><span class="line">    websocket.onmessage = function(event)&#123;</span><br><span class="line">        setMessageInnerHTML(event.data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//连接关闭的回调方法</span></span><br><span class="line">    websocket.onclose = function()&#123;</span><br><span class="line">        setMessageInnerHTML(<span class="string">&quot;close&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。</span></span><br><span class="line">    window.onbeforeunload = function()&#123;</span><br><span class="line">        websocket.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将消息显示在网页上</span></span><br><span class="line">    function <span class="title function_">setMessageInnerHTML</span><span class="params">(innerHTML)</span>&#123;</span><br><span class="line">        document.getElementById(<span class="string">&#x27;message&#x27;</span>).innerHTML += innerHTML + <span class="string">&#x27;&lt;br/&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发送消息（客户端向服务端发送消息）</span></span><br><span class="line">    function <span class="title function_">send</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">message</span> <span class="operator">=</span> document.getElementById(<span class="string">&#x27;text&#x27;</span>).value;</span><br><span class="line">        websocket.send(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//关闭连接</span></span><br><span class="line">    function <span class="title function_">closeWebSocket</span><span class="params">()</span> &#123;</span><br><span class="line">        websocket.close();</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>导入WebSocket的maven坐标</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;spring-boot-starter-websocket&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>导入WebSocket服务端组件WebSocketServer，用于和客户端通信</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.websocket;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * WebSocket服务：用于和客户端通信</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="comment">//类似于controller方法中的路径，只不过用的注解不同，对应之前页面上的地址</span></span><br><span class="line"><span class="meta">@ServerEndpoint(&quot;/ws/&#123;sid&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//存放会话对象（客户端和服务端要建立一个连接本质上就是一个会话，建立好会话之后双方之间就可以进行双向通信了）</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Session&gt; sessionMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 连接建立成功调用的方法</span></span><br><span class="line"><span class="comment">     *    这个过程不用我们管而是由websocket这个小框架自己来调，客户端可能有多个所以要区分不同的客户端，</span></span><br><span class="line"><span class="comment">     *    具体是通过sid来区分不同的客户端，sid是页面传递过来的clientId，clientId是页面生成的一个随机数</span></span><br><span class="line"><span class="comment">     *    <span class="doctag">@PathParam</span>：路径参数获取</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@OnOpen</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session, <span class="meta">@PathParam(&quot;sid&quot;)</span> String sid)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;客户端：&quot;</span> + sid + <span class="string">&quot;建立连接&quot;</span>);</span><br><span class="line">        sessionMap.put(sid, session);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 收到客户端消息后调用的方法，类似于controller中的方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 客户端发送过来的消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@OnMessage</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message, <span class="meta">@PathParam(&quot;sid&quot;)</span> String sid)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;收到来自客户端：&quot;</span> + sid + <span class="string">&quot;的信息:&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 连接关闭调用的方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sid</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@OnClose</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">(<span class="meta">@PathParam(&quot;sid&quot;)</span> String sid&#123;</span></span><br><span class="line"><span class="params">        System.out.println(<span class="string">&quot;连接断开:&quot;</span> + sid)</span>;</span><br><span class="line">        sessionMap.remove(sid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 群发：把map中的session都给遍历出来了，这就相当于是群发的一个效果，因为客户端可能有多个，都连接到了这个服务端，现在把这些session都遍历出来 然后都给这些客户端发送消息，这就是一个群发的效果。</span></span><br><span class="line"><span class="comment">     *  注意：这个是普通方法需要自己手动调用</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendToAllClient</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        Collection&lt;Session&gt; sessions = sessionMap.values();</span><br><span class="line">        <span class="comment">//把sessionMap集合中的session都遍历出来</span></span><br><span class="line">        <span class="keyword">for</span> (Session session : sessions) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//服务器向客户端发送消息</span></span><br><span class="line">                session.getBasicRemote().sendText(message);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>导入配置类WebSocketConfiguration，注册WebSocket的服务端组件（让组件生效）</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.websocket;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * WebSocket服务：用于和客户端通信</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="comment">//类似于controller方法中的路径，只不过用的注解不同，对应之前页面上的地址</span></span><br><span class="line"><span class="meta">@ServerEndpoint(&quot;/ws/&#123;sid&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//存放会话对象（客户端和服务端要建立一个连接本质上就是一个会话，建立好会话之后双方之间就可以进行双向通信了）</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Session&gt; sessionMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 连接建立成功调用的方法</span></span><br><span class="line"><span class="comment">     *    这个过程不用我们管而是由websocket这个小框架自己来调，客户端可能有多个所以要区分不同的客户端，</span></span><br><span class="line"><span class="comment">     *    具体是通过sid来区分不同的客户端，sid是页面传递过来的clientId，clientId是页面生成的一个随机数</span></span><br><span class="line"><span class="comment">     *    <span class="doctag">@PathParam</span>：路径参数获取</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@OnOpen</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session, <span class="meta">@PathParam(&quot;sid&quot;)</span> String sid)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;客户端：&quot;</span> + sid + <span class="string">&quot;建立连接&quot;</span>);</span><br><span class="line">        sessionMap.put(sid, session);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 收到客户端消息后调用的方法，类似于controller中的方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 客户端发送过来的消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@OnMessage</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message, <span class="meta">@PathParam(&quot;sid&quot;)</span> String sid)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;收到来自客户端：&quot;</span> + sid + <span class="string">&quot;的信息:&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 连接关闭调用的方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sid</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@OnClose</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">(<span class="meta">@PathParam(&quot;sid&quot;)</span> String sid)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;连接断开:&quot;</span> + sid);</span><br><span class="line">        sessionMap.remove(sid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 群发：把map中的session都给遍历出来了，这就相当于是群发的一个效果，因为客户端可能</span></span><br><span class="line"><span class="comment">     *      有多个，都连接到了这个服务端，现在把这些session都遍历出来 然后都给这些</span></span><br><span class="line"><span class="comment">     *      客户端发送消息，这就是一个群发的效果。</span></span><br><span class="line"><span class="comment">     *  注意：这个是普通方法需要自己手动调用</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendToAllClient</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        Collection&lt;Session&gt; sessions = sessionMap.values();</span><br><span class="line">        <span class="comment">//把sessionMap集合中的session都遍历出来</span></span><br><span class="line">        <span class="keyword">for</span> (Session session : sessions) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//服务器向客户端发送消息</span></span><br><span class="line">                session.getBasicRemote().sendText(message);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>导入定时任务类WebSocketTask，定时向客户端推送数据</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.task;</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketTask</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WebSocketServer webSocketServer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过WebSocket每隔5秒向客户端发送消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0/5 * * * * ?&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessageToClient</span><span class="params">()</span> &#123;</span><br><span class="line">	    <span class="comment">//调用WebSocketServer类中群发的方法</span></span><br><span class="line">        webSocketServer.sendToAllClient(<span class="string">&quot;这是来自服务端的消息：&quot;</span> + DateTimeFormatter.ofPattern(<span class="string">&quot;HH:mm:ss&quot;</span>).format(LocalDateTime.now()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>说明：websocket这一块主要是了解程序的执行流程，具体的代码并不作为重点，所以说入门案例相对比较简单这里直接导入课前资料中的代码即可。</p>
<p><strong>测试：</strong></p>
<p>启动服务，打开websocket.html页面</p>
<p><strong>浏览器向服务器发送数据：</strong></p>
<p><a target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/3e29f58d3d2ecee4d0cdb9734fd15b73.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/3e29f58d3d2ecee4d0cdb9734fd15b73.png" alt=""></a></p>
<p><strong>服务器向浏览器间隔5秒推送数据：</strong></p>
<p><a target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/c3bf6bd4957cfb46958f58537ba527f8.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/c3bf6bd4957cfb46958f58537ba527f8.png" alt=""></a></p>
<h2 id="14-4-来单提醒（WebSocket的应用）"><strong>14.4 来单提醒（WebSocket的应用）</strong></h2>
<p>用户下单并且支付成功后，需要第一时间通知外卖商家。通知的形式有如下两种：</p>
<ul>
<li>
<p>语音播报</p>
<p><a target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/4845eded7acb1997db75140fb403a1c4.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/4845eded7acb1997db75140fb403a1c4.png" alt=""></a></p>
</li>
<li>
<p>弹出提示框</p>
<p>![[c0a90c9f75c76014df5f4aac65573419.png]]</p>
</li>
</ul>
<p><strong>设计思路：</strong></p>
<ul>
<li>通过WebSocket实现管理端页面和服务端保持长连接状态</li>
<li>当客户支付后，调用WebSocket的相关API实现服务端向客户端推送消息</li>
<li>客户端浏览器解析服务端推送的消息，判断是 来单提醒 还是 客户催单，进行相应的消息提示和语音播报</li>
<li>约定服务端发送给客户端浏览器的数据格式为JSON，字段包括：type，orderId，content
<ul>
<li>type 为消息类型，1为来单提醒 2为客户催单</li>
<li>orderId 为订单id
<ul>
<li>不管是来单提醒还是客户催单，那这一次提醒实际上都对应一个订单，是你下了某个单之后或者是你催促某个订单，这个时候他才会给你相应的提醒，具体你提醒的是哪个订单呢，所以需要把这个订单id给提交过来。</li>
</ul>
</li>
<li>content 为消息内容
<ul>
<li>提示框显示的内容</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>实现：</p>
<ol>
<li>
<p>使用入门案例中的WebSocketServer组件和配置类，通过这个组件和和客户端进行通信的</p>
<p>![[6705d47e318b7521834fe26942c4fce8.png]]</p>
<p>![[1ae4e286c5cb1565515761e4a1f0138a.png]]</p>
<p>![[/image 7 26.png|image 7 26.png]]</p>
<p>问题：这次请求的url地址（<code>ws://localhost/ws/nhxkyfec7m</code>）并没有写<code>8080</code>(tomact服务器端口号)，那么它是如何请求到后台的tomact服务器呢？？？<br>
答：先请求到nginx，然后在通过nginx反向代理转发到后端tomact服务器。</p>
<p>![[/image 8 23.png|image 8 23.png]]</p>
<p>![[/image 9 22.png|image 9 22.png]]</p>
</li>
<li>
<p>前端代码已经提供好了，里面已经写好WebSocketServer的客户端代码，说白了就是一些js代码。</p>
</li>
</ol>
<p>用户<strong>下单并且支付成功</strong>之后基于WebSocketServer向客户端推送消息，我们在WebSocketServer中已经创建好了群发的方法，所以只需要调用这个群发的方法即可。</p>
<p>![[0dcc7cf0e7c580aa79c49a600a162081.png]]</p>
<p><strong>在OrderServiceImpl中注入WebSocketServer对象，修改paySuccess方法，加入如下代码：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> WebSocketServer webSocketServer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 支付成功，修改订单状态</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> outTradeNo</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">paySuccess</span><span class="params">(String outTradeNo)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据订单号查询订单</span></span><br><span class="line">    <span class="type">Orders</span> <span class="variable">ordersDB</span> <span class="operator">=</span> orderMapper.getByNumber(outTradeNo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据订单id更新订单的状态、支付方式、支付状态、结账时间</span></span><br><span class="line">    <span class="type">Orders</span> <span class="variable">orders</span> <span class="operator">=</span> Orders.builder()</span><br><span class="line">            .id(ordersDB.getId())</span><br><span class="line">            .status(Orders.TO_BE_CONFIRMED)</span><br><span class="line">            .payStatus(Orders.PAID)</span><br><span class="line">            .checkoutTime(LocalDateTime.now())</span><br><span class="line">            .build();</span><br><span class="line">    orderMapper.update(orders);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通过webSocketServer向客户端浏览器推送消息</span></span><br><span class="line">    <span class="comment">//要求推送的消息格式是json类型，并且包含3个字段（type、orderId、content）</span></span><br><span class="line">    <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    map.put(<span class="string">&quot;type&quot;</span>, <span class="number">1</span>);<span class="comment">//消息类型，1表示来单提醒</span></span><br><span class="line">    map.put(<span class="string">&quot;orderId&quot;</span>, orders.getId()); <span class="comment">//订单的id</span></span><br><span class="line">    map.put(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;订单号：&quot;</span> + outTradeNo);<span class="comment">//订单号</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//转化为json格式</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> JSON.toJSONString(map);</span><br><span class="line">    <span class="comment">//通过WebSocket实现来单提醒，向客户端浏览器推送消息(调用WebSocketServer类中群发的方法)</span></span><br><span class="line">    webSocketServer.sendToAllClient(json);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为之前跳过了支付功能（没有商户号），自己写了一个新的更新功能（点击支付后），所以这部分代码写在自己写的更新功能之后。</p>
<p>![[85cf7f350dfc7171e540e21c3dbb6460.png]]</p>
<p>只提示没有声音设置</p>
<p>![[c280a95927d4dbb8e82122f7d16a25b0.png]]</p>
<h2 id="14-5-客户催单（WebSocket的应用）">14.5 <strong>客户催单（WebSocket的应用）</strong></h2>
<p><strong>设计思路：</strong></p>
<ul>
<li>
<p>通过WebSocket实现管理端页面和服务端保持长连接状态</p>
</li>
<li>
<p>当用户点击催单按钮后，调用WebSocket的相关API实现服务端向客户端推送消息</p>
</li>
<li>
<p>客户端浏览器解析服务端推送的消息，判断是来单提醒还是客户催单，进行相应的消息提示和语音播报</p>
<p>约定服务端发送给客户端浏览器的数据格式为JSON，字段包括：type，orderId，content</p>
<ul>
<li>type 为消息类型，1为来单提醒 2为客户催单</li>
<li>orderId 为订单id</li>
<li>content 为消息内容</li>
</ul>
</li>
</ul>
<p>客户催单和来电提醒的区别</p>
<ul>
<li>来电提醒的消息类型为<code>来电提醒</code>，客户催单的消息类型为<code>客户催单</code></li>
<li>客户催单是由客户点击催单按钮主动触发的，所以这个地方会涉及到一个接口，用户点击催单按钮后，它会发起一次请求 请求这个服务端。</li>
</ul>
<p>催单催的是哪一个订单，所以需要把这个订单的标识（订单的id）作为参数传递进来</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户催单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/reminder/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;用户催单&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">reminder</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">    orderService.reminder(id);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户催单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reminder</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">// 根据id查询订单</span></span><br><span class="line">    <span class="type">Orders</span> <span class="variable">ordersDB</span> <span class="operator">=</span> orderMapper.getById(id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 校验订单是否存在</span></span><br><span class="line">    <span class="keyword">if</span> (ordersDB == <span class="literal">null</span> ) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OrderBusinessException</span>(MessageConstant.ORDER_STATUS_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//基于WebSocket实现催单</span></span><br><span class="line">    <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    map.put(<span class="string">&quot;type&quot;</span>, <span class="number">2</span>);<span class="comment">//1表示来电提醒 2代表用户催单</span></span><br><span class="line">    map.put(<span class="string">&quot;orderId&quot;</span>, id);<span class="comment">//订单的id</span></span><br><span class="line">    map.put(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;订单号：&quot;</span> + ordersDB.getNumber());<span class="comment">//订单号</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//参数需要json类型，所以需要进行转化(调用WebSocketServer组件中群发的方法)</span></span><br><span class="line">    webSocketServer.sendToAllClient(JSON.toJSONString(map));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1>十五、<strong>Apache ECharts，营业额统计，用户统计，订单统计，销量排名Top10</strong></h1>
<h2 id="15-1-Apache-ECharts（前端技术）">15.1 <strong>Apache ECharts（前端技术）</strong></h2>
<p>![[4e07ca1da81bf66d3afed8db98c908bc.png]]</p>
<p>Apache ECharts 是一款基于 Javascript 的<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96&amp;spm=1001.2101.3001.7020">数据可视化</a>图表库，提供直观，生动，可交互，可个性化定制的数据可视化图表。</p>
<p><a target="_blank" rel="noopener" href="https://echarts.apache.org/zh/index.html">https://echarts.apache.org/zh/index.html</a></p>
<h3 id="15-1-1-入门案例">15.1.1 入门案例</h3>
<p>Apache Echarts官方提供的快速入门：<code>https://echarts.apache.org/handbook/zh/get-started/</code></p>
<p>![[5180e044d7f14804cead90ed3b06e7fa.png]]</p>
<p><strong>实现步骤：</strong></p>
<p>1). 引入echarts.js 文件（官方文件，我下载保存在&quot;D:\86159\javaweb\delivery-resources\cangqiong\echarts.js”）</p>
<p>2). 为 ECharts 准备一个设置宽高的 DOM，一般是div</p>
<p>3). 初始化echarts实例</p>
<p>4). 指定图表的配置项和数据</p>
<p>5). 使用指定的配置项和数据显示图表</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;utf-8&quot;</span> /&gt;</span><br><span class="line">    &lt;title&gt;ECharts&lt;/title&gt;</span><br><span class="line">    &lt;!-- <span class="number">1.</span>引入刚刚下载的 ECharts 文件 --&gt;</span><br><span class="line">    &lt;script src=<span class="string">&quot;echarts.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;!-- <span class="number">2.</span>为 ECharts 准备一个定义了宽高的 DOM，用来展示图标的区域 --&gt;</span><br><span class="line">    &lt;div id=<span class="string">&quot;main&quot;</span> style=<span class="string">&quot;width: 600px;height:400px;&quot;</span>&gt;&lt;/div&gt;</span><br><span class="line">    &lt;script type=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line">        <span class="comment">// 基于准备好的dom，初始化echarts（图标）实例</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">myChart</span> <span class="operator">=</span> echarts.init(document.getElementById(<span class="string">&#x27;main&#x27;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.指定图表的配置项和数据</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">option</span> <span class="operator">=</span> &#123;</span><br><span class="line">            title: &#123; <span class="comment">//标题</span></span><br><span class="line">                text: <span class="string">&#x27;ECharts 入门示例&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            tooltip: &#123;</span><br><span class="line">                trigger: <span class="string">&#x27;axis&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            legend: &#123; <span class="comment">//图例</span></span><br><span class="line">                data: [<span class="string">&#x27;销量&#x27;</span>]</span><br><span class="line">            &#125;,</span><br><span class="line">            xAxis: &#123;<span class="comment">//x轴横坐标展示的区域</span></span><br><span class="line">                type: <span class="string">&#x27;category&#x27;</span>,</span><br><span class="line">                data: [<span class="string">&#x27;衬衫&#x27;</span>, <span class="string">&#x27;羊毛衫&#x27;</span>, <span class="string">&#x27;雪纺衫&#x27;</span>, <span class="string">&#x27;裤子&#x27;</span>, <span class="string">&#x27;高跟鞋&#x27;</span>, <span class="string">&#x27;袜子&#x27;</span>]</span><br><span class="line">            &#125;,</span><br><span class="line">            yAxis: &#123;</span><br><span class="line">                type: <span class="string">&#x27;value&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            series: [</span><br><span class="line">                &#123;</span><br><span class="line">                    name: <span class="string">&#x27;销量&#x27;</span>,</span><br><span class="line">                    type: <span class="string">&#x27;bar&#x27;</span>,<span class="comment">//代表柱状图</span></span><br><span class="line">                    <span class="comment">//4.纵坐标展示的数据，每个数字对应上面横坐标响应的一个配置项</span></span><br><span class="line">                    data: [<span class="number">5</span>, <span class="number">20</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">20</span>]</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5.使用刚指定的配置项和数据显示图表。</span></span><br><span class="line">        myChart.setOption(option);</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<ol>
<li><code>tooltip</code>
<ul>
<li><code>**trigger: 'axis'**</code>：设置提示框的触发方式为 “axis”，表示当鼠标悬停在 X 轴或 Y 轴上的数据点时，会显示对应的所有系列的提示信息。</li>
</ul>
</li>
<li><code>legend</code>
<ul>
<li><code>**data: ['销售量']**</code>：定义图例的内容，这里只有一个系列 “销售量”。图例用于标识图表中各数据系列的名称，用户可以通过点击图例来控制某些数据系列的显示或隐藏。</li>
</ul>
</li>
<li><code>xAxis</code>
<ul>
<li><code>**type: 'category'**</code>：设置 X 轴为类目轴，适用于离散的、分类的数据。</li>
</ul>
</li>
<li><code>yAxis</code>
<ul>
<li><code>**type: 'value'**</code>：设置 Y 轴为数值轴，适用于连续的数值数据。</li>
</ul>
</li>
<li><code>series</code>
<ul>
<li><code>**series: [&#123; ... &#125;]**</code>：定义图表的数据系列。
<ul>
<li><code>**name: '销售量'**</code>：系列的名称。</li>
<li><code>**type: 'line'**</code>：设置图表类型为折线图。</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>使用Echarts，重点在于研究当前图表所需的 <code>**数据格式**</code>。通常是需要后端提供符合格式要求的动态数据，然后响应给前端来展示图表。</p>
<p>说明：入门案例中的数据没有和前端进行交互，这些数据是直接写死在页面中的，真实的项目中这些数据，都是后端查询数据库返回给前端动态获取的。</p>
<h2 id="15-2-营业额统计">15.2 营业额统计</h2>
<p>营业额统计是基于折现图来展现，并且按照天来展示的。实际上，就是某一个时间范围之内的每一天的营业额。同时，不管光标放在哪个点上，那么它就会把具体的数值展示出来。并且还需要注意日期并不是固定写死的，是由上边时间选择器来决定。比如选择是近7天、或者是近30日，或者是本周，就会把相应这个时间段之内的每一天日期通过横坐标展示。</p>
<p>![[3e181e421c14a6eb91cdf89d0bd9b281.png]]</p>
<p><strong>业务规则：</strong></p>
<ul>
<li>营业额指订单状态为已完成的订单金额合计</li>
<li>基于可视化报表的折线图展示营业额数据，X轴为日期，Y轴为营业额</li>
<li>根据时间选择区间，展示每天的营业额数据</li>
</ul>
<p>![[2d51ee4d1eaa9b54456a5e572c60f1ef.png]]</p>
<p><strong>注意</strong>：具体返回数据一般由前端来决定，前端展示图表，具体折现图对应数据是什么格式，是有固定的要求的。所以说，后端需要去适应前端，它需要什么格式的数据，我们就给它返回什么格式的数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">TurnoverReportVO.java</span><br><span class="line"><span class="keyword">package</span> com.sky.vo;</span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TurnoverReportVO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="comment">//日期，以逗号分隔，例如：2022-10-01,2022-10-02,2022-10-03</span></span><br><span class="line">    <span class="keyword">private</span> String dateList;</span><br><span class="line">    <span class="comment">//营业额，以逗号分隔，例如：406.0,1520.0,75.0</span></span><br><span class="line">    <span class="keyword">private</span> String turnoverList;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@GetMapping(&quot;/turnoverStatistics&quot;)</span></span><br><span class="line">	<span class="meta">@ApiOperation(&quot;营业额数据统计&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> Result&lt;TurnoverReportVO&gt; <span class="title function_">turnoverStatistics</span><span class="params">(</span></span><br><span class="line"><span class="params">			<span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span></span></span><br><span class="line"><span class="params">			LocalDate begin,</span></span><br><span class="line"><span class="params">			<span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span></span></span><br><span class="line"><span class="params">			LocalDate end</span></span><br><span class="line"><span class="params">	)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> Result.success(reportService.getTurnover(begin, end));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.sky.service.impl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReportServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">ReportService</span> &#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> ReportMapper reportMapper;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> OrderMapper orderMapper;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 统计指定时间区间内的营业额数据：查询的是订单表，状态已经完成的订单</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> begin</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> end</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> TurnoverReportVO <span class="title function_">getTurnover</span><span class="params">(LocalDate begin, LocalDate end)</span> &#123;</span><br><span class="line">		<span class="comment">// 1. 日期：当前集合用于存放从begin到end范围内每天的日期</span></span><br><span class="line">		List&lt;LocalDate&gt; dateList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">		dateList.add(begin);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">while</span> (!begin.equals(end)) &#123;</span><br><span class="line">			begin = begin.plusDays(<span class="number">1</span>); <span class="comment">// 获取指定日期后一天的日期</span></span><br><span class="line">			dateList.add(begin);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 现在是list类型而vo类中的dateList要求是String类型，所以需要进行转化</span></span><br><span class="line">		<span class="comment">// 把list集合的每个元素取出来并且以逗号分隔，最终拼成一个字符串</span></span><br><span class="line">		<span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> StringUtils.join(dateList, <span class="string">&quot;,&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 2. 营业额：是和日期一一对应的</span></span><br><span class="line">		<span class="comment">// 所以需要遍历获取每天的日期，然后查询数据库把每天的营业额查出来，中间用逗号隔开</span></span><br><span class="line">		<span class="comment">// 当前集合存放每天营业额</span></span><br><span class="line">		ArrayList&lt;Double&gt; turnoverList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (LocalDate date : dateList) &#123;</span><br><span class="line">			<span class="comment">// 查询data日期对应的营业额数据，营业额是指：状态为“已完成”的订单金额合计</span></span><br><span class="line">			<span class="comment">// 获取的date（每日）只含有年月日没有体现时分秒，而这个order_time下单时间是</span></span><br><span class="line">			<span class="comment">//      LocalDateTime类型，既有年月日又有时分秒，所以要查询date这一天的</span></span><br><span class="line">			<span class="comment">//      订单就需要来计算这一天的起始时间是从什么时刻开始（当天的0时0分0秒），</span></span><br><span class="line">			<span class="comment">//      这一天的结束时间是从什么时候结束（11:59:59，无限接近下一天的0时0分0秒）。</span></span><br><span class="line">			<span class="type">LocalDateTime</span> <span class="variable">beginTime</span> <span class="operator">=</span> LocalDateTime.of(date, LocalTime.MIN);<span class="comment">// 获取当天的开始时间：年月日时分秒</span></span><br><span class="line">			<span class="type">LocalDateTime</span> <span class="variable">endTime</span> <span class="operator">=</span> LocalDateTime.of(date, LocalTime.MAX);<span class="comment">// 获取当天的结束时间：年月日时分秒（无限接近于下一天的0时0分0秒）</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">// select sum(amount) from orders where order_time &gt; ? and order_time &lt; ? and status = 5;</span></span><br><span class="line">			<span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();<span class="comment">// 封装sql所需要的参数为一个map集合</span></span><br><span class="line">			map.put(<span class="string">&quot;begin&quot;</span>, beginTime);</span><br><span class="line">			map.put(<span class="string">&quot;end&quot;</span>, endTime);</span><br><span class="line">			map.put(<span class="string">&quot;status&quot;</span>, Orders.COMPLETED);<span class="comment">// 已完成</span></span><br><span class="line">			<span class="type">Double</span> <span class="variable">turnover</span> <span class="operator">=</span> orderMapper.sumByMap(map);<span class="comment">// 计算出来的营业额</span></span><br><span class="line">			<span class="comment">// 假设这一天一个订单都没有，那么营业额应该是0.0才对，而这里查询出的来营业额</span></span><br><span class="line">			<span class="comment">//   为空显然不合理，所以如果返回为空的时候需要把它转化为0.0。</span></span><br><span class="line">			turnover = turnover == <span class="literal">null</span> ? <span class="number">0.0</span> : turnover;</span><br><span class="line">			turnoverList.add(turnover);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//同样需要把集合类型转化为字符串类型并用逗号分隔</span></span><br><span class="line">		<span class="type">String</span> <span class="variable">turnovre</span> <span class="operator">=</span> StringUtils.join(turnoverList, <span class="string">&quot;,&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 构建VO对象</span></span><br><span class="line">		<span class="type">TurnoverReportVO</span> <span class="variable">trvo</span> <span class="operator">=</span> TurnoverReportVO.builder()</span><br><span class="line">				.dateList(data)</span><br><span class="line">				.turnoverList(turnovre)</span><br><span class="line">				.build();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> trvo;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;select id=<span class="string">&quot;sumByMap&quot;</span> resultType=<span class="string">&quot;java.lang.Double&quot;</span>&gt;</span><br><span class="line">        select <span class="title function_">sum</span><span class="params">(amount)</span> from orders</span><br><span class="line">        &lt;where&gt;</span><br><span class="line">            &lt;<span class="keyword">if</span> test=<span class="string">&quot;status != null&quot;</span>&gt;</span><br><span class="line">                <span class="type">and</span> <span class="variable">status</span> <span class="operator">=</span> #&#123;status&#125;</span><br><span class="line">            &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">            &lt;<span class="keyword">if</span> test=<span class="string">&quot;begin != null&quot;</span>&gt;</span><br><span class="line">                and order_time &amp;gt;= #&#123;begin&#125;</span><br><span class="line">            &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">            &lt;<span class="keyword">if</span> test=<span class="string">&quot;end != null&quot;</span>&gt;</span><br><span class="line">                and order_time &amp;lt;= #&#123;end&#125;</span><br><span class="line">            &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">        &lt;/where&gt;</span><br><span class="line">    &lt;/select&gt;</span><br></pre></td></tr></table></figure>
<h2 id="15-3-用户统计">15.3 <strong>用户统计</strong></h2>
<p>统计的是用户的数量。通过折线图来展示，上面这根蓝色线代表的是用户总量，下边这根绿色线代表的是新增用户数量，是具体到每一天。所以说用户统计主要统计<strong>两个数据</strong>，一个是<strong>总的用户数量</strong>，另外一个是<strong>新增用户数量</strong>。</p>
<p>![[1ee9be4a04ca948f0822eb7613ab7be2.png]]</p>
<p><strong>业务规则：</strong></p>
<ul>
<li>基于可视化报表的折线图展示用户数据，X轴为日期，Y轴为用户数</li>
<li>根据时间选择区间，展示每天的用户总量和新增用户量数据</li>
</ul>
<p>![[02b7aa4b83eff0a371091e619096c7bf.png]]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">UserReportVO.java</span><br><span class="line"><span class="keyword">package</span> com.sky.vo;</span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserReportVO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="comment">//日期，以逗号分隔，例如：2022-10-01,2022-10-02,2022-10-03</span></span><br><span class="line">    <span class="keyword">private</span> String dateList;</span><br><span class="line">    <span class="comment">//用户总量，以逗号分隔，例如：200,210,220</span></span><br><span class="line">    <span class="keyword">private</span> String totalUserList;</span><br><span class="line">    <span class="comment">//新增用户，以逗号分隔，例如：20,21,10</span></span><br><span class="line">    <span class="keyword">private</span> String newUserList;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@GetMapping(&quot;/userStatistics&quot;)</span></span><br><span class="line">	<span class="meta">@ApiOperation(&quot;用户数据统计&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> Result&lt;UserReportVO&gt; <span class="title function_">userStatistics</span><span class="params">(</span></span><br><span class="line"><span class="params">			<span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> LocalDate begin,</span></span><br><span class="line"><span class="params">			<span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> LocalDate end)</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> Result.success(reportService.getUserStatistics(begin, end));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Integer <span class="title function_">getUserCount</span><span class="params">(LocalDateTime beginTime, LocalDateTime endTime)</span> &#123;</span><br><span class="line">		<span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">		map.put(<span class="string">&quot;begin&quot;</span>, beginTime);</span><br><span class="line">		map.put(<span class="string">&quot;end&quot;</span>, endTime);</span><br><span class="line">		<span class="keyword">return</span> userMapper.countByMap(map);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	  &lt;select id=<span class="string">&quot;countByMap&quot;</span> resultType=<span class="string">&quot;java.lang.Integer&quot;</span>&gt;</span><br><span class="line">        select <span class="title function_">count</span><span class="params">(id)</span> from user</span><br><span class="line">        &lt;where&gt;</span><br><span class="line">            &lt;<span class="keyword">if</span> test=<span class="string">&quot;begin != null&quot;</span>&gt;</span><br><span class="line">                and create_time &amp;gt;= #&#123;begin&#125;</span><br><span class="line">            &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">            &lt;<span class="keyword">if</span> test=<span class="string">&quot;end != null&quot;</span>&gt;</span><br><span class="line">                and create_time &amp;lt;= #&#123;end&#125;</span><br><span class="line">            &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">        &lt;/where&gt;</span><br><span class="line">    &lt;/select&gt;</span><br></pre></td></tr></table></figure>
<h2 id="15-4-订单统计">15.4 <strong>订单统计</strong></h2>
<p>订单统计通过一个折现图来展现，折线图上有两根线，这根蓝色的线代表的是<strong>订单总数</strong>，而下边这根绿色的线代表的是<strong>有效订单数</strong>，指的就是状态是<strong>已完成的订单</strong>就属于有效订单，分别反映的是<strong>每一天的数据</strong>。上面还有3个数字，分别是订单总数、有效订单、订单完成率，它指的是<strong>整个时间区间之内总的数据</strong>。</p>
<p>![[7064067dfb9fc89f54e686451085ab44.png]]</p>
<p><strong>业务规则：</strong></p>
<ul>
<li>有效订单指状态为 “已完成” 的订单</li>
<li>基于可视化报表的折线图展示订单数据，X轴为日期，Y轴为订单数量</li>
<li>根据时间选择区间，展示每天的订单总数和有效订单数</li>
<li>展示所选时间区间内的有效订单数、总订单数、订单完成率，订单完成率 = 有效订单数 / 总订单数 * 100%</li>
</ul>
<p>![[297c357761facff4635b935d06693ef9.png]]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">OrderReportVO.java</span><br><span class="line"><span class="keyword">package</span> com.sky.vo;</span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderReportVO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="comment">//日期，以逗号分隔，例如：2022-10-01,2022-10-02,2022-10-03</span></span><br><span class="line">    <span class="keyword">private</span> String dateList;</span><br><span class="line">    <span class="comment">//每日订单数，以逗号分隔，例如：260,210,215</span></span><br><span class="line">    <span class="keyword">private</span> String orderCountList;</span><br><span class="line">    <span class="comment">//每日有效订单数，以逗号分隔，例如：20,21,10</span></span><br><span class="line">    <span class="keyword">private</span> String validOrderCountList;</span><br><span class="line">    <span class="comment">//订单总数</span></span><br><span class="line">    <span class="keyword">private</span> Integer totalOrderCount;</span><br><span class="line">    <span class="comment">//有效订单数</span></span><br><span class="line">    <span class="keyword">private</span> Integer validOrderCount;</span><br><span class="line">    <span class="comment">//订单完成率</span></span><br><span class="line">    <span class="keyword">private</span> Double orderCompletionRate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> OrderReportVO <span class="title function_">getOrderStatistics</span><span class="params">(LocalDate begin, LocalDate end)</span> &#123;</span><br><span class="line">		<span class="comment">// 1. 日期</span></span><br><span class="line">		List&lt;LocalDate&gt; dateList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">		dateList.add(begin);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">while</span> (!begin.equals(end)) &#123;</span><br><span class="line">			begin = begin.plusDays(<span class="number">1</span>);</span><br><span class="line">			dateList.add(begin);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> StringUtils.join(dateList, <span class="string">&quot;,&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 每一天的订单数量：订单总数，有效订单数</span></span><br><span class="line">		<span class="comment">// 每天订单总数集合</span></span><br><span class="line">		ArrayList&lt;Integer&gt; orderCountList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">		<span class="comment">// 每天有效订单数集合</span></span><br><span class="line">		ArrayList&lt;Integer&gt; validOrderCountList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * 思路分析：查询的是订单表</span></span><br><span class="line"><span class="comment">		 * 查询每天的总订单数：只需要根据下单时间计算出当天的起始时间和结束时间作为查询条件，</span></span><br><span class="line"><span class="comment">		 *                 就是当天的总订单数。</span></span><br><span class="line"><span class="comment">		 * 查询每天的有效订单数：根据下单时间计算出当天的起始时间和结束时间以及状态已完成（代表有效订单）的订单作为查询条件，</span></span><br><span class="line"><span class="comment">		 *                   就是每天的有效订单数</span></span><br><span class="line"><span class="comment">		 * 同样没必要写2个sql，因为这2个SQL的主体结构相同，只是查询的条件不同，所以没有必要写2个sql只需要写一个动态的sql即可。</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">for</span> (LocalDate date : dateList) &#123;</span><br><span class="line">			<span class="type">LocalDateTime</span> <span class="variable">beginTime</span> <span class="operator">=</span> LocalDateTime.of(date, LocalTime.MIN);</span><br><span class="line">			<span class="type">LocalDateTime</span> <span class="variable">endTime</span> <span class="operator">=</span> LocalDateTime.of(date, LocalTime.MAX);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 查询每天的总订单数 select count(id) from orders where order_time &gt; ? and order_time &lt; ?</span></span><br><span class="line">			<span class="type">Integer</span> <span class="variable">orderCount</span> <span class="operator">=</span> getOrderCount(beginTime, endTime, <span class="literal">null</span>);</span><br><span class="line">			<span class="comment">// 查询每天的有效订单数 select count(id) from orders where order_time &gt; ? and order_time &lt; ? and status = ?</span></span><br><span class="line">			<span class="type">Integer</span> <span class="variable">validOrderCount</span> <span class="operator">=</span> getOrderCount(beginTime, endTime, Orders.COMPLETED);</span><br><span class="line"></span><br><span class="line">			orderCountList.add(orderCount);</span><br><span class="line">			validOrderCountList.add(validOrderCount);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">String</span> <span class="variable">orderCount1</span> <span class="operator">=</span> StringUtils.join(orderCountList, <span class="string">&quot;,&quot;</span>);</span><br><span class="line">		<span class="type">String</span> <span class="variable">validOrderCount1</span> <span class="operator">=</span> StringUtils.join(validOrderCountList, <span class="string">&quot;,&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * 3. 准备时间区间内的订单数：时间区间内的总订单数，时间区间内的总有效订单数</span></span><br><span class="line"><span class="comment">		 * 思路分析：</span></span><br><span class="line"><span class="comment">		 *    订单总数：整个这个时间区域内订单总的数量，根据这个时间去卡查询数据库可以查询出来。</span></span><br><span class="line"><span class="comment">		 *    时间区间内的总有效订单数：也可以通过查询数据库查出来。</span></span><br><span class="line"><span class="comment">		 *    实际上不查询数据库，总订单数和总有效订单数也能计算出来：</span></span><br><span class="line"><span class="comment">		 *         因为上面2个集合中已经查询保存了，这个时间段之内每天的总订单数和总有效订单数，</span></span><br><span class="line"><span class="comment">		 *         所以只需要分别遍历这2个集合，每天的订单总数加一起就是整个时间段总订单数，</span></span><br><span class="line"><span class="comment">		 *         每天的有效订单数加起来就是整个时间段的总有效订单数。</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="comment">// 计算时间区域内的总订单数量</span></span><br><span class="line">		<span class="type">Integer</span> <span class="variable">totalOrderCounts</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">		<span class="comment">// 法一：</span></span><br><span class="line">		<span class="comment">// totalOrderCounts = orderCountList.stream().reduce(Integer::sum).get();</span></span><br><span class="line">		<span class="comment">// 法二：</span></span><br><span class="line">		<span class="keyword">for</span> (Integer integer : orderCountList) &#123;</span><br><span class="line">			totalOrderCounts += integer;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 计算时间区域内的总有效订单数量</span></span><br><span class="line">		<span class="type">Integer</span> <span class="variable">validOrderCounts</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">		<span class="comment">// 法一：</span></span><br><span class="line">		validOrderCounts = validOrderCountList.stream().reduce(Integer::sum).get();</span><br><span class="line">		<span class="comment">// 法二：</span></span><br><span class="line">		<span class="comment">/*for (Integer integer : validOrderCountList) &#123;</span></span><br><span class="line"><span class="comment">			validOrderCounts += integer;</span></span><br><span class="line"><span class="comment">		&#125;*/</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// 4.订单完成率：  总有效订单数量/总订单数量=订单完成率</span></span><br><span class="line">		<span class="type">Double</span> <span class="variable">orderCompletionRate</span> <span class="operator">=</span> <span class="number">0.0</span>;  <span class="comment">// 订单完成率的初始值</span></span><br><span class="line">		<span class="keyword">if</span> (totalOrderCounts != <span class="number">0</span>) &#123;</span><br><span class="line">			orderCompletionRate = validOrderCounts.doubleValue() / totalOrderCounts; <span class="comment">// 注意：Double.valueOf和(double)会导致精度缺失</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 构造VO对象</span></span><br><span class="line">		<span class="keyword">return</span> OrderReportVO.builder()</span><br><span class="line">				.dateList(data)  <span class="comment">// x轴日期数据</span></span><br><span class="line">				.orderCountList(orderCount1) <span class="comment">// y轴每天订单总数</span></span><br><span class="line">				.validOrderCountList(validOrderCount1)<span class="comment">// y轴每天有效订单总数</span></span><br><span class="line">				.totalOrderCount(totalOrderCounts) <span class="comment">// 时间区域内总订单数</span></span><br><span class="line">				.validOrderCount(validOrderCounts) <span class="comment">// 时间区域内总有效订单数</span></span><br><span class="line">				.orderCompletionRate(orderCompletionRate) <span class="comment">// 订单完成率</span></span><br><span class="line">				.build();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 根据时间区间统计指定状态的订单数量</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> beginTime</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> endTime</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> status</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> Integer <span class="title function_">getOrderCount</span><span class="params">(LocalDateTime beginTime, LocalDateTime endTime, Integer status)</span> &#123;</span><br><span class="line">		<span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">		map.put(<span class="string">&quot;begin&quot;</span>, beginTime);</span><br><span class="line">		map.put(<span class="string">&quot;end&quot;</span>, endTime);</span><br><span class="line">		map.put(<span class="string">&quot;status&quot;</span>, status);</span><br><span class="line">		<span class="keyword">return</span> orderMapper.countByMap(map);</span><br><span class="line">	&#125;</span><br><span class="line">xml和controller省</span><br></pre></td></tr></table></figure>
<h2 id="15-5-销量排名Top10">15.5 <strong>销量排名Top10</strong></h2>
<p>销量指的是商品销售的数量。项目当中的商品主要包含两类：一个是<strong>套餐</strong>，一个是<strong>菜品</strong>，所以销量排名其实指的就是菜品和套餐销售的数量排名。通过柱形图来展示销量排名，这些销量是按照降序来排列，并且只需要统计销量排名前十的商品。</p>
<p>![[9c0531e6ffb0582160b7ce283d22a0d3.png]]</p>
<p><strong>业务规则：</strong></p>
<ul>
<li>根据时间选择区间，展示销量前10的商品（包括菜品和套餐）</li>
<li>基于可视化报表的柱状图降序展示商品销量</li>
<li>此处的销量为商品销售的份数</li>
</ul>
<p>![[fc64a9b052756380f3f2a23d01f5b1c0.png]]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">SalesTop10ReportVO.java</span><br><span class="line"><span class="keyword">package</span> com.sky.vo;</span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SalesTop10ReportVO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="comment">//商品名称列表，以逗号分隔，例如：鱼香肉丝,宫保鸡丁,水煮鱼</span></span><br><span class="line">    <span class="keyword">private</span> String nameList;</span><br><span class="line">    <span class="comment">//销量列表，以逗号分隔，例如：260,215,200</span></span><br><span class="line">    <span class="keyword">private</span> String numberList;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.sky.dto;</span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GoodsSalesDTO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="comment">//商品名称</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">//销量</span></span><br><span class="line">    <span class="keyword">private</span> Integer number;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@GetMapping(&quot;/top10&quot;)</span></span><br><span class="line">	<span class="meta">@ApiOperation(&quot;销量排名统计&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> Result&lt;SalesTop10ReportVO&gt; <span class="title function_">top10</span><span class="params">(</span></span><br><span class="line"><span class="params">			<span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> LocalDate begin,</span></span><br><span class="line"><span class="params">			<span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span> LocalDate end)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> Result.success(reportService.getSalesTop10(begin, end));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 查询指定时间区间内的销量排名top10</span></span><br><span class="line"><span class="comment">	 * 用户下单就会产生订单数据和订单详情数据，如若用户下单后取消，数据库仅将状态修改，订单存在，应该统计完成状态的订单</span></span><br><span class="line"><span class="comment">	 * 订单详情表不能体现出订单的状态，具体的订单状态还要查询订单表才可以看出来</span></span><br><span class="line"><span class="comment">	 * 所以需要多表联合查询</span></span><br><span class="line"><span class="comment">	 * SELECT od.name, SUM(od.number)</span></span><br><span class="line"><span class="comment">	 * FROM order_detail od</span></span><br><span class="line"><span class="comment">	 * JOIN orders o ON od.order_id = o.id</span></span><br><span class="line"><span class="comment">	 * WHERE o.status = 5</span></span><br><span class="line"><span class="comment">	 * AND o.order_time &gt; ?</span></span><br><span class="line"><span class="comment">	 * AND o.order_time &lt; ?</span></span><br><span class="line"><span class="comment">	 * GROUP BY od.name</span></span><br><span class="line"><span class="comment">	 * ORDER BY total_number DESC</span></span><br><span class="line"><span class="comment">	 * LIMIT 0, 10;</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> begin</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> end</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> sql查询的结果封装到GoodsSalesDTO实体类中：商品名称  销量</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> SalesTop10ReportVO <span class="title function_">getSalesTop10</span><span class="params">(LocalDate begin, LocalDate end)</span> &#123;</span><br><span class="line">		<span class="comment">// mapper传递的参数是LocalDateTime类型，impl层传递的参数是LocalDate所以需要进行转化</span></span><br><span class="line">		<span class="type">LocalDateTime</span> <span class="variable">beginTime</span> <span class="operator">=</span> LocalDateTime.of(begin, LocalTime.MIN);</span><br><span class="line">		<span class="type">LocalDateTime</span> <span class="variable">endTime</span> <span class="operator">=</span> LocalDateTime.of(end, LocalTime.MAX);</span><br><span class="line"></span><br><span class="line">		List&lt;GoodsSalesDTO&gt; goodsSalesDTOList = orderMapper.getSalesTop10(beginTime, endTime);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 已有GoodsSalesDTO类型的集合数据：String name商品名称，Integer number销量</span></span><br><span class="line">		<span class="comment">// 需获取VO对象类型：String nameList 商品名称列表，String numberList销量列表</span></span><br><span class="line">		<span class="comment">// 法一：stream流</span></span><br><span class="line">		<span class="comment">// String nameList = StringUtils.join(goodsSalesDTOList.stream().map(GoodsSalesDTO::getName).collect(Collectors.toList()), &quot;,&quot;);</span></span><br><span class="line">		<span class="comment">// String numberList = StringUtils.join(goodsSalesDTOList.stream().map(GoodsSalesDTO::getNumber).collect(Collectors.toList()), &quot;,&quot;);</span></span><br><span class="line">		<span class="comment">// 法二：</span></span><br><span class="line">		ArrayList&lt;String&gt; nameList1 = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">		ArrayList&lt;Integer&gt; numberList1 = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">		<span class="keyword">for</span> (GoodsSalesDTO goodsSalesDTO : goodsSalesDTOList) &#123;</span><br><span class="line">			nameList1.add(goodsSalesDTO.getName());</span><br><span class="line">			numberList1.add(goodsSalesDTO.getNumber());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">String</span> <span class="variable">nameList</span> <span class="operator">=</span> StringUtils.join(nameList1, <span class="string">&quot;,&quot;</span>);</span><br><span class="line">		<span class="type">String</span> <span class="variable">numberList</span> <span class="operator">=</span> StringUtils.join(numberList1, <span class="string">&quot;,&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> SalesTop10ReportVO.builder()</span><br><span class="line">				.nameList(nameList)</span><br><span class="line">				.numberList(numberList)</span><br><span class="line">				.build();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    &lt;select id=<span class="string">&quot;getSalesTop10&quot;</span> resultType=<span class="string">&quot;com.sky.dto.GoodsSalesDTO&quot;</span>&gt;</span><br><span class="line">        select od.name name, sum(od.number) number</span><br><span class="line">        from order_detail od</span><br><span class="line">        join orders o on od.order_id = o.id</span><br><span class="line">        where o.status = <span class="number">5</span></span><br><span class="line">        &lt;<span class="keyword">if</span> test=<span class="string">&quot;beginTime != null&quot;</span>&gt;</span><br><span class="line">            and order_time &amp;gt;= #&#123;beginTime&#125;</span><br><span class="line">        &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">        &lt;<span class="keyword">if</span> test=<span class="string">&quot;endTime != null&quot;</span>&gt;</span><br><span class="line">            and order_time &amp;lt;= #&#123;endTime&#125;</span><br><span class="line">        &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">        # TODO 为啥子我的begin,end不行，一定要改成beginTime，endTime</span><br><span class="line">        group by od.name</span><br><span class="line">        order by number desc</span><br><span class="line">        limit <span class="number">0</span>, <span class="number">10</span></span><br><span class="line">    &lt;/select&gt;</span><br></pre></td></tr></table></figure>
<h1>十六、<strong>工作台业务代码，Apache POI，导出运营数据Excel报表</strong></h1>
<h2 id="16-1-工作台业务代码">16.1 <strong>工作台业务代码</strong></h2>
<p>![[b3fe349feb409a0ab5bf34f4ee313f5f.png]]</p>
<p><strong>工作台展示的数据：</strong></p>
<ul>
<li>今日数据</li>
<li>订单管理</li>
<li>菜品总览</li>
<li>套餐总览</li>
<li>订单信息</li>
</ul>
<p>![[b0edfcfd5d8f7c4fbd5af45de2afa37c.png]]</p>
<ul>
<li>营业额：已完成订单的总金额</li>
<li>有效订单：已完成订单的数量</li>
<li>订单完成率：有效订单数 / 总订单数 * 100%</li>
<li>平均客单价：营业额 / 有效订单数</li>
<li>新增用户：新增用户的数量</li>
</ul>
<p><strong>接口设计：</strong></p>
<ul>
<li>
<p>今日数据接口</p>
<p>![[d2ced8ec499d1371576588463b2eb35f.png]]</p>
</li>
<li>
<p>订单管理接口</p>
<p>![[35ee26fac5dd4ee73df4f71eb561b441.png]]</p>
</li>
<li>
<p>菜品总览接口</p>
<p>![[3e3513a81c53f9a37213aa3151cb3b2c.png]]</p>
</li>
<li>
<p>套餐总览接口</p>
<p>![[a6e99744e9f2ec49b14bf0352c22cb72.png]]</p>
</li>
<li>
<p>订单搜索（订单管理模块已完成）</p>
</li>
<li>
<p>各个状态的订单数量统计（订单管理模块已完成）</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br></pre></td><td class="code"><pre><span class="line">BusinessDataVO</span><br><span class="line"><span class="keyword">package</span> com.sky.vo;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 数据概览</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BusinessDataVO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Double turnover;<span class="comment">//营业额</span></span><br><span class="line">    <span class="keyword">private</span> Integer validOrderCount;<span class="comment">//有效订单数</span></span><br><span class="line">    <span class="keyword">private</span> Double orderCompletionRate;<span class="comment">//订单完成率</span></span><br><span class="line">    <span class="keyword">private</span> Double unitPrice;<span class="comment">//平均客单价</span></span><br><span class="line">    <span class="keyword">private</span> Integer newUsers;<span class="comment">//新增用户数</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">OrderOverViewVO</span><br><span class="line"><span class="keyword">package</span> com.sky.vo;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 订单概览数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderOverViewVO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="comment">//待接单数量</span></span><br><span class="line">    <span class="keyword">private</span> Integer waitingOrders;</span><br><span class="line">    <span class="comment">//待派送数量</span></span><br><span class="line">    <span class="keyword">private</span> Integer deliveredOrders;</span><br><span class="line">    <span class="comment">//已完成数量</span></span><br><span class="line">    <span class="keyword">private</span> Integer completedOrders;</span><br><span class="line">    <span class="comment">//已取消数量</span></span><br><span class="line">    <span class="keyword">private</span> Integer cancelledOrders;</span><br><span class="line">    <span class="comment">//全部订单</span></span><br><span class="line">    <span class="keyword">private</span> Integer allOrders;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DishOverViewVO</span><br><span class="line"><span class="keyword">package</span> com.sky.vo;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 菜品总览</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DishOverViewVO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="comment">// 已启售数量</span></span><br><span class="line">    <span class="keyword">private</span> Integer sold;</span><br><span class="line">    <span class="comment">// 已停售数量</span></span><br><span class="line">    <span class="keyword">private</span> Integer discontinued;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SetmealOverViewVO</span><br><span class="line"><span class="keyword">package</span> com.sky.vo;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 套餐总览</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SetmealOverViewVO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="comment">// 已启售数量</span></span><br><span class="line">    <span class="keyword">private</span> Integer sold;</span><br><span class="line">    <span class="comment">// 已停售数量</span></span><br><span class="line">    <span class="keyword">private</span> Integer discontinued;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">WorkSpaceController.java admin下创建</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 工作台</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/admin/workspace&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;工作台相关接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WorkSpaceController</span> &#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> WorkSpaceService workSpaceService;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 根据时间段统计营业数据</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@GetMapping(&quot;/businessData&quot;)</span></span><br><span class="line">	<span class="meta">@ApiOperation(&quot;工作台今日数据查询&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> Result&lt;BusinessDataVO&gt; <span class="title function_">businessData</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="comment">// 获得当天的开始时间</span></span><br><span class="line">		<span class="type">LocalDateTime</span> <span class="variable">begin</span> <span class="operator">=</span> LocalDateTime.now().with(LocalTime.MIN);</span><br><span class="line">		<span class="comment">// 获得当天的结束时间</span></span><br><span class="line">		<span class="type">LocalDateTime</span> <span class="variable">end</span> <span class="operator">=</span> LocalDateTime.now().with(LocalTime.MAX);</span><br><span class="line"></span><br><span class="line">		<span class="type">BusinessDataVO</span> <span class="variable">businessDataVO</span> <span class="operator">=</span> workSpaceService.getBusinessData(begin, end);</span><br><span class="line">		<span class="keyword">return</span> Result.success(businessDataVO);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 查询订单管理数据</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@GetMapping(&quot;/overviewOrders&quot;)</span></span><br><span class="line">	<span class="meta">@ApiOperation(&quot;查询订单管理数据&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> Result&lt;OrderOverViewVO&gt; <span class="title function_">orderOverView</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> Result.success(workSpaceService.getOrderOverView());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 查询菜品总览：已启售 已停售</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@GetMapping(&quot;/overviewDishes&quot;)</span></span><br><span class="line">	<span class="meta">@ApiOperation(&quot;查询菜品总览&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> Result&lt;DishOverViewVO&gt; <span class="title function_">dishOverView</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> Result.success(workSpaceService.getDishOverView());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 查询套餐总览：已启售 已停售</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@GetMapping(&quot;/overviewSetmeals&quot;)</span></span><br><span class="line">	<span class="meta">@ApiOperation(&quot;查询套餐总览&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> Result&lt;SetmealOverViewVO&gt; <span class="title function_">setmealOverView</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> Result.success(workSpaceService.getSetmealOverView());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ServiceImpl.java</span><br><span class="line"><span class="keyword">package</span> com.sky.service.impl;</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WorkSpaceServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">WorkSpaceService</span> &#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> OrderMapper orderMapper;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> DishMapper dishMapper;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> SetmealMapper setmealMapper;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 根据时间段统计营业数据</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> begin</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> end</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> BusinessDataVO <span class="title function_">getBusinessData</span><span class="params">(LocalDateTime begin, LocalDateTime end)</span> &#123;</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * 营业额：当日已完成订单的总金额</span></span><br><span class="line"><span class="comment">		 * 有效订单：当日已完成订单的数量</span></span><br><span class="line"><span class="comment">		 * 订单完成率：有效订单数 / 总订单数</span></span><br><span class="line"><span class="comment">		 * 平均客单价：营业额 / 有效订单数</span></span><br><span class="line"><span class="comment">		 * 新增用户：当日新增用户的数量</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">		map.put(<span class="string">&quot;begin&quot;</span>, begin);</span><br><span class="line">		map.put(<span class="string">&quot;end&quot;</span>, end);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查询总订单数</span></span><br><span class="line">		<span class="type">Integer</span> <span class="variable">totalOrderCount</span> <span class="operator">=</span> orderMapper.countByMap(map);</span><br><span class="line"></span><br><span class="line">		map.put(<span class="string">&quot;status&quot;</span>, Orders.COMPLETED);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 营业额</span></span><br><span class="line">		<span class="type">Double</span> <span class="variable">turnover</span> <span class="operator">=</span> orderMapper.sumByMap(map);</span><br><span class="line">		turnover = turnover == <span class="literal">null</span> ? <span class="number">0.0</span> : turnover;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 有效订单数</span></span><br><span class="line">		<span class="type">Integer</span> <span class="variable">validOrderCount</span> <span class="operator">=</span> orderMapper.countByMap(map);</span><br><span class="line"></span><br><span class="line">		<span class="type">Double</span> <span class="variable">unitPrice</span> <span class="operator">=</span> <span class="number">0.0</span>;</span><br><span class="line">		<span class="type">Double</span> <span class="variable">orderCompletionRate</span> <span class="operator">=</span> <span class="number">0.0</span>;</span><br><span class="line">		<span class="keyword">if</span> (totalOrderCount != <span class="number">0</span> &amp;&amp; validOrderCount != <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">// 订单完成率</span></span><br><span class="line">			orderCompletionRate = validOrderCount.doubleValue() / totalOrderCount;</span><br><span class="line">			<span class="comment">// 平均客单价</span></span><br><span class="line">			unitPrice = turnover / validOrderCount;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 新增用户数</span></span><br><span class="line">		<span class="type">Integer</span> <span class="variable">newUsers</span> <span class="operator">=</span> userMapper.countByMap(map);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> BusinessDataVO.builder()</span><br><span class="line">				.turnover(turnover)</span><br><span class="line">				.newUsers(newUsers)</span><br><span class="line">				.validOrderCount(validOrderCount)</span><br><span class="line">				.orderCompletionRate(orderCompletionRate)</span><br><span class="line">				.unitPrice(unitPrice)</span><br><span class="line">				.build();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 查询订单管理数据</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> OrderOverViewVO <span class="title function_">getOrderOverView</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">		map.put(<span class="string">&quot;begin&quot;</span>, LocalDateTime.now().with(LocalTime.MIN));</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 待接单</span></span><br><span class="line">		map.put(<span class="string">&quot;status&quot;</span>, Orders.TO_BE_CONFIRMED);</span><br><span class="line">		<span class="type">Integer</span> <span class="variable">waitingOrders</span> <span class="operator">=</span> orderMapper.countByMap(map);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 待派送</span></span><br><span class="line">		map.put(<span class="string">&quot;status&quot;</span>, Orders.CONFIRMED);</span><br><span class="line">		<span class="type">Integer</span> <span class="variable">deliveredOrders</span> <span class="operator">=</span> orderMapper.countByMap(map);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 已完成</span></span><br><span class="line">		map.put(<span class="string">&quot;status&quot;</span>, Orders.COMPLETED);</span><br><span class="line">		<span class="type">Integer</span> <span class="variable">completedOrders</span> <span class="operator">=</span> orderMapper.countByMap(map);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 已取消</span></span><br><span class="line">		map.put(<span class="string">&quot;status&quot;</span>, Orders.CANCELLED);</span><br><span class="line">		<span class="type">Integer</span> <span class="variable">cancelledOrders</span> <span class="operator">=</span> orderMapper.countByMap(map);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 全部订单</span></span><br><span class="line">		map.put(<span class="string">&quot;status&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">		<span class="type">Integer</span> <span class="variable">allOrders</span> <span class="operator">=</span> orderMapper.countByMap(map);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> OrderOverViewVO.builder()</span><br><span class="line">				.waitingOrders(waitingOrders)</span><br><span class="line">				.deliveredOrders(deliveredOrders)</span><br><span class="line">				.completedOrders(completedOrders)</span><br><span class="line">				.cancelledOrders(cancelledOrders)</span><br><span class="line">				.allOrders(allOrders)</span><br><span class="line">				.build();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 查询菜品总览</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> DishOverViewVO <span class="title function_">getDishOverView</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">		map.put(<span class="string">&quot;status&quot;</span>, StatusConstant.ENABLE);</span><br><span class="line">		<span class="type">Integer</span> <span class="variable">sold</span> <span class="operator">=</span> dishMapper.countByMap(map);</span><br><span class="line"></span><br><span class="line">		map.put(<span class="string">&quot;status&quot;</span>, StatusConstant.DISABLE);</span><br><span class="line">		<span class="type">Integer</span> <span class="variable">discontinued</span> <span class="operator">=</span> dishMapper.countByMap(map);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> DishOverViewVO.builder()</span><br><span class="line">				.sold(sold)</span><br><span class="line">				.discontinued(discontinued)</span><br><span class="line">				.build();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 查询套餐总览</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> SetmealOverViewVO <span class="title function_">getSetmealOverView</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">		map.put(<span class="string">&quot;status&quot;</span>, StatusConstant.ENABLE);</span><br><span class="line">		<span class="type">Integer</span> <span class="variable">sold</span> <span class="operator">=</span> setmealMapper.countByMap(map);</span><br><span class="line"></span><br><span class="line">		map.put(<span class="string">&quot;status&quot;</span>, StatusConstant.DISABLE);</span><br><span class="line">		<span class="type">Integer</span> <span class="variable">discontinued</span> <span class="operator">=</span> setmealMapper.countByMap(map);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> SetmealOverViewVO.builder()</span><br><span class="line">				.sold(sold)</span><br><span class="line">				.discontinued(discontinued)</span><br><span class="line">				.build();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;select id=<span class="string">&quot;countByMap&quot;</span> resultType=<span class="string">&quot;java.lang.Integer&quot;</span>&gt;</span><br><span class="line">    select <span class="title function_">count</span><span class="params">(id)</span> from orders</span><br><span class="line">    &lt;where&gt;</span><br><span class="line">        &lt;<span class="keyword">if</span> t3est=<span class="string">&quot;begin != null&quot;</span>&gt;</span><br><span class="line">            and order_time &amp;gt;= #&#123;begin&#125;</span><br><span class="line">        &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">        &lt;<span class="keyword">if</span> test=<span class="string">&quot;end != null&quot;</span>&gt;</span><br><span class="line">            and order_time &amp;lt;= #&#123;end&#125;</span><br><span class="line">        &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">        &lt;<span class="keyword">if</span> test=<span class="string">&quot;status != null&quot;</span>&gt;</span><br><span class="line">            <span class="type">and</span> <span class="variable">status</span> <span class="operator">=</span> #&#123;status&#125;</span><br><span class="line">        &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">    &lt;/where&gt;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure>
<h2 id="16-2-Apache-POI">16.2 <strong>Apache POI</strong></h2>
<p>Apache POI 是一个处理Miscrosoft Office（微软办公软件）各种文件格式的开源项目。简单来说就是，我们可以<strong>使用 POI 在 Java 程序中对Miscrosoft Office各种文件（Word、Excel、PowerPoint等等）进行</strong><code>**读写**</code><strong>操作</strong>。</p>
<p>一般情况下，POI 主要都是用于操作 Excel 文件。</p>
<p><a target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/7778d2c5be28fe994b27b69d71a892a4.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/7778d2c5be28fe994b27b69d71a892a4.png" alt=""></a></p>
<p><strong>Apache POI 的应用场景：</strong></p>
<ul>
<li>
<p>银行网银系统导出交易明细</p>
<p><a target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/ec3f5766cbe26aa0d6bb4457c3067254.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/ec3f5766cbe26aa0d6bb4457c3067254.png" alt=""></a></p>
</li>
<li>
<p>各种业务系统导出Excel报表</p>
<p><a target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/170d8b545850440e5c730e9325368413.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/170d8b545850440e5c730e9325368413.png" alt=""></a></p>
</li>
<li>
<p>批量导入业务数据</p>
<p><a target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/9de4b55166f84ffe34ff2cfa07b19cbb.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/9de4b55166f84ffe34ff2cfa07b19cbb.png" alt=""></a></p>
</li>
</ul>
<h2 id="16-2-1-入门案例">16.2.1 入门案例</h2>
<p>Apache POI既可以将数据写入Excel文件，也可以读取Excel文件中的数据，接下来分别进行实现。</p>
<ol>
<li>
<p><strong>Apache POI的maven坐标：</strong></p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.poi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>poi<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.poi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>poi-ooxml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p><strong>将数据写入Excel文件</strong></p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.usermodel.XSSFCell;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.usermodel.XSSFRow;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.usermodel.XSSFSheet;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.usermodel.XSSFWorkbook;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 基于POI向Excel文件写入数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">POITest</span> &#123;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 通过POI创建Excel文件，并写入文件内容</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">// 在内存中创建一个Excel文件（手动创建是在磁盘创建）</span></span><br><span class="line">		<span class="type">XSSFWorkbook</span> <span class="variable">excel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XSSFWorkbook</span>();</span><br><span class="line">		<span class="comment">// 在Excel中创建一个Sheet页</span></span><br><span class="line">		<span class="type">XSSFSheet</span> <span class="variable">sheet</span> <span class="operator">=</span> excel.createSheet(<span class="string">&quot;Sheet1&quot;</span>);</span><br><span class="line">		<span class="comment">// 在Sheet页中创建行对象，rownum下标从0开始</span></span><br><span class="line">		<span class="type">XSSFRow</span> <span class="variable">row</span> <span class="operator">=</span> sheet.createRow(<span class="number">1</span>);<span class="comment">// 创建第二行</span></span><br><span class="line">		<span class="comment">// 在行上创建单元格，columnIndex下标从0开始</span></span><br><span class="line">		row.createCell(<span class="number">1</span>).setCellValue(<span class="string">&quot;姓名&quot;</span>); <span class="comment">// 创建并写入第二个单元格</span></span><br><span class="line">		row.createCell(<span class="number">2</span>).setCellValue(<span class="string">&quot;城市&quot;</span>);</span><br><span class="line"></span><br><span class="line">		row = sheet.createRow(<span class="number">2</span>);</span><br><span class="line">		row.createCell(<span class="number">1</span>).setCellValue(<span class="string">&quot;lr&quot;</span>);</span><br><span class="line">		row.createCell(<span class="number">2</span>).setCellValue(<span class="string">&quot;大连&quot;</span>);</span><br><span class="line"></span><br><span class="line">		row = sheet.createRow(<span class="number">3</span>);</span><br><span class="line">		row.createCell(<span class="number">1</span>).setCellValue(<span class="string">&quot;jyl&quot;</span>);</span><br><span class="line">		row.createCell(<span class="number">2</span>).setCellValue(<span class="string">&quot;北京&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 将内存的Excel文件写到磁盘文件中</span></span><br><span class="line">		<span class="type">FileOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;E:\\info.xlsx&quot;</span>));</span><br><span class="line">		excel.write(out);</span><br><span class="line"></span><br><span class="line">		out.close();</span><br><span class="line">		excel.close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		write();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>![[/image 10 21.png|image 10 21.png]]</p>
</li>
<li>
<p><strong>读取Excel文件中的数据</strong></p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 基于POI向Excel文件写入数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">POITest</span> &#123;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 通过POI创建Excel文件，并写入文件内容</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">// 在内存中创建一个Excel文件（手动创建是在磁盘创建）</span></span><br><span class="line">		<span class="type">XSSFWorkbook</span> <span class="variable">excel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XSSFWorkbook</span>();</span><br><span class="line">		<span class="comment">// 在Excel中创建一个Sheet页</span></span><br><span class="line">		<span class="type">XSSFSheet</span> <span class="variable">sheet</span> <span class="operator">=</span> excel.createSheet(<span class="string">&quot;Sheet1&quot;</span>);</span><br><span class="line">		<span class="comment">// 在Sheet页中创建行对象，rownum下标从0开始</span></span><br><span class="line">		<span class="type">XSSFRow</span> <span class="variable">row</span> <span class="operator">=</span> sheet.createRow(<span class="number">1</span>);<span class="comment">// 创建第二行</span></span><br><span class="line">		<span class="comment">// 在行上创建单元格，columnIndex下标从0开始</span></span><br><span class="line">		row.createCell(<span class="number">1</span>).setCellValue(<span class="string">&quot;姓名&quot;</span>); <span class="comment">// 创建并写入第二个单元格</span></span><br><span class="line">		row.createCell(<span class="number">2</span>).setCellValue(<span class="string">&quot;城市&quot;</span>);</span><br><span class="line"></span><br><span class="line">		row = sheet.createRow(<span class="number">2</span>);</span><br><span class="line">		row.createCell(<span class="number">1</span>).setCellValue(<span class="string">&quot;lr&quot;</span>);</span><br><span class="line">		row.createCell(<span class="number">2</span>).setCellValue(<span class="string">&quot;大连&quot;</span>);</span><br><span class="line"></span><br><span class="line">		row = sheet.createRow(<span class="number">3</span>);</span><br><span class="line">		row.createCell(<span class="number">1</span>).setCellValue(<span class="string">&quot;jyl&quot;</span>);</span><br><span class="line">		row.createCell(<span class="number">2</span>).setCellValue(<span class="string">&quot;北京&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 将内存的Excel文件写到磁盘文件中</span></span><br><span class="line">		<span class="type">FileOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;E:\\info.xlsx&quot;</span>));</span><br><span class="line">		excel.write(out);</span><br><span class="line"></span><br><span class="line">		out.close();</span><br><span class="line">		excel.close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 通过POI读取Excel文件</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">read</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="type">FileInputStream</span> <span class="variable">is</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;E:\\info.xlsx&quot;</span>));</span><br><span class="line">		<span class="type">XSSFWorkbook</span> <span class="variable">excel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XSSFWorkbook</span>(is);</span><br><span class="line">		<span class="type">XSSFSheet</span> <span class="variable">sheet</span> <span class="operator">=</span> excel.getSheetAt(<span class="number">0</span>); <span class="comment">// 获取第1个Sheet页</span></span><br><span class="line"></span><br><span class="line">		<span class="type">int</span> <span class="variable">lastRowNum</span> <span class="operator">=</span> sheet.getLastRowNum();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 遍历从第一行到最后一行的数据</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt;= lastRowNum; i++) &#123;</span><br><span class="line">			<span class="comment">// 获取行对象</span></span><br><span class="line">			<span class="type">XSSFRow</span> <span class="variable">titleRow</span> <span class="operator">=</span> sheet.getRow(i);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 检查行是否为空</span></span><br><span class="line">			<span class="keyword">if</span> (titleRow != <span class="literal">null</span>) &#123;</span><br><span class="line">				<span class="comment">// 获取行的第2个单元格，下标从0开始</span></span><br><span class="line">				<span class="type">XSSFCell</span> <span class="variable">cell1</span> <span class="operator">=</span> titleRow.getCell(<span class="number">1</span>);</span><br><span class="line">				<span class="type">XSSFCell</span> <span class="variable">cell2</span> <span class="operator">=</span> titleRow.getCell(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 检查单元格是否为空</span></span><br><span class="line">				<span class="keyword">if</span> (cell1 != <span class="literal">null</span> &amp;&amp; cell2 != <span class="literal">null</span>) &#123;</span><br><span class="line">					<span class="comment">// 获取单元格中的文本内容</span></span><br><span class="line">					<span class="type">String</span> <span class="variable">cellValue1</span> <span class="operator">=</span> cell1.getStringCellValue();</span><br><span class="line">					<span class="type">String</span> <span class="variable">cellValue2</span> <span class="operator">=</span> cell2.getStringCellValue();</span><br><span class="line"></span><br><span class="line">					<span class="comment">// 输出单元格内容到控制台</span></span><br><span class="line">					System.out.println(cellValue1 + <span class="string">&quot; &quot;</span> + cellValue2);</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					System.out.println(<span class="string">&quot;单元格为空&quot;</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				System.out.println(<span class="string">&quot;行为空&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 关闭资源</span></span><br><span class="line">		is.close();</span><br><span class="line">		excel.close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">// write();</span></span><br><span class="line">		read();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>控制台读取</p>
</li>
</ol>
<h2 id="16-3-导出运营数据Excel报表">16.3 <strong>导出运营数据Excel报表</strong></h2>
<p>![[9fc7d8e94e47b24ac9bf07463b78754e.png]]</p>
<p>数据统计页面，有一个数据导出的按钮，点击该按钮时，其实就会下载一个文件。这个文件实际上是一个Excel形式的文件，文件中主要包含最近30日运营相关的数据。表格的形式已经固定，主要由概览数据和明细数据两部分组成。真正导出这个报表之后，相对应的数字就会填充在表格中，就可以进行存档。</p>
<p>![[2d45f57ea02afb4f922f49b9fc1fa336.png]]</p>
<p>导出的Excel报表格式：</p>
<p><a target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/3822baf034c58c6d33af405ff2a0336b.png"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i-blog.csdnimg.cn/blog_migrate/3822baf034c58c6d33af405ff2a0336b.png" alt=""></a></p>
<p><strong>业务规则：</strong></p>
<ul>
<li>导出Excel形式的报表文件</li>
<li>导出最近30天的运营数据</li>
</ul>
<p>![[762582ca2c6ad13e4b5f870c6aaf00dd.png]]</p>
<p><strong>注意：</strong></p>
<ul>
<li>当前接口没有传递参数，因为导出的是最近30天的运营数据，<code>后端计算即可</code>，所以不需要任何参数</li>
<li>当前接口没有返回数据，因为报表导出功能本质上是<code>文件下载</code>，服务端会通过输出流将Excel文件下载到客户端浏览器</li>
</ul>
<p><strong>问题</strong>：当前设计的Excel表格的格式相对来说比较复杂，涉及到合并单元格、背景色、字号的大小也不相同。我们通过poi编程的方式虽然可以创建出这个Excel表格，但是这种代码写起来非常的繁琐，</p>
<p><strong>解决</strong>：在真正的项目中在导出一些报表的时候，如果这个报表的格式比较复杂，那么一般都不会通过poi去创建这个表格，而是提前在电脑上把这个表格的样式给设计好提供一个空的Excel文件，之后在程序中就不用在创建一个新的Excel文件而是读取这个文件（此文件一般叫做模版文件），读取到模板文件之后在相应的空白处填上响应的数字就可以了，数据写完之后在通过文件下载，把文件下载到客户端浏览器就完成了。</p>
<p>![[3822baf034c58c6d33af405ff2a0336b.png]]</p>
<ol>
<li>
<p>设计Excel模板文件（模版文件一般放在项目内部就可以了）</p>
<p>![[07b6627ff3ff60323ce657901a3f61e8.png]]</p>
</li>
<li>
<p>查询近30天的运营数据</p>
</li>
<li>
<p>将查询到的运营数据写入模板文件</p>
</li>
<li>
<p>通过输出流将Excel文件下载到客户端浏览器</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 导出运营数据报表</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@GetMapping(&quot;/export&quot;)</span></span><br><span class="line">   <span class="meta">@ApiOperation(&quot;导出运营数据报表&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">export</span><span class="params">(HttpServletResponse response)</span>&#123;</span><br><span class="line">       reportService.exportBusinessData(response);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exportBusinessData</span><span class="params">(HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">	<span class="comment">// 1.查询数据库，获取营业数据---查询最近30天的营业数据</span></span><br><span class="line">	<span class="comment">/* 最近30天：</span></span><br><span class="line"><span class="comment">	 *     LocalDate.now()：获取当天时间日期</span></span><br><span class="line"><span class="comment">	 *     LocalDate.now().minusDays(30)：获取相对今天来说往前倒30天的日期</span></span><br><span class="line"><span class="comment">	 *     LocalDate.now().minusDays(1)：查到相对今天的前一天（昨天）</span></span><br><span class="line"><span class="comment">	 * 为什么不查到今天呢？？？   因为今天有可能还没有结束，数据可能还会发生变动。</span></span><br><span class="line"><span class="comment">	 * */</span></span><br><span class="line">	<span class="type">LocalDate</span> <span class="variable">dateBegin</span> <span class="operator">=</span> LocalDate.now().minusDays(<span class="number">30</span>);</span><br><span class="line">	<span class="type">LocalDate</span> <span class="variable">dateEnd</span> <span class="operator">=</span> LocalDate.now().minusDays(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 构建的开始结束时间是LocalDate（年月日类型），业务层需要的是LocalDateTime（年月日时分秒）类型，所以需要进行转化。</span></span><br><span class="line">	<span class="type">LocalDateTime</span> <span class="variable">begin</span> <span class="operator">=</span> LocalDateTime.of(dateBegin, LocalTime.MIN);<span class="comment">// 起始日期的最开始时间：0时0分0秒</span></span><br><span class="line">	<span class="type">LocalDateTime</span> <span class="variable">ends</span> <span class="operator">=</span> LocalDateTime.of(dateEnd, LocalTime.MAX);<span class="comment">// 截止日期的最晚结束时间：11:59:59</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取”概览数据“，在工作台页面功能中已经查过概览数据，所以需要之前查询概览数据的业务层对象WorkspaceService</span></span><br><span class="line">	<span class="type">BusinessDataVO</span> <span class="variable">businessData</span> <span class="operator">=</span> workSpaceService.getBusinessData(begin, ends);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 2. 通过POI将数据写入到Excel文件中</span></span><br><span class="line">	<span class="comment">// 读取模板输入流对象</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * this.getClass()：获得本类的类对象</span></span><br><span class="line"><span class="comment">	 * this.getClass().getClassLoader()：获得类加载器</span></span><br><span class="line"><span class="comment">	 * this.getClass().getClassLoader().getResourceAsStream()：获取类路径下的指定文件的输入流</span></span><br><span class="line"><span class="comment">	 * */</span></span><br><span class="line">	<span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="built_in">this</span>.getClass().getClassLoader().getResourceAsStream(<span class="string">&quot;template/运营数据报表模板.xlsx&quot;</span>);</span><br><span class="line">	<span class="type">XSSFWorkbook</span> <span class="variable">excel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">	<span class="type">ServletOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">// 基于模板文件创建一个新的Excel文件</span></span><br><span class="line">		excel = <span class="keyword">new</span> <span class="title class_">XSSFWorkbook</span>(in);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 填充——时间</span></span><br><span class="line">		<span class="type">XSSFSheet</span> <span class="variable">sheet</span> <span class="operator">=</span> excel.getSheet(<span class="string">&quot;Sheet1&quot;</span>);</span><br><span class="line">		sheet.getRow(<span class="number">1</span>).getCell(<span class="number">1</span>).setCellValue(<span class="string">&quot;时间：&quot;</span> + dateBegin + <span class="string">&quot;至&quot;</span> + dateEnd); <span class="comment">// 填充（2，2）</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// 填充——概览数据</span></span><br><span class="line">		<span class="comment">// 营业额</span></span><br><span class="line">		<span class="type">XSSFRow</span> <span class="variable">row</span> <span class="operator">=</span> sheet.getRow(<span class="number">3</span>);</span><br><span class="line">		row.getCell(<span class="number">2</span>).setCellValue(businessData.getTurnover());</span><br><span class="line">		<span class="comment">// 订单完成率</span></span><br><span class="line">		row.getCell(<span class="number">4</span>).setCellValue(businessData.getOrderCompletionRate());</span><br><span class="line">		<span class="comment">// 新增用户数</span></span><br><span class="line">		row.getCell(<span class="number">6</span>).setCellValue(businessData.getNewUsers());</span><br><span class="line">		row = sheet.getRow(<span class="number">4</span>);</span><br><span class="line">		<span class="comment">// 有效订单</span></span><br><span class="line">		row.getCell(<span class="number">2</span>).setCellValue(businessData.getValidOrderCount());</span><br><span class="line">		<span class="comment">// 平均客单价</span></span><br><span class="line">		row.getCell(<span class="number">4</span>).setCellValue(businessData.getUnitPrice());</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 填充——明细数据</span></span><br><span class="line">		<span class="comment">// 概览数据查询的是近30天的，而这个明细数据查询的是每一天的数据项</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">30</span>; i++) &#123;</span><br><span class="line">			<span class="type">LocalDate</span> <span class="variable">date</span> <span class="operator">=</span> dateBegin.plusDays(i);</span><br><span class="line">			<span class="comment">// 查询某一天的营业数据</span></span><br><span class="line">			<span class="type">BusinessDataVO</span> <span class="variable">businessData1</span> <span class="operator">=</span> workSpaceService.getBusinessData(LocalDateTime.of(date, LocalTime.MIN), LocalDateTime.of(date, LocalTime.MAX));</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 获得某一行：查看excel表格可知数据是从第8行（下标为7）开始填充的</span></span><br><span class="line">			row = sheet.getRow(<span class="number">7</span> + i);</span><br><span class="line">			row.getCell(<span class="number">1</span>).setCellValue(date.toString());<span class="comment">// 当前行的第2个单元格，填充日期，只能接收字符串类型所以需要转化</span></span><br><span class="line">			row.getCell(<span class="number">2</span>).setCellValue(businessData1.getTurnover());<span class="comment">// 营业额</span></span><br><span class="line">			row.getCell(<span class="number">3</span>).setCellValue(businessData1.getValidOrderCount());<span class="comment">// 有效订单</span></span><br><span class="line">			row.getCell(<span class="number">4</span>).setCellValue(businessData1.getOrderCompletionRate());<span class="comment">// 订单完成率</span></span><br><span class="line">			row.getCell(<span class="number">5</span>).setCellValue(businessData1.getUnitPrice());<span class="comment">// 平均客单价</span></span><br><span class="line">			row.getCell(<span class="number">6</span>).setCellValue(businessData1.getNewUsers()); <span class="comment">// 新增用户数</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 3. 通过输出流将Excel文件下载到客户端浏览器</span></span><br><span class="line">		out = response.getOutputStream();</span><br><span class="line">		excel.write(out);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">	&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			out.close();</span><br><span class="line">			excel.close();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>**HttpServletResponse response**</code>：用于向客户端发送响应，特别是在该方法中，<code>response</code> 是为了将生成的 Excel 文件流返回给客户端，使浏览器能够下载文件。</li>
<li>在 Java 中，类的加载器（ClassLoader）可以帮助我们加载资源文件或类信息，尤其在读取类路径下的文件时非常方便。
<ol>
<li>
<p><code>this.getClass()</code>：获得当前对象的类对象</p>
<p><code>this.getClass()</code> 方法返回的是当前对象所属类的 <code>Class</code> 对象。每个类在运行时都会被 JVM 加载，并且有一个 <code>Class</code> 对象表示它的类型。</p>
</li>
<li>
<p><code>this.getClass().getClassLoader()</code>：获得类加载器</p>
<p>每个类都有一个 <code>ClassLoader</code>，负责加载类及其依赖的资源。使用 <code>this.getClass().getClassLoader()</code> 可以获取加载当前类的类加载器。</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> <span class="built_in">this</span>.getClass().getClassLoader();</span><br><span class="line">System.out.println(<span class="string">&quot;类加载器：&quot;</span> + classLoader);</span><br></pre></td></tr></table></figure>
<p>输出当前类的加载器。通常，对于来自应用程序类路径的类，类加载器是 <code>ApplicationClassLoader</code>。</p>
</li>
<li>
<p><code>this.getClass().getClassLoader().getResourceAsStream(String name)</code>：获取类路径下的文件</p>
<p><code>getResourceAsStream()</code> 方法用于从类路径中读取资源文件，并返回一个 <code>InputStream</code> 对象。你可以使用该方法来读取项目的资源文件（例如配置文件、图片等）。</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="built_in">this</span>.getClass().getClassLoader().getResourceAsStream(<span class="string">&quot;config.properties&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (inputStream != <span class="literal">null</span>) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;资源文件已找到！&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;资源文件未找到！&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ul>
<div class="main-hero-waves-area"><div class="waves-area"><svg class="waves-svg" version="1.1" xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 1440 140" preserveAspectRatio="none"><path class="parallax" d="M 0 44 C 355 167 415 0 725 44 L 725 44 L 0 44 Z"></path><use class="parallax" xlink:href="#wave1" x="48" y="3"></use><use class="parallax" xlink:href="#wave1" x="48" y="5"></use><use class="parallax" xlink:href="#wave1" x="48" y="7"></use><use class="parallax" xlink:href="#wave1" x="48" y="9"></use></svg></div></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://labi.com">Lorinda</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://labi.com/post/d67b0a8b.html">http://labi.com/post/d67b0a8b.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="http://labi.com" target="_blank">蜡笔梦工厂</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Spring-Boot/">Spring Boot</a><a class="post-meta__tags" href="/tags/Vue/">Vue</a><a class="post-meta__tags" href="/tags/MySQL/">MySQL</a><a class="post-meta__tags" href="/tags/%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91/">业务逻辑</a><a class="post-meta__tags" href="/tags/%E4%B8%89%E5%B1%82%E6%9E%B6%E6%9E%84/">三层架构</a></div><div class="post-share"><div class="social-share" data-image="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112813.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://lib.baomitu.com/social-share.js/1.0.16/css/share.min.css" media="print" onload="this.media='all'"><script src="https://lib.baomitu.com/social-share.js/1.0.16/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/post/b85186f.html" title="基础开发：环境搭建与核心配置"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112626.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">基础开发：环境搭建与核心配置</div></div><div class="info-2"><div class="info-item-1">详解苍穹外卖项目基础开发流程，包括本地开发环境搭建、数据库表结构设计与初始化，核心配置（跨域、日志等）及基础工具类实现，构建项目开发基石。</div></div></div></a><a class="pagination-related" href="/post/ce4585c2.html" title="前端实现：界面与交互逻辑"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112938.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">前端实现：界面与交互逻辑</div></div><div class="info-2"><div class="info-item-1">详解苍穹外卖前端开发实现，包括Vue组件架构设计、核心页面（登录、首页、订单页）开发，接口交互封装与状态管理，确保前端界面与后端服务高效协同。</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/post/ce4585c2.html" title="前端实现：界面与交互逻辑"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112938.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-30</div><div class="info-item-2">前端实现：界面与交互逻辑</div></div><div class="info-2"><div class="info-item-1">详解苍穹外卖前端开发实现，包括Vue组件架构设计、核心页面（登录、首页、订单页）开发，接口交互封装与状态管理，确保前端界面与后端服务高效协同。</div></div></div></a><a class="pagination-related" href="/post/25e0fe54.html" title="项目概述：架构与需求分析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112618.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-30</div><div class="info-item-2">项目概述：架构与需求分析</div></div><div class="info-2"><div class="info-item-1">全面解析苍穹外卖项目的整体规划，包括项目背景、核心需求、技术栈选型依据，详解系统架构设计与开发规范，为项目开发提供整体指导。</div></div></div></a><a class="pagination-related" href="/post/b85186f.html" title="基础开发：环境搭建与核心配置"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112626.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-30</div><div class="info-item-2">基础开发：环境搭建与核心配置</div></div><div class="info-2"><div class="info-item-1">详解苍穹外卖项目基础开发流程，包括本地开发环境搭建、数据库表结构设计与初始化，核心配置（跨域、日志等）及基础工具类实现，构建项目开发基石。</div></div></div></a><a class="pagination-related" href="/post/reggie-overview.html" title="瑞吉外卖：项目概述与整体架构"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2024_1123_160146.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-02</div><div class="info-item-2">瑞吉外卖：项目概述与整体架构</div></div><div class="info-2"><div class="info-item-1">全面解析瑞吉外卖项目背景、技术选型、整体架构设计及核心业务流程，建立项目全局认知。</div></div></div></a><a class="pagination-related" href="/post/reggie-business.html" title="瑞吉外卖：核心业务功能开发"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112844.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-02</div><div class="info-item-2">瑞吉外卖：核心业务功能开发</div></div><div class="info-2"><div class="info-item-1">详解瑞吉外卖后端核心业务实现，包括员工管理、菜品分类、订单流程等功能的接口与逻辑开发。</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="card-info-avatar"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2024_1123_155535.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-status-box"><div class="author-status"><g-emoji class="g-emoji" alias="palm_tree" fallback-src="https://lskypro.acozycotage.net/LightPicture/2022/12/fe1dc0402e623096.jpg">🐟</g-emoji><span>认真摸鱼中</span></div></div></div><div class="author-info-name">Lorinda</div><div class="author-info-description">欢迎来到Lorinda的个人博客\^o^/</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">29</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">112</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://lr0513.github.io/"><i class="fab fa-github"></i><span>你回来了~</span><i class="faa-passing animated" style="padding-left:20px;display:inline-block;vertical-align:middle;"><svg class="icon" style="height:28px;width:28px;fill:currentColor;position:relative;top:5px"><use xlink:href="#icon-hexolabixiaoxin1"></use></svg></i></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content"></div><div id="welcome-info"></div></div><div class="xpand" style="height:200px;"><canvas class="illo" width="800" height="800" style="max-width: 200px; max-height: 200px; touch-action: none; width: 640px; height: 640px;"></canvas></div><script src="https://npm.elemecdn.com/ethan4116-blog/lib/js/other/two-people/twopeople1.js"></script><script src="https://npm.elemecdn.com/ethan4116-blog/lib/js/other/two-people/zdog.dist.js"></script><script id="rendered-js" src="https://npm.elemecdn.com/ethan4116-blog/lib/js/other/two-people/twopeople.js"></script><style>.card-widget.card-announcement {
margin: 0;
align-items: center;
justify-content: center;
text-align: center;
}
canvas {
display: block;
margin: 0 auto;
cursor: move;
}</style><div class="card-widget" id="newYear"><div class="item-headline"><i></i><span></span></div><div class="item-content"><div id="newYear-main"><div class="mask"></div> <p class="title"></p> <div class="newYear-time"></div> <p class="today" style="text-align: right;"></p> </div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">十、购物车</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#10-1-%E6%B7%BB%E5%8A%A0%E8%B4%AD%E7%89%A9%E8%BD%A6"><span class="toc-number">1.1.</span> <span class="toc-text">10.1 添加购物车</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-2-%E6%9F%A5%E7%9C%8B%E8%B4%AD%E7%89%A9%E8%BD%A6"><span class="toc-number">1.2.</span> <span class="toc-text">10.2 查看购物车</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-3-%E6%B8%85%E7%A9%BA%E8%B4%AD%E7%89%A9%E8%BD%A6"><span class="toc-number">1.3.</span> <span class="toc-text">10.3 清空购物车</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-4-%E5%88%A0%E9%99%A4%E8%B4%AD%E7%89%A9%E8%BD%A6%E4%B8%AD%E4%B8%80%E4%B8%AA%E5%95%86%E5%93%81"><span class="toc-number">1.4.</span> <span class="toc-text">10.4 删除购物车中一个商品</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">十一、用户下单</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#11-1-%E5%9C%B0%E5%9D%80%E8%96%84%E5%8A%9F%E8%83%BD"><span class="toc-number">2.1.</span> <span class="toc-text">11.1 地址薄功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-2-%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E5%8A%9F%E8%83%BD"><span class="toc-number">2.2.</span> <span class="toc-text">11.2 用户下单功能</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">十二、订单支付</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#12-1-%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.1.</span> <span class="toc-text">12.1 微信支付介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-2-%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E5%87%86%E5%A4%87%E5%8A%9F%E8%83%BD"><span class="toc-number">3.2.</span> <span class="toc-text">12.2 微信支付准备功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#12-2-1-%E8%8E%B7%E5%BE%97%E5%BE%AE%E4%BF%A1%E7%BB%99%E7%9A%84%E4%B8%A4%E4%B8%AA%E6%96%87%E4%BB%B6"><span class="toc-number">3.2.1.</span> <span class="toc-text">12.2.1 获得微信给的两个文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%95%B0%E6%8D%AE%E5%AE%89%E5%85%A8%EF%BC%9F"><span class="toc-number">3.2.2.</span> <span class="toc-text">如何保证数据安全？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-2-2-%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F"><span class="toc-number">3.2.3.</span> <span class="toc-text">12.2.2 内网穿透</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-3-%E5%AF%BC%E5%85%A5%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E4%BB%A3%E7%A0%81"><span class="toc-number">3.3.</span> <span class="toc-text">12.3 导入微信支付代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%B2%A1%E6%9C%89%E5%95%86%E6%88%B7%E5%8F%B7%E9%97%AE%E9%A2%98"><span class="toc-number">3.3.1.</span> <span class="toc-text">解决没有商户号问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E5%B0%8F%E7%A8%8B%E5%BA%8F%E4%BF%AE%E6%94%B9"><span class="toc-number">3.3.2.</span> <span class="toc-text">前端小程序修改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E4%BF%AE%E6%94%B9"><span class="toc-number">3.3.3.</span> <span class="toc-text">后端修改</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">4.</span> <span class="toc-text">十三、用户端历史订单模块&amp;商家端订单管理模块&amp;地址是否超出配送范围</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#13-1-%E7%94%A8%E6%88%B7%E7%AB%AF%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95%E6%A8%A1%E5%9D%97"><span class="toc-number">4.1.</span> <span class="toc-text">13.1 用户端历史订单模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#13-1-1-%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E5%8E%86%E5%8F%B2%E8%AE%A2%E5%8D%95"><span class="toc-number">4.1.1.</span> <span class="toc-text">13.1.1 分页查询历史订单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-1-2-%E6%9F%A5%E8%AF%A2%E8%AE%A2%E5%8D%95%E8%AF%A6%E6%83%85"><span class="toc-number">4.1.2.</span> <span class="toc-text">13.1.2 查询订单详情</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-1-3-%E5%8F%96%E6%B6%88%E8%AE%A2%E5%8D%95"><span class="toc-number">4.1.3.</span> <span class="toc-text">13.1.3 取消订单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-1-4-%E5%86%8D%E6%9D%A5%E4%B8%80%E5%8D%95"><span class="toc-number">4.1.4.</span> <span class="toc-text">13.1.4 再来一单</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-2-%E5%95%86%E5%AE%B6%E8%AE%A2%E5%8D%95%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97"><span class="toc-number">4.2.</span> <span class="toc-text">13.2 商家订单管理模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#13-2-1-%E8%AE%A2%E5%8D%95%E6%90%9C%E7%B4%A2"><span class="toc-number">4.2.1.</span> <span class="toc-text">13.2.1 订单搜索</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-2-2-%E5%90%84%E4%B8%AA%E7%8A%B6%E6%80%81%E7%9A%84%E8%AE%A2%E5%8D%95%E6%95%B0%E9%87%8F%E7%BB%9F%E8%AE%A1"><span class="toc-number">4.2.2.</span> <span class="toc-text">13.2.2 各个状态的订单数量统计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-2-3-%E6%9F%A5%E8%AF%A2%E8%AE%A2%E5%8D%95%E8%AF%A6%E6%83%85"><span class="toc-number">4.2.3.</span> <span class="toc-text">13.2.3 查询订单详情</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-2-4-%E6%8E%A5%E5%8D%95"><span class="toc-number">4.2.4.</span> <span class="toc-text">13.2.4 接单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-2-5-%E6%8B%92%E5%8D%95"><span class="toc-number">4.2.5.</span> <span class="toc-text">13.2.5 拒单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-2-6-%E5%8F%96%E6%B6%88%E8%AE%A2%E5%8D%95"><span class="toc-number">4.2.6.</span> <span class="toc-text">13.2.6 取消订单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-2-7-%E6%B4%BE%E9%80%81%E8%AE%A2%E5%8D%95"><span class="toc-number">4.2.7.</span> <span class="toc-text">13.2.7 派送订单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-2-8-%E5%AE%8C%E6%88%90%E8%AE%A2%E5%8D%95"><span class="toc-number">4.2.8.</span> <span class="toc-text">13.2.8 完成订单</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-3-%E6%A3%80%E9%AA%8C%E6%94%B6%E8%B4%A7%E5%9C%B0%E5%9D%80%E6%98%AF%E5%90%A6%E8%B6%85%E5%87%BA%E9%85%8D%E9%80%81%E8%8C%83%E5%9B%B4"><span class="toc-number">4.3.</span> <span class="toc-text">13.3 检验收货地址是否超出配送范围</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">5.</span> <span class="toc-text">十四、Spring Task、订单状态定时处理、来单提醒（WebSocket的应用）、客户催单（WebSocket的应用）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#14-1-Spring-Task"><span class="toc-number">5.1.</span> <span class="toc-text">14.1 Spring Task</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#14-1-1-cron%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">5.1.1.</span> <span class="toc-text">14.1.1 cron表达式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-1-2-%E5%85%A5%E9%97%A8%E6%A1%88%E4%BE%8B"><span class="toc-number">5.1.2.</span> <span class="toc-text">14.1.2 入门案例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-2-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86"><span class="toc-number">5.2.</span> <span class="toc-text">14.2 订单状态定时处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-3-WebSocket"><span class="toc-number">5.3.</span> <span class="toc-text">14.3 WebSocket</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#14-3-1-%E5%85%A5%E9%97%A8%E6%A1%88%E4%BE%8B"><span class="toc-number">5.3.1.</span> <span class="toc-text">14.3.1 入门案例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-4-%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%EF%BC%88WebSocket%E7%9A%84%E5%BA%94%E7%94%A8%EF%BC%89"><span class="toc-number">5.4.</span> <span class="toc-text">14.4 来单提醒（WebSocket的应用）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-5-%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95%EF%BC%88WebSocket%E7%9A%84%E5%BA%94%E7%94%A8%EF%BC%89"><span class="toc-number">5.5.</span> <span class="toc-text">14.5 客户催单（WebSocket的应用）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">6.</span> <span class="toc-text">十五、Apache ECharts，营业额统计，用户统计，订单统计，销量排名Top10</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#15-1-Apache-ECharts%EF%BC%88%E5%89%8D%E7%AB%AF%E6%8A%80%E6%9C%AF%EF%BC%89"><span class="toc-number">6.1.</span> <span class="toc-text">15.1 Apache ECharts（前端技术）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#15-1-1-%E5%85%A5%E9%97%A8%E6%A1%88%E4%BE%8B"><span class="toc-number">6.1.1.</span> <span class="toc-text">15.1.1 入门案例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-2-%E8%90%A5%E4%B8%9A%E9%A2%9D%E7%BB%9F%E8%AE%A1"><span class="toc-number">6.2.</span> <span class="toc-text">15.2 营业额统计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-3-%E7%94%A8%E6%88%B7%E7%BB%9F%E8%AE%A1"><span class="toc-number">6.3.</span> <span class="toc-text">15.3 用户统计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-4-%E8%AE%A2%E5%8D%95%E7%BB%9F%E8%AE%A1"><span class="toc-number">6.4.</span> <span class="toc-text">15.4 订单统计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-5-%E9%94%80%E9%87%8F%E6%8E%92%E5%90%8DTop10"><span class="toc-number">6.5.</span> <span class="toc-text">15.5 销量排名Top10</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">7.</span> <span class="toc-text">十六、工作台业务代码，Apache POI，导出运营数据Excel报表</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#16-1-%E5%B7%A5%E4%BD%9C%E5%8F%B0%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81"><span class="toc-number">7.1.</span> <span class="toc-text">16.1 工作台业务代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#16-2-Apache-POI"><span class="toc-number">7.2.</span> <span class="toc-text">16.2 Apache POI</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#16-2-1-%E5%85%A5%E9%97%A8%E6%A1%88%E4%BE%8B"><span class="toc-number">7.3.</span> <span class="toc-text">16.2.1 入门案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#16-3-%E5%AF%BC%E5%87%BA%E8%BF%90%E8%90%A5%E6%95%B0%E6%8D%AEExcel%E6%8A%A5%E8%A1%A8"><span class="toc-number">7.4.</span> <span class="toc-text">16.3 导出运营数据Excel报表</span></a></li></ol></li></ol></div></div><div class="card-widget card-post-series"><div class="item-headline"><i class="fa-solid fa-layer-group"></i><span>系列文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/post/reggie-deployment.html" title="瑞吉外卖：Linux环境与自动化部署"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112758.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="瑞吉外卖：Linux环境与自动化部署"></a><div class="content"><a class="title" href="/post/reggie-deployment.html" title="瑞吉外卖：Linux环境与自动化部署">瑞吉外卖：Linux环境与自动化部署</a><time datetime="2025-09-02T02:04:00.000Z" title="发表于 2025-09-02 10:04:00">2025-09-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/reggie-optimization.html" title="瑞吉外卖：性能优化与架构升级"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112844.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="瑞吉外卖：性能优化与架构升级"></a><div class="content"><a class="title" href="/post/reggie-optimization.html" title="瑞吉外卖：性能优化与架构升级">瑞吉外卖：性能优化与架构升级</a><time datetime="2025-09-02T02:03:00.000Z" title="发表于 2025-09-02 10:03:00">2025-09-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/reggie-mobile.html" title="瑞吉外卖：移动端交互与用户端实现"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2024_1123_155656.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="瑞吉外卖：移动端交互与用户端实现"></a><div class="content"><a class="title" href="/post/reggie-mobile.html" title="瑞吉外卖：移动端交互与用户端实现">瑞吉外卖：移动端交互与用户端实现</a><time datetime="2025-09-02T02:02:00.000Z" title="发表于 2025-09-02 10:02:00">2025-09-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/reggie-business.html" title="瑞吉外卖：核心业务功能开发"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112844.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="瑞吉外卖：核心业务功能开发"></a><div class="content"><a class="title" href="/post/reggie-business.html" title="瑞吉外卖：核心业务功能开发">瑞吉外卖：核心业务功能开发</a><time datetime="2025-09-02T02:01:00.000Z" title="发表于 2025-09-02 10:01:00">2025-09-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/reggie-overview.html" title="瑞吉外卖：项目概述与整体架构"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2024_1123_160146.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="瑞吉外卖：项目概述与整体架构"></a><div class="content"><a class="title" href="/post/reggie-overview.html" title="瑞吉外卖：项目概述与整体架构">瑞吉外卖：项目概述与整体架构</a><time datetime="2025-09-02T02:00:00.000Z" title="发表于 2025-09-02 10:00:00">2025-09-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/ce4585c2.html" title="前端实现：界面与交互逻辑"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112938.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="前端实现：界面与交互逻辑"></a><div class="content"><a class="title" href="/post/ce4585c2.html" title="前端实现：界面与交互逻辑">前端实现：界面与交互逻辑</a><time datetime="2025-08-30T03:03:00.000Z" title="发表于 2025-08-30 11:03:00">2025-08-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/d67b0a8b.html" title="核心功能开发：业务流程实现"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112813.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="核心功能开发：业务流程实现"></a><div class="content"><a class="title" href="/post/d67b0a8b.html" title="核心功能开发：业务流程实现">核心功能开发：业务流程实现</a><time datetime="2025-08-30T03:02:00.000Z" title="发表于 2025-08-30 11:02:00">2025-08-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/b85186f.html" title="基础开发：环境搭建与核心配置"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112626.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="基础开发：环境搭建与核心配置"></a><div class="content"><a class="title" href="/post/b85186f.html" title="基础开发：环境搭建与核心配置">基础开发：环境搭建与核心配置</a><time datetime="2025-08-30T03:01:00.000Z" title="发表于 2025-08-30 11:01:00">2025-08-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/25e0fe54.html" title="项目概述：架构与需求分析"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112618.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="项目概述：架构与需求分析"></a><div class="content"><a class="title" href="/post/25e0fe54.html" title="项目概述：架构与需求分析">项目概述：架构与需求分析</a><time datetime="2025-08-30T03:00:00.000Z" title="发表于 2025-08-30 11:00:00">2025-08-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/g86c4e7a.html" title="第 7 章 计算机系统结构"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112914.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="第 7 章 计算机系统结构"></a><div class="content"><a class="title" href="/post/g86c4e7a.html" title="第 7 章 计算机系统结构">第 7 章 计算机系统结构</a><time datetime="2025-08-28T21:20:00.000Z" title="发表于 2025-08-29 05:20:00">2025-08-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/f75b3d6f.html" title="第 6 章 输入输出系统"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112813.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="第 6 章 输入输出系统"></a><div class="content"><a class="title" href="/post/f75b3d6f.html" title="第 6 章 输入输出系统">第 6 章 输入输出系统</a><time datetime="2025-08-28T21:19:00.000Z" title="发表于 2025-08-29 05:19:00">2025-08-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/169339cb.html" title="第 5 章 输入输出管理：设备协同与优化"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112844.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="第 5 章 输入输出管理：设备协同与优化"></a><div class="content"><a class="title" href="/post/169339cb.html" title="第 5 章 输入输出管理：设备协同与优化">第 5 章 输入输出管理：设备协同与优化</a><time datetime="2025-08-28T21:18:00.000Z" title="发表于 2025-08-29 05:18:00">2025-08-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/d64a2c5e.html" title="第 5 章 中央处理器"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112626.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="第 5 章 中央处理器"></a><div class="content"><a class="title" href="/post/d64a2c5e.html" title="第 5 章 中央处理器">第 5 章 中央处理器</a><time datetime="2025-08-28T21:18:00.000Z" title="发表于 2025-08-29 05:18:00">2025-08-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/790dfc8c.html" title="第 4 章 文件管理：存储与访问机制"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2024_1123_160146.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="第 4 章 文件管理：存储与访问机制"></a><div class="content"><a class="title" href="/post/790dfc8c.html" title="第 4 章 文件管理：存储与访问机制">第 4 章 文件管理：存储与访问机制</a><time datetime="2025-08-28T21:17:00.000Z" title="发表于 2025-08-29 05:17:00">2025-08-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/b93e5f6d.html" title="第 4 章 指令系统"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112914.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="第 4 章 指令系统"></a><div class="content"><a class="title" href="/post/b93e5f6d.html" title="第 4 章 指令系统">第 4 章 指令系统</a><time datetime="2025-08-28T21:17:00.000Z" title="发表于 2025-08-29 05:17:00">2025-08-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/ce20e5e9.html" title="第 3 章 内存管理：地址映射与虚拟内存"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2024_1123_160146.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="第 3 章 内存管理：地址映射与虚拟内存"></a><div class="content"><a class="title" href="/post/ce20e5e9.html" title="第 3 章 内存管理：地址映射与虚拟内存">第 3 章 内存管理：地址映射与虚拟内存</a><time datetime="2025-08-28T21:16:00.000Z" title="发表于 2025-08-29 05:16:00">2025-08-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/a81d4c7b.html" title="第 3 章 存储系统"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2024_1123_160146.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="第 3 章 存储系统"></a><div class="content"><a class="title" href="/post/a81d4c7b.html" title="第 3 章 存储系统">第 3 章 存储系统</a><time datetime="2025-08-28T21:16:00.000Z" title="发表于 2025-08-29 05:16:00">2025-08-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/833e46bb.html" title="第 2 章 进程与线程：并发管理核心"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112650.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="第 2 章 进程与线程：并发管理核心"></a><div class="content"><a class="title" href="/post/833e46bb.html" title="第 2 章 进程与线程：并发管理核心">第 2 章 进程与线程：并发管理核心</a><time datetime="2025-08-28T21:15:00.000Z" title="发表于 2025-08-29 05:15:00">2025-08-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/e72f3b9c.html" title="第 2 章 数据的表示与计算"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112855.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="第 2 章 数据的表示与计算"></a><div class="content"><a class="title" href="/post/e72f3b9c.html" title="第 2 章 数据的表示与计算">第 2 章 数据的表示与计算</a><time datetime="2025-08-28T21:15:00.000Z" title="发表于 2025-08-29 05:15:00">2025-08-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/b328aa63.html" title="第 1 章 操作系统概述：计算机系统基础"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2024_1123_160146.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="第 1 章 操作系统概述：计算机系统基础"></a><div class="content"><a class="title" href="/post/b328aa63.html" title="第 1 章 操作系统概述：计算机系统基础">第 1 章 操作系统概述：计算机系统基础</a><time datetime="2025-08-28T21:14:00.000Z" title="发表于 2025-08-29 05:14:00">2025-08-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/c45d1e8a.html" title="第 1 章 计算机系统概述"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2024_1123_160146.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="第 1 章 计算机系统概述"></a><div class="content"><a class="title" href="/post/c45d1e8a.html" title="第 1 章 计算机系统概述">第 1 章 计算机系统概述</a><time datetime="2025-08-28T21:14:00.000Z" title="发表于 2025-08-29 05:14:00">2025-08-29</time></div></div></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/post/reggie-deployment.html" title="瑞吉外卖：Linux环境与自动化部署"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112758.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="瑞吉外卖：Linux环境与自动化部署"/></a><div class="content"><a class="title" href="/post/reggie-deployment.html" title="瑞吉外卖：Linux环境与自动化部署">瑞吉外卖：Linux环境与自动化部署</a><time datetime="2025-09-02T02:04:00.000Z" title="发表于 2025-09-02 10:04:00">2025-09-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/reggie-optimization.html" title="瑞吉外卖：性能优化与架构升级"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112844.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="瑞吉外卖：性能优化与架构升级"/></a><div class="content"><a class="title" href="/post/reggie-optimization.html" title="瑞吉外卖：性能优化与架构升级">瑞吉外卖：性能优化与架构升级</a><time datetime="2025-09-02T02:03:00.000Z" title="发表于 2025-09-02 10:03:00">2025-09-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/reggie-mobile.html" title="瑞吉外卖：移动端交互与用户端实现"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2024_1123_155656.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="瑞吉外卖：移动端交互与用户端实现"/></a><div class="content"><a class="title" href="/post/reggie-mobile.html" title="瑞吉外卖：移动端交互与用户端实现">瑞吉外卖：移动端交互与用户端实现</a><time datetime="2025-09-02T02:02:00.000Z" title="发表于 2025-09-02 10:02:00">2025-09-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/reggie-business.html" title="瑞吉外卖：核心业务功能开发"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112844.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="瑞吉外卖：核心业务功能开发"/></a><div class="content"><a class="title" href="/post/reggie-business.html" title="瑞吉外卖：核心业务功能开发">瑞吉外卖：核心业务功能开发</a><time datetime="2025-09-02T02:01:00.000Z" title="发表于 2025-09-02 10:01:00">2025-09-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/reggie-overview.html" title="瑞吉外卖：项目概述与整体架构"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2024_1123_160146.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="瑞吉外卖：项目概述与整体架构"/></a><div class="content"><a class="title" href="/post/reggie-overview.html" title="瑞吉外卖：项目概述与整体架构">瑞吉外卖：项目概述与整体架构</a><time datetime="2025-09-02T02:00:00.000Z" title="发表于 2025-09-02 10:00:00">2025-09-02</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2024 - 2025  <i id="heartbeat" class="fa fas fa-heartbeat"></i> By Lorinda</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">I wish you to become your own sun, no need to rely on who's light.<p><a target="_blank" href="https://hexo.io/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为Hexo"></a>&nbsp;<a target="_blank" href="https://butterfly.js.org/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&logo=bitdefender" title="主题采用butterfly"></a>&nbsp;<a target="_blank" href="https://www.jsdelivr.com/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&logo=jsDelivr" title="本站使用JsDelivr为静态资源提供CDN加速"></a> &nbsp;<a target="_blank" href="https://vercel.com/ "><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Hosted-Vervel-brightgreen?style=flat&logo=Vercel" title="本站采用双线部署，默认线路托管于Vercel"></a>&nbsp;<a target="_blank" href="https://vercel.com/ "><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Hosted-Coding-0cedbe?style=flat&logo=Codio" title="本站采用双线部署，联通线路托管于Coding"></a>&nbsp;<a target="_blank" href="https://github.com/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&logo=GitHub" title="本站项目由Gtihub托管"></a>&nbsp;<a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div></div><div class="js-pjax" id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" href="javascript:rmf.scrollToTop();"><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();"><i class="fa fa-copy"></i><span>复制</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();"><i class="fa fa-search"></i><span>百度搜索</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();"><i class="fa fa-link"></i><span>转到链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()"><i class="fa fa-copy"></i><span>粘贴</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-post"><a class="rightMenu-item" href="javascript:rmf.copyWordsLink()"><i class="fa fa-link"></i><span>复制本文地址</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>新窗口打开</span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()"><i class="fa fa-link"></i><span>转到链接</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>复制链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()"><i class="fa fa-download"></i><span>保存图片</span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>在新窗口打开</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>复制图片链接</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:randomPost()"><i class="fa fa-paper-plane"></i><span>随便逛逛</span></a><a class="rightMenu-item" href="javascript:switchNightMode();"><i class="fa fa-moon"></i><span>昼夜切换</span></a><a class="rightMenu-item" href="javascript:rmf.switchReadMode();"><i class="fa fa-book"></i><span>阅读模式</span></a><a class="rightMenu-item" href="/about/"><i class="fa fa-info-circle"></i><span>关于博客</span></a><a class="rightMenu-item" href="javascript:rmf.fullScreen();"><i class="fas fa-expand"></i><span>切换全屏</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick="switchNightMode()" title="日间和夜间模式切换"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="to_comment" type="button" title="前往评论" onclick="FixedCommentBtn();"><i class="fas fa-comments"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i><span id="percent">0<span>%</span></span></button><button id="go-down" type="button" title="直达底部" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.36/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js" type="module"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/19.1.3/lazyload.iife.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/node-snackbar/0.1.16/snackbar.min.js"></script><script>(() => {
  const panguFn = () => {
    if (typeof pangu === 'object') pangu.autoSpacingPage()
    else {
      btf.getScript('https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js')
        .then(() => {
          pangu.autoSpacingPage()
        })
    }
  }

  const panguInit = () => {
    if (false){
      GLOBAL_CONFIG_SITE.isPost && panguFn()
    } else {
      panguFn()
    }
  }

  btf.addGlobalFn('pjaxComplete', panguInit, 'pangu')
  document.addEventListener('DOMContentLoaded', panguInit)
})()</script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.4.0/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.isShuoshuo
  const option = null

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo-api-three-beta.vercel.app/',
      region: 'ap-beijing',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const init = (el = document, path = location.pathname) => {
    twikoo.init({
      el: el.querySelector('#twikoo-wrap'),
      envId: 'https://twikoo-api-three-beta.vercel.app/',
      region: 'ap-beijing',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      },
      ...option,
      path: isShuoshuo ? path : (option && option.path) || path
    })

    

    isShuoshuo && (window.shuoshuoComment.destroyTwikoo = () => {
      if (el.children.length) {
        el.innerHTML = ''
        el.classList.add('no-comment')
      }
    })
  }

  const loadTwikoo = (el, path) => {
    if (typeof twikoo === 'object') setTimeout(() => init(el, path), 0)
    else btf.getScript('https://cdn.staticfile.org/twikoo/1.6.8/twikoo.all.min.js').then(() => init(el, path))
  }

  if (isShuoshuo) {
    'Twikoo' === 'Twikoo'
      ? window.shuoshuoComment = { loadComment: loadTwikoo }
      : window.loadOtherComment = loadTwikoo
    return
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><script async src="//at.alicdn.com/t/c/font_4860073_9duzoqyl2cn.js"></script><script defer data-pjax src="/js/readPercent.js"></script><script src="/js/pagination-jump.js"></script><script async src="/js/fps.js"></script><script async data-pjax src="/js/txmap.js"></script><script defer type="text/javascript" src="https://cdn1.tianli0.top/npm/sweetalert2@8.19.0/dist/sweetalert2.all.js"></script><script async data-pjax src="/js/music.js"></script><script defer src="/js/lunar.js"></script><script async src="https://cdn1.tianli0.top/npm/vue@2.6.14/dist/vue.min.js"></script><script async src="https://cdn1.tianli0.top/npm/element-ui@2.15.6/lib/index.js"></script><script type="text/javascript" src="https://cdn1.tianli0.top/npm/jquery@latest/dist/jquery.min.js"></script><script> let backimg =["url(https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/d42bcc24810cda2c22eaed769b79a93.jpg)","url(https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/2f5e89ae13329dd89bdcdbfc68c5fde.jpg)","url(https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/48b137c38cc79ad960ecf2a9a12fc20.jpg)","url(https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/4474312751631fedb37381e37cdb9c0.jpg)","url(https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/be978bd80f41d2781455513ba1676a2.jpg)","url(https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/a01223e0819746191dd135670a2d7da.jpg)","url(https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/af380cb8a5ed3f047e66dbfe731f488.jpg)"];let index = Math.floor(Math.random() * backimg.length);;document.getElementById("web_bg").style.backgroundImage = backimg[index]</script><script type="text/javascript" src="/js/rightmenu.js"></script><script src="/js/history.js"></script><script src="/js/historyroll.js"></script><script async src="//at.alicdn.com/t/font_2264842_3izu8i5eoc2.js"></script><script defer src="/js/day.js"></script><script async src="/js/title.js"></script><script defer src="/js/random.js"></script><canvas id="universe"></canvas><script defer src="/js/universe.js"></script><script async src="//npm.elemecdn.com/pace-js@1.2.4/pace.min.js"></script><script src="/js/sun_moon.js" async></script><script>
  document.addEventListener('copy', function(e) {
    const selection = window.getSelection().toString()
    if (selection.length > 30) {
      const notice = document.createElement('div')
      notice.className = 'copy-notification'
      notice.textContent = '内容已复制到剪贴板'

      document.body.appendChild(notice)
      setTimeout(() => notice.classList.add('show'), 10)

      setTimeout(() => {
        notice.classList.remove('show')
        setTimeout(() => notice.remove(), 300)
      }, 2000)
    }
  })
</script>
<div class="aplayer no-destroy" data-id="7338633309" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listFolded="false" data-order="random" data-lrctype="1" data-preload="none" data-autoplay="true" muted></div><script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script><script async data-pjax src="https://cdn.wpon.cn/2022-sucai/Gold-ingot.js"></script><script async data-pjax src="/js/newYear.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="30" mobile="false" src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.4/canvas-nest.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.4/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-show-text" src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.4/click-show-text.min.js" data-mobile="false" data-text="Ha,Ha,Ha" data-fontsize="15px" data-random="false" async="async"></script><script>(() => {
  window.$crisp = [];
  window.CRISP_WEBSITE_ID = "cbe39e5f-e68f-4a07-b9cd-3ebbb6aa9ae8";
  (function () {
    d = document;
    s = d.createElement("script");
    s.src = "https://client.crisp.chat/l.js";
    s.async = 1;
    d.getElementsByTagName("head")[0].appendChild(s);
  })();
  $crisp.push(["safe", true])

  const isChatBtn = true
  const isChatHideShow = false

  if (isChatBtn) {
    const open = () => {
      $crisp.push(["do", "chat:show"])
      $crisp.push(["do", "chat:open"])
    }

    const close = () => $crisp.push(["do", "chat:hide"])

    close()

    $crisp.push(["on", "chat:closed", close])

    window.chatBtnFn = () => $crisp.is("chat:visible") ? close() : open()

  } else if (isChatHideShow) {
    window.chatBtn = {
      hide: () => $crisp.push(["do", "chat:hide"]),
      show: () => $crisp.push(["do", "chat:show"])
    }
  }
})()</script><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.js"></script><script src="https://npm.elemecdn.com/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script>(() => {
  const destroyAplayer = () => {
    if (window.aplayers) {
      for (let i = 0; i < window.aplayers.length; i++) {
        if (!window.aplayers[i].options.fixed) {
          window.aplayers[i].destroy()
        }
      }
    }
  }

  const runMetingJS = () => {
    typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()
  }

  btf.addGlobalFn('pjaxSend', destroyAplayer, 'destroyAplayer')
  btf.addGlobalFn('pjaxComplete', loadMeting, 'runMetingJS')
})()</script><script src="https://lib.baomitu.com/pjax/0.2.8/pjax.min.js"></script><script>(() => {
  const pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

  window.pjax = new Pjax({
    elements: 'a:not([target="_blank"]):not([href="/music/"]):not([href="/no-pjax/"])',
    selectors: pjaxSelectors,
    cacheBust: false,
    analytics: false,
    scrollRestoration: false
  })

  const triggerPjaxFn = (val) => {
    if (!val) return
    Object.values(val).forEach(fn => fn())
  }

  document.addEventListener('pjax:send', () => {
    // removeEventListener
    btf.removeGlobalFnEvent('pjaxSendOnce')
    btf.removeGlobalFnEvent('themeChange')

    // reset readmode
    const $bodyClassList = document.body.classList
    if ($bodyClassList.contains('read-mode')) $bodyClassList.remove('read-mode')

    triggerPjaxFn(window.globalFn.pjaxSend)
  })

  document.addEventListener('pjax:complete', () => {
    btf.removeGlobalFnEvent('pjaxCompleteOnce')
    document.querySelectorAll('script[data-pjax]').forEach(item => {
      const newScript = document.createElement('script')
      const content = item.text || item.textContent || item.innerHTML || ""
      Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
      newScript.appendChild(document.createTextNode(content))
      item.parentNode.replaceChild(newScript, item)
    })

    triggerPjaxFn(window.globalFn.pjaxComplete)
  })

  document.addEventListener('pjax:error', e => {
    if (e.request.status === 404) {
      pjax.loadUrl('/404.html')
    }
  })
})()</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><!-- hexo injector body_end start --><script data-pjax>
    function butterfly_categories_card_injector_config(){
      var parent_div_git = document.getElementsByClassName('recent-posts')[0];
      var item_html = '<div class="recent-post-item" style="height:auto;width:100%;padding:0px;"><div id="categoryBar"><ul class="categoryBar-list"><li class="categoryBar-list-item" style="background:url(https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2024_1123_155818.png);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/操作系统/&quot;);" href="javascript:void(0);">操作系统</a><span class="categoryBar-list-count">6</span><span class="categoryBar-list-descr">系统基础</span></li><li class="categoryBar-list-item" style="background:url(https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112813.png);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/技术栈/&quot;);" href="javascript:void(0);">技术栈</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr">技术工具</span></li><li class="categoryBar-list-item" style="background:url(https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112758.png);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/编程语言/&quot;);" href="javascript:void(0);">编程语言</a><span class="categoryBar-list-count">2</span><span class="categoryBar-list-descr">语言入门</span></li><li class="categoryBar-list-item" style="background:url(https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/4e357962b00044466380f6850a120ec.jpg);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/瑞吉外卖项目/&quot;);" href="javascript:void(0);">瑞吉外卖项目</a><span class="categoryBar-list-count">5</span><span class="categoryBar-list-descr">数技核心</span></li><li class="categoryBar-list-item" style="background:url(https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2024_1123_155709.png);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/计算机基础/&quot;);" href="javascript:void(0);">计算机基础</a><span class="categoryBar-list-count">2</span><span class="categoryBar-list-descr">计基要点</span></li><li class="categoryBar-list-item" style="background:url(https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2024_1123_160015.png);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/大数据技术/&quot;);" href="javascript:void(0);">大数据技术</a><span class="categoryBar-list-count">2</span><span class="categoryBar-list-descr">瑞吉实践</span></li><li class="categoryBar-list-item" style="background:url(https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2024_1123_160113.png);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/苍穹外卖项目/&quot;);" href="javascript:void(0);">苍穹外卖项目</a><span class="categoryBar-list-count">4</span><span class="categoryBar-list-descr">苍穹实践</span></li><li class="categoryBar-list-item" style="background:url(https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2024_1123_155951.png);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/计算机基础/专业课/&quot;);" href="javascript:void(0);">专业课</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr">专业课程</span></li><li class="categoryBar-list-item" style="background:url(undefined);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/计算机组成原理/&quot;);" href="javascript:void(0);">计算机组成原理</a><span class="categoryBar-list-count">7</span><span class="categoryBar-list-descr"></span></li></ul></div></div>';
      console.log('已挂载butterfly_categories_card')
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      }
    if( document.getElementsByClassName('recent-posts')[0] && (location.pathname ==='/'|| '/' ==='all')){
    butterfly_categories_card_injector_config()
    }
  </script><script data-pjax>
  function butterfly_clock_anzhiyu_injector_config(){
    var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
    var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>';
    console.log('已挂载butterfly_clock_anzhiyu')
    if(parent_div_git) {
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var qweather_key = '9aac1b5db191491a8993c445d664de8f';
  var gaud_map_key = '3cc01a5a19f500daa0e9e680ef0f6db2';
  var baidu_ak_key = 'undefined';
  var flag = 0;
  var clock_rectangle = '120.780172,40.624088';
  var clock_default_rectangle_enable = 'false';

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_clock_anzhiyu_injector_config();
  }
  else if (epage === cpage){
    butterfly_clock_anzhiyu_injector_config();
  }
  </script><script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script><script data-pjax src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.js"></script><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;post/g86c4e7a.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112914.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-08-29</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;post/g86c4e7a.html&quot;);" href="javascript:void(0);" alt="">第 7 章 计算机系统结构</a><div class="blog-slider__text">阐述计算机系统结构的基本概念，分析并行处理技术的实现方式，详解存储层次的优化策略，介绍系统性能的评价指标与方法。</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;post/g86c4e7a.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;post/f75b3d6f.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112813.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-08-29</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;post/f75b3d6f.html&quot;);" href="javascript:void(0);" alt="">第 6 章 输入输出系统</a><div class="blog-slider__text">介绍I/O设备的分类与特性，详解程序查询、中断与DMA三种控制方式，分析中断系统的处理机制，理解设备与主机的信息交换过程。</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;post/f75b3d6f.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;post/d64a2c5e.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112626.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-08-29</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;post/d64a2c5e.html&quot;);" href="javascript:void(0);" alt="">第 5 章 中央处理器</a><div class="blog-slider__text">详解CPU的功能组成与工作原理，分析时序系统的作用，对比微程序与硬布线控制方式，介绍流水线技术的性能优化机制。</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;post/d64a2c5e.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;post/reggie-deployment.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112758.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-09-02</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;post/reggie-deployment.html&quot;);" href="javascript:void(0);" alt="">瑞吉外卖：Linux环境与自动化部署</a><div class="blog-slider__text">详解瑞吉外卖部署流程，包括Linux环境配置、Git版本管理、自动化脚本与项目发布实践。</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;post/reggie-deployment.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;post/b93e5f6d.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112914.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-08-29</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;post/b93e5f6d.html&quot;);" href="javascript:void(0);" alt="">第 4 章 指令系统</a><div class="blog-slider__text">详解指令的基本格式与寻址方式，对比CISC与RISC体系结构特点，分析指令的执行流程，理解指令系统对硬件的适配关系。</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;post/b93e5f6d.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;post/ce4585c2.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112938.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-08-30</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;post/ce4585c2.html&quot;);" href="javascript:void(0);" alt="">前端实现：界面与交互逻辑</a><div class="blog-slider__text">详解苍穹外卖前端开发实现，包括Vue组件架构设计、核心页面（登录、首页、订单页）开发，接口交互封装与状态管理，确保前端界面与后端服务高效协同。</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;post/ce4585c2.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;post/reggie-optimization.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112844.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-09-02</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;post/reggie-optimization.html&quot;);" href="javascript:void(0);" alt="">瑞吉外卖：性能优化与架构升级</a><div class="blog-slider__text">详解瑞吉外卖优化方案，包括Redis缓存应用、数据库读写分离、系统架构升级等性能提升手段。</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;post/reggie-optimization.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;post/a81d4c7b.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2024_1123_160146.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-08-29</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;post/a81d4c7b.html&quot;);" href="javascript:void(0);" alt="">第 3 章 存储系统</a><div class="blog-slider__text">分析存储系统的层次结构设计，详解主存储器的组成与工作流程，阐述Cache的映射方式与替换策略，介绍存储器性能优化方法。</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;post/a81d4c7b.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;post/d67b0a8b.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112813.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-08-30</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;post/d67b0a8b.html&quot;);" href="javascript:void(0);" alt="">核心功能开发：业务流程实现</a><div class="blog-slider__text">聚焦苍穹外卖核心业务功能开发，详解用户管理、菜品管理、订单全流程及购物车交互逻辑，结合数据统计功能实现业务闭环，覆盖项目核心场景。</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;post/d67b0a8b.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;post/e72f3b9c.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112855.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-08-29</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;post/e72f3b9c.html&quot;);" href="javascript:void(0);" alt="">第 2 章 数据的表示与计算</a><div class="blog-slider__text">详解数制转换规则，阐述定点数与浮点数的表示方法，分析补码运算机制，介绍ALU的功能与实现，掌握数据在计算机中的处理方式。</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;post/e72f3b9c.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;post/b85186f.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112626.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-08-30</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;post/b85186f.html&quot;);" href="javascript:void(0);" alt="">基础开发：环境搭建与核心配置</a><div class="blog-slider__text">详解苍穹外卖项目基础开发流程，包括本地开发环境搭建、数据库表结构设计与初始化，核心配置（跨域、日志等）及基础工具类实现，构建项目开发基石。</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;post/b85186f.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;post/reggie-business.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112844.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-09-02</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;post/reggie-business.html&quot;);" href="javascript:void(0);" alt="">瑞吉外卖：核心业务功能开发</a><div class="blog-slider__text">详解瑞吉外卖后端核心业务实现，包括员工管理、菜品分类、订单流程等功能的接口与逻辑开发。</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;post/reggie-business.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;post/reggie-mobile.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2024_1123_155656.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-09-02</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;post/reggie-mobile.html&quot;);" href="javascript:void(0);" alt="">瑞吉外卖：移动端交互与用户端实现</a><div class="blog-slider__text">详解瑞吉外卖移动端用户端开发，包括手机验证码登录、地址簿管理、菜品 / 套餐展示、购物车增删改查、用户订单创建与再来一单功能，及前后端接口交互逻辑。</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;post/reggie-mobile.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;post/bae4ff13.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112813.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-03-12</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;post/bae4ff13.html&quot;);" href="javascript:void(0);" alt="">Redis</a><div class="blog-slider__text">Redis 作为内存 NoSQL 数据库的定位，支持 String/Hash 等多数据结构，具备 RDB/AOF 持久化与主从高可用，核心用于缓存、分布式锁，性能高效。</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;post/bae4ff13.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;post/c45d1e8a.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2024_1123_160146.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-08-29</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;post/c45d1e8a.html&quot;);" href="javascript:void(0);" alt="">第 1 章 计算机系统概述</a><div class="blog-slider__text">介绍计算机系统的硬件与软件组成，详解五大功能部件及总线工作机制，阐述指令集体系结构的核心作用，建立计算机系统的整体认知。</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;post/c45d1e8a.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;post/25e0fe54.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112618.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-08-30</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;post/25e0fe54.html&quot;);" href="javascript:void(0);" alt="">项目概述：架构与需求分析</a><div class="blog-slider__text">全面解析苍穹外卖项目的整体规划，包括项目背景、核心需求、技术栈选型依据，详解系统架构设计与开发规范，为项目开发提供整体指导。</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;post/25e0fe54.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;post/77666db.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112758.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-04-07</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;post/77666db.html&quot;);" href="javascript:void(0);" alt="">王道计组pdf</a><div class="blog-slider__text">计算机组成原理</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;post/77666db.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;post/833e46bb.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112650.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-08-29</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;post/833e46bb.html&quot;);" href="javascript:void(0);" alt="">第 2 章 进程与线程：并发管理核心</a><div class="blog-slider__text">讲解进程与线程的定义、状态转换及控制逻辑，分析进程调度策略，阐述进程同步互斥（PV 操作）与死锁的处理机制，是操作系统并发管理的核心。</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;post/833e46bb.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;post/169339cb.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112844.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-08-29</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;post/169339cb.html&quot;);" href="javascript:void(0);" alt="">第 5 章 输入输出管理：设备协同与优化</a><div class="blog-slider__text">详解I/O设备分类与控制方式（程序直接控制/DMA/通道），分析磁盘结构与调度策略，介绍SPOOLing等I/O优化技术，保障设备与CPU、内存的高效协同。</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;post/169339cb.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;post/790dfc8c.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2024_1123_160146.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-08-29</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;post/790dfc8c.html&quot;);" href="javascript:void(0);" alt="">第 4 章 文件管理：存储与访问机制</a><div class="blog-slider__text">介绍文件的逻辑与物理结构，讲解目录管理（按名存取）、索引节点功能及外存空闲空间分配策略，实现文件的安全存储与高效共享。</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;post/790dfc8c.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;post/ce20e5e9.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2024_1123_160146.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-08-29</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;post/ce20e5e9.html&quot;);" href="javascript:void(0);" alt="">第 3 章 内存管理：地址映射与虚拟内存</a><div class="blog-slider__text">覆盖内存分配方式（连续/分页/分段）与地址转换机制，详解虚拟内存技术、请求分页流程及页面置换策略，解决多道程序下内存利用率与地址映射问题。</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;post/ce20e5e9.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;post/b328aa63.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2024_1123_160146.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-08-29</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;post/b328aa63.html&quot;);" href="javascript:void(0);" alt="">第 1 章 操作系统概述：计算机系统基础</a><div class="blog-slider__text">阐述操作系统的定义与核心功能，详解四大特征（并发 / 共享 / 虚拟 / 异步）、处理器运行模式及系统结构分类，介绍 OS 引导流程，奠定操作系统认知基础。</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;post/b328aa63.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;post/79666db.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112938.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-03-12</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;post/79666db.html&quot;);" href="javascript:void(0);" alt="">数据结构</a><div class="blog-slider__text">数据结构的核心是高效组织数据，区分逻辑结构（线性 / 非线性）与物理结构（顺序 / 链式），覆盖数组、树、图等核心类型，为优化算法效率、支撑工程应用奠定基础。</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;post/79666db.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;post/reggie-overview.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2024_1123_160146.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-09-02</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;post/reggie-overview.html&quot;);" href="javascript:void(0);" alt="">瑞吉外卖：项目概述与整体架构</a><div class="blog-slider__text">全面解析瑞吉外卖项目背景、技术选型、整体架构设计及核心业务流程，建立项目全局认知。</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;post/reggie-overview.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;post/b8b0eacd.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://obsidian-1322827540.cos.ap-guangzhou.myqcloud.com/img/Screenshot_2025_0314_112938.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-03-12</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;post/b8b0eacd.html&quot;);" href="javascript:void(0);" alt="">java基础</a><div class="blog-slider__text">Java基础</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;post/b8b0eacd.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('已挂载butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '1s');
    arr[i].setAttribute('data-wow-offset', '100');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body></html>